<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SleekrStream</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- HLS.js for m3u8 support -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js" defer></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest" defer></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
<!-- Favicon -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4029/4029010.png">

<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    brand: {
                        300: '#a5b4fc', // Indigo 300
                        400: '#818cf8', // Indigo 400
                        500: '#6366f1', // Indigo 500
                        600: '#4f46e5', // Indigo 600
                    },
                    dark: {
                        bg: '#020617',      // Slate 950
                        surface: '#0f172a', // Slate 900
                        border: '#1e293b',  // Slate 800
                        light: '#334155',   // Slate 700
                    }
                },
                animation: {
                    'slide-in': 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    'fade-in': 'fadeIn 0.3s ease-out forwards',
                    'pulse-slow': 'pulseSlow 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    'heart-beat': 'heartBeat 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    'pop-up': 'popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                },
                keyframes: {
                    slideIn: {
                        '0%': { transform: 'translateY(15px)', opacity: '0' },
                        '100%': { transform: 'translateY(0)', opacity: '1' },
                    },
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'scale(0.98)' },
                        '100%': { opacity: '1', transform: 'scale(1)' },
                    },
                    popUp: {
                        '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' },
                        '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                    },
                    pulseSlow: {
                        '50%': { opacity: '.6' },
                    },
                    heartBeat: {
                        '0%': { transform: 'scale(1)' },
                        '50%': { transform: 'scale(1.3)' },
                        '100%': { transform: 'scale(1)' },
                    }
                }
            }
        }
    }
</script>

<style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    ::-webkit-scrollbar-track {
        background: transparent; 
    }
    ::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #475569; 
    }

    /* Hidden Scrollbar Utility */
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

/* Sleek Image Preview */
    .image-preview-container {
        background-color: #020617; /* Slate 950 / dark-bg */
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    .image-preview-container .preview-placeholder i {
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .image-preview-container:hover .preview-placeholder i {
        transform: scale(1.1);
    }

    /* Loader */
    .loader {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        position: relative;
        animation: spin 1.2s linear infinite;
        border: 4px solid transparent;
        border-top-color: #6366f1; 
        border-left-color: #818cf8; 
    }
    .loader::after {
        content: '';
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        border: 4px solid transparent;
        border-bottom-color: #a5b4fc; 
        animation: spin 0.7s linear infinite reverse;
    }
    .mini-loader {
        width: 24px;
        height: 24px;
        border: 2px solid transparent;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
     .tiny-loader {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Volume Slider */
    input[type=range] {
        -webkit-appearance: none; 
        background: transparent;
        height: 24px;
        display: flex;
        align-items: center;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 14px;
        width: 14px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        margin-top: -5px; 
        position: relative;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    input[type=range]:active::-webkit-slider-thumb {
        transform: scale(1.2);
    }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: rgba(255,255,255,0.15);
        border-radius: 2px;
    }
    
    /* Channel Item Styling */
    .channel-item {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .channel-item:hover {
        transform: translateX(4px);
    }
    .channel-item.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.05));
        border: 1px solid rgba(99, 102, 241, 0.3);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transform: translateX(4px);
    }
    /* Indicator for active channel */
    .channel-item.active .active-indicator {
        opacity: 1;
        transform: scale(1);
    }

    /* Glassmorphism & GPU Stabilization */
    .glass {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.07);
        /* Hardware acceleration to prevent mobile jitter */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }

    /* Custom Dropdown Styling */
    .custom-select-options {
        display: none;
    }
    .custom-select.open .custom-select-options {
        display: block;
    }

    /* Fullscreen Helper */
    #videoContainer:fullscreen {
        background: black;
    }
    #videoContainer:fullscreen #fullscreenInfo {
        display: flex;
        animation: fadeIn 0.5s ease-out;
    }
    #videoContainer:fullscreen + .info-bar {
        display: none;
    }

    /* Prev/Next Button Fullscreen Visibility */
    #prevChannelBtn, #nextChannelBtn {
        /* This keeps the buttons present but fully invisible and non-interactive by default, allowing transitions to work smoothly */
        opacity: 0;
        pointer-events: none;
    }
    #videoContainer:fullscreen #prevChannelBtn,
    #videoContainer:fullscreen #nextChannelBtn {
        /* In fullscreen, they become visible and interactive, ready for the UI fade-in/out */
        opacity: 1;
        pointer-events: auto;
    }
    
    /* Smooth width/height transition for sidebar */
    .sidebar-transition {
        transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), 
                    height 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                    opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                    transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    body {
        background-image: radial-gradient(circle at top left, rgba(79, 70, 229, 0.15), transparent 30%),
                          radial-gradient(circle at bottom right, rgba(192, 132, 252, 0.1), transparent 40%);
    }

    /* UI Auto-hide */
    .ui-element {
        transition: opacity 0.3s ease-in-out;
        will-change: opacity; /* Hints browser to optimize for opacity changes */
    }
    .ui-hidden {
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Prevent drag on images */
    img {
        -webkit-user-drag: none;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

    /* Blurred Background Styling */
    #videoContainer.has-blurred-bg #backgroundCanvas {
        opacity: 1;
        filter: blur(40px) brightness(0.4);
        transform: scale(1.1); /* To avoid harsh edges from the video appearing */
    }

    /* Popup Menu for Mobile */
    .mobile-menu-enter {
        animation: popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    /* Custom Checkbox */
    .custom-checkbox input {
        display: none;
    }
    .custom-checkbox .checkbox-visual {
        width: 44px;
        height: 24px;
        background-color: #334155;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border: 1px solid #475569;
    }
    .custom-checkbox .checkbox-visual::before {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background-color: #f1f5f9;
        border-radius: 50%;
        top: 2px;
        left: 3px;
        transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .custom-checkbox input:checked + .checkbox-visual {
        background-color: #4f46e5;
        border-color: #6366f1;
    }
    .custom-checkbox input:checked + .checkbox-visual::before {
        transform: translateX(20px);
    }
    .progress-bar-inner {
        background: linear-gradient(90deg, #4f46e5, #818cf8);
        transition: width 0.3s ease;
    }

    /* Fullscreen Channel Menu */
    #fullscreenChannelMenu {
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #fullscreenChannelMenu.open {
        transform: translateX(0);
    }

    /* Browse Playlist Modal Tab Styling */
    .browse-tab.active {
        border-color: #6366f1;
        color: #fff;
        background-color: rgba(99, 102, 241, 0.1);
    }

</style>
</head>
<body class="bg-dark-bg text-gray-300 h-screen w-screen overflow-hidden flex flex-row antialiased selection:bg-brand-500 selection:text-white">

<!-- SIDEBAR -->
<aside class="bg-dark-surface/95 backdrop-blur-xl border-r border-dark-border flex flex-col h-full fixed md:relative inset-0 w-full max-w-xs md:w-[340px] md:max-w-none sidebar-transition z-50 -translate-x-full md:translate-x-0" id="sidebar">
    
    <!-- Header -->
    <div class="p-5 border-b border-dark-border flex justify-between items-center bg-dark-surface/50 shrink-0">
        <div class="flex items-center gap-3 overflow-hidden whitespace-nowrap">
            <div class="bg-gradient-to-br from-brand-600 to-brand-400 text-white p-2.5 rounded-xl">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight text-white sidebar-text">SleekrStream</h1>
        </div>
        <div class="flex items-center gap-1 sidebar-text">
            <button onclick="toggleModal('addChannelModal')" class="hidden md:block p-2 hover:bg-white/5 rounded-xl transition-all active:scale-95 text-gray-400 hover:text-white group relative" title="Add Stream">
				<i data-lucide="plus" class="w-5 h-5"></i>
			</button>
			<button onclick="toggleModal('settingsModal')" class="hidden md:block p-2 hover:bg-white/5 rounded-xl transition-all active:scale-95 text-gray-400 hover:text-white group relative" title="Settings">
				<i data-lucide="settings" class="w-5 h-5"></i>
			</button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl md:hidden active:scale-95 transition-all">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl hidden md:block active:scale-95 transition-all">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="p-4 border-b border-dark-border space-y-3 shrink-0 sidebar-content bg-dark-surface/30">
        <div class="relative group focus-within:ring-2 focus-within:ring-brand-500/50 rounded-xl transition-all">
            <i data-lucide="search" class="absolute left-3.5 top-3 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
            <input type="text" id="searchInput" placeholder="Find channels..." 
                class="w-full bg-dark-bg border border-dark-border rounded-xl pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:border-brand-500 transition-all placeholder-gray-500 text-gray-200 shadow-sm">
        </div>
        
        <div class="flex gap-2">
            <!-- Added min-w-0 here -->
            <div class="relative custom-select flex-1 min-w-0" id="groupFilterDropdown">
                <button onclick="toggleDropdown()" class="w-full bg-dark-bg border border-dark-border rounded-xl px-3 py-2 text-sm flex justify-between items-center hover:border-dark-light hover:bg-white/5 transition-all text-gray-300 active:scale-[0.98]">
                    <span id="selectedGroupLabel" class="truncate">All Groups</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                </button>
                <div class="custom-select-options absolute top-full left-0 right-0 mt-2 bg-dark-surface border border-dark-border rounded-xl shadow-2xl z-50 max-h-56 overflow-y-auto no-scrollbar animate-slide-in p-1.5" id="groupOptionsList"></div>
            </div>
             <button onclick="toggleSort()" id="sortBtn" title="Sort Channels" class="px-3 py-2 text-sm font-medium border border-dark-border rounded-xl hover:bg-white/5 text-gray-400 transition-all flex items-center justify-center gap-2 active:scale-95">
                <i data-lucide="arrow-down-a-z" class="w-4 h-4"></i>
             </button>
             <button onclick="filterFavorites()" id="favFilterBtn" title="Filter Favorites" class="px-3 py-2 text-sm font-medium border border-dark-border rounded-xl hover:bg-white/5 text-gray-400 transition-all flex items-center justify-center gap-2 active:scale-95">
                <i data-lucide="heart" class="w-4 h-4"></i>
             </button>
        </div>
    </div>

    <!-- Channel List -->
    <div class="flex-1 overflow-y-auto p-3 space-y-2 sidebar-content scroll-smooth bg-dark-bg/30" id="channelList">
        <!-- Channels injected here -->
    </div>

    <!-- Sidebar Footer -->
    <div class="p-4 border-t border-dark-border text-xs text-gray-500 shrink-0 sidebar-content bg-dark-surface/50">
        <div id="importStatusFooter" class="hidden items-center justify-between cursor-pointer hover:bg-white/5 -m-4 p-4" onclick="toggleModal('importProgressModal')">
             <div class="flex items-center gap-3">
                <div class="mini-loader"></div>
                <div>
                    <span class="font-bold text-gray-300 text-sm">Importing...</span>
                    <p class="text-xs text-gray-500" id="importFooterProgressText">0%</p>
                </div>
            </div>
            <i data-lucide="arrow-up-right" class="w-4 h-4 text-gray-600"></i>
        </div>
        <div id="defaultFooter" class="flex justify-between items-center">
            <button onclick="importExampleChannels()" class="hover:text-brand-400 transition-colors flex items-center gap-1.5 hover: decoration-brand-400/50">
                <i data-lucide="download-cloud" class="w-3 h-3"></i> Load Demo
            </button>
            <span id="channelCount" class="font-mono text-gray-600">0 loaded</span>
        </div>
    </div>
</aside>

<!-- Sidebar Expand Strip (Desktop) -->
<div id="sidebarToggleStrip" class="hidden flex-col items-center justify-start py-6 w-14 border-r border-dark-border bg-dark-surface/80 z-20 gap-4 transition-all">
    <button onclick="toggleSidebar()" class="p-3 hover:bg-brand-500/10 hover:text-brand-400 rounded-xl transition-all active:scale-95" title="Expand Sidebar">
        <i data-lucide="chevron-right" class="w-5 h-5"></i>
    </button>
</div>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col relative bg-black h-screen overflow-hidden w-full">
    
    <!-- MOBILE-ONLY TOP BAR -->
    <div class="md:hidden flex justify-between items-center p-3 border-b border-dark-border bg-dark-surface/80 glass shrink-0 z-20">
        <div class="flex items-center gap-3">
             <div class="bg-gradient-to-br from-brand-600 to-brand-400 text-white p-2 rounded-lg shadow-lg shadow-brand-500/20">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white">SleekrStream</h1>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleModal('addChannelModal')" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl active:scale-95 transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
             <button onclick="toggleModal('settingsModal')" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl active:scale-95 transition-all">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl active:scale-95 transition-all">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Video Container -->
    <div class="relative flex-1 bg-black flex items-center justify-center group overflow-hidden" id="videoContainer">
        
        <!-- Background Canvas -->
        <canvas id="backgroundCanvas" class="absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-500 opacity-0"></canvas>
        
        <!-- Video Element -->
        <video id="videoPlayer" class="relative z-10 w-full h-full object-contain transition-all duration-300" playsinline crossorigin="anonymous"></video>

        <!-- PREV/NEXT BUTTONS -->
        <button id="prevChannelBtn" class="absolute top-1/2 -translate-y-1/2 left-4 sm:left-6 w-11 h-11 sm:w-12 sm:h-12 glass rounded-full flex items-center justify-center z-20 ui-element ui-hidden hover:bg-white/20 active:scale-90 transition-all">
            <i data-lucide="chevron-left" class="w-6 h-6"></i>
        </button>
        <button id="nextChannelBtn" class="absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 w-11 h-11 sm:w-12 sm:h-12 glass rounded-full flex items-center justify-center z-20 ui-element ui-hidden hover:bg-white/20 active:scale-90 transition-all">
            <i data-lucide="chevron-right" class="w-6 h-6"></i>
        </button>

        <!-- Fullscreen Info -->
        <div id="fullscreenInfo" class="absolute top-6 left-6 z-30 p-3 hidden items-center gap-2 glass rounded-[24px] ui-element">
            <div id="fullscreenChannelLogo" class="w-12 h-12 bg-dark-border rounded-lg flex items-center justify-center border border-white/10 overflow-hidden shrink-0">
                <i data-lucide="tv" class="w-6 h-6 opacity-80"></i>
            </div>
            <div class="pr-2">
                <h2 id="fullscreenChannelName" class="text-lg font-bold text-white">Select Channel</h2>
            </div>
            <button onclick="toggleFullscreenMenu()" class="p-3 rounded-lg hover:bg-white/10 transition-colors">
                <i data-lucide="list" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Fullscreen Channel Menu -->
        <div id="fullscreenChannelMenu" class="absolute top-0 left-0 max-h-[55vh] w-full max-w-xs sm:max-w-sm glass z-40 flex flex-col rounded-br-3xl">
            <div class="p-4 flex justify-between items-center border-b border-white/10 shrink-0">
                <h3 class="font-bold text-white text-lg">All Channels</h3>
                <button onclick="toggleFullscreenMenu()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="fullscreenChannelList" class="flex-1 overflow-y-auto p-2 space-y-1 no-scrollbar">
                <!-- Fullscreen channel list is populated here -->
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="absolute inset-0 bg-dark-surface/80 flex flex-col items-center justify-center z-10 hidden backdrop-blur-md animate-fade-in pointer-events-none text-center">
            <div class="loader mb-6"></div>
            <h3 class="text-lg font-medium text-white mb-2 tracking-wide" id="loadingTitle">Connecting to Stream</h3>
            <p id="loadingStatus" class="text-sm text-brand-400 opacity-80 animate-pulse-slow">Please wait a moment...</p>
        </div>

        <!-- Error Overlay -->
        <div id="errorOverlay" class="absolute inset-0 bg-dark-surface/95 flex flex-col items-center justify-center z-10 hidden p-8 text-center animate-fade-in">
            <div class="bg-red-500/10 p-5 rounded-full mb-6 ring-1 ring-red-500/20">
                <i data-lucide="wifi-off" class="w-10 h-10 text-red-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-3">Connection Failed</h3>
            <p id="errorMessage" class="text-gray-400 mb-8 max-w-md leading-relaxed text-sm">Could not connect to the stream. The link may be invalid, the stream might be offline, or unavailable in your region.</p>
            <div class="flex gap-4">
                <button onclick="stopPlayer()" class="px-6 py-2.5 bg-dark-surface border border-dark-border rounded-xl text-white hover:bg-dark-light transition text-sm font-medium active:scale-95">
                    Close
                </button>
                <button onclick="retryStream()" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition text-sm font-bold flex items-center gap-2 shadow-lg shadow-brand-500/20 active:scale-95">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Retry
                </button>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center z-0 p-4">
             <div class="absolute inset-0 bg-gradient-to-br from-dark-bg to-[#050505]"></div>
            <div class="relative mb-10 group cursor-pointer" onclick="toggleModal('addChannelModal')">
                <div class="absolute -inset-2 bg-brand-500 blur-3xl opacity-20 group-hover:opacity-30 transition-opacity duration-700 rounded-full animate-pulse-slow"></div>
                <div class="relative w-28 h-28 bg-dark-surface rounded-[2rem] flex items-center justify-center shadow-2xl border border-white/5 group-hover:scale-105 group-active:scale-95 transition-transform duration-500 ease-out">
                    <i data-lucide="zap" class="w-12 h-12 text-brand-400"></i>
                </div>
            </div>
            <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4 tracking-tight text-center">SleekrStream</h2>
            <p class="text-gray-400 max-w-sm text-center leading-relaxed">A modern IPTV experience.<br>Select a channel from the list or add a new stream to begin.</p>
            
            <div class="mt-8 gap-4 text-xs text-gray-500 font-mono hidden sm:flex">
                <span class="flex items-center gap-1.5"><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">SPACE</kbd> Play/Pause</span>
                <span class="flex items-center gap-1.5"><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">F</kbd> Fullscreen</span>
                 <span class="flex items-center gap-1.5"><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">←</kbd><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">→</kbd> Change Channel</span>
            </div>
        </div>

        <!-- NEW LOCATION: Mobile Menu -->
		<div id="mobileMenuOptions" class="absolute bottom-20 sm:bottom-28 right-2 sm:right-6 w-52 flex-col hidden origin-bottom-right bg-[#0f172a]/75 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl mobile-menu-enter z-50 transform-gpu overflow-y-auto no-scrollbar max-h-[calc(100vh-11rem)] sm:max-h-[calc(100vh-13rem)]">
			<!-- Removed p-2 from parent. The items will fill the width. -->
			<div class="p-2 flex flex-col gap-1 w-full">
				 <!-- Mobile menu options are dynamically populated -->
			</div>
		</div>

        <!-- CONTROLS OVERLAY -->
        <div id="controlsOverlay" class="controls-wrapper absolute bottom-2 sm:bottom-6 left-2 sm:left-6 right-2 sm:right-6 p-3 sm:p-4 z-20 glass rounded-[24px] ui-element ui-hidden transform-gpu">
            
            <div class="flex justify-between items-center select-none w-full">
                <!-- Left Controls (Common) -->
                <div class="flex items-center gap-3 sm:gap-5 flex-1">
                    <button onclick="togglePlay()" class="text-white hover:text-brand-400 transition transform active:scale-90 outline-none group/play p-1">
                        <i data-lucide="play" id="playIcon" class="w-7 h-7 sm:w-8 sm:h-8 fill-white group-hover/play:fill-brand-400 transition-colors"></i>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="toggleMute()" class="text-gray-300 hover:text-white transition active:scale-90 p-1">
                            <i data-lucide="volume-2" id="volIcon" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        </button>
                        <div class="flex items-center h-8 gap-2 w-16 sm:w-24">
                            <input type="range" min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)" class="w-full">
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pl-2 sm:pl-4 border-l border-white/10">
                        <span id="liveBadge" class="hidden items-center gap-1.5 px-2.5 py-1 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase tracking-widest select-none">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                            LIVE
                        </span>
                    </div>
                </div>

                <!-- Right Controls -->
                <div class="flex items-center gap-1 sm:gap-1">
                    
                    <!-- Desktop-Only Tools Row -->
                    <div class="hidden lg:flex items-center gap-1" id="desktopControls">
                        <!-- Desktop controls are dynamically populated -->
                    </div>

                    <!-- Mobile-Only 3-Dot Menu -->
                    <div class="lg:hidden relative">
                        <button onclick="toggleMobileMenu()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95" id="mobileMoreBtn">
                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Fullscreen (Shared) -->
                    <div class="relative group/tooltip ml-1">
                        <button onclick="toggleFullscreen()" class="text-white hover:bg-white/20 p-2.5 rounded-lg transition active:scale-95">
                            <i data-lucide="maximize" id="fsIcon" class="w-5 h-5"></i>
                        </button>
                        <span class="pointer-events-none hidden sm:block absolute bottom-full mb-2 right-0 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Fullscreen</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overlay -->
        <div id="statsOverlay" class="absolute top-4 right-4 left-4 sm:left-auto glass p-5 rounded-2xl text-xs font-mono text-gray-400 hidden z-30 w-auto max-w-[calc(100vw-2rem)] sm:w-80 shadow-2xl animate-fade-in no-scrollbar max-h-[calc(100%-8rem)] sm:max-h-[calc(100%-10rem)] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
                <span class="font-bold text-white flex items-center gap-2"><i data-lucide="activity" class="w-3 h-3 text-brand-400"></i> Nerd Stats</span>
                <button onclick="toggleStats()" class="hover:text-white hover:bg-white/10 p-1.5 rounded-lg transition"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between"><span>Dimensions</span> <span id="statRes" class="text-white font-bold">-</span></div>
                <div class="flex justify-between"><span>Current Bitrate</span> <span id="statBitrate" class="text-brand-400">-</span></div>
                <div class="flex justify-between"><span>Buffer Length</span> <span id="statBuffer" class="text-white">-</span></div>
                <div class="flex justify-between"><span>Dropped Frames</span> <span id="statDropped" class="text-red-400">0</span></div>
                <div class="flex justify-between"><span>Est. Bandwidth</span> <span id="statBw" class="text-brand-400">-</span></div>
                <div class="flex justify-between"><span>Engine</span> <span id="statEngine" class="text-gray-500">HLS.js</span></div>
                
                <div class="mt-4 pt-3 border-t border-white/10">
                    <span class="block text-gray-500 text-[10px] mb-2 uppercase tracking-wider">Stream Source</span>
                    <div class="bg-black/40 p-3 rounded-lg border border-white/5 break-all text-[10px] text-gray-300 select-all font-mono leading-relaxed" id="statUrl"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Bar -->
    <!-- Updated: Added w-full max-w-full overflow-hidden to constrain width on mobile -->
    <div class="bg-dark-surface/80 glass p-4 border-t border-dark-border flex justify-between items-center shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] info-bar w-full max-w-full overflow-hidden">
        <div class="flex items-center gap-3 sm:gap-4 min-w-0 flex-1">
            <div id="currentChannelLogo" class="w-12 h-12 bg-gradient-to-br from-dark-light to-dark-border rounded-xl flex items-center justify-center text-gray-500 border border-white/5 overflow-hidden shrink-0 shadow-lg">
                <i data-lucide="tv" class="w-5 h-5 opacity-80"></i>
            </div>
            <div class="min-w-0 flex-1">
                <div class="flex items-center gap-3">
                    <h2 id="currentChannelName" class="text-lg font-bold text-white leading-tight truncate block">Select Channel</h2>
                    <button id="currentFavBtn" onclick="toggleCurrentFavorite()" class="text-gray-600 hover:text-brand-400 transition hidden active:scale-90 shrink-0">
                        <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-400 mt-1 truncate">
                    <span id="currentChannelGroup" class="text-brand-300 font-medium text-xs px-2 py-0.5 bg-brand-500/10 rounded-md border border-brand-500/20 truncate max-w-[120px]">--</span>
                    <span id="networkHealth" class="flex items-center gap-1.5 text-xs ml-1 shrink-0">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-600" id="healthDot"></span>
                        <span id="healthText" class="opacity-70">Idle</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex gap-2 shrink-0 ml-2">
            <button onclick="shareCurrentChannel()" id="shareBtn" class="p-2.5 bg-dark-bg border border-dark-border hover:bg-dark-light hover:border-dark-light rounded-xl text-gray-400 hover:text-white transition disabled:opacity-30 disabled:cursor-not-allowed active:scale-95" disabled title="Share Channel">
                <i data-lucide="share-2" class="w-4 h-4"></i>
            </button>
            <button onclick="editCurrentChannel()" id="editBtn" class="p-2.5 bg-dark-bg border border-dark-border hover:bg-dark-light hover:border-dark-light rounded-xl text-gray-400 hover:text-white transition disabled:opacity-30 disabled:cursor-not-allowed active:scale-95" disabled title="Edit Channel">
                <i data-lucide="settings-2" class="w-4 h-4"></i>
            </button>
        </div>
    </div>
</main>

<!-- BACKDROP for mobile sidebar -->
<div id="sidebarBackdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden transition-opacity duration-300"></div>


<!-- MODAL: Add/Edit Channel -->
<div id="addChannelModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl transform transition-all scale-100 animate-slide-in relative overflow-hidden flex flex-col max-h-[90vh]">
        
        <!-- Decorative Glow -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

        <!-- Header Section -->
        <div class="px-6 pt-5 pb-0 shrink-0 relative z-10">
            <div class="flex justify-between items-center">
                 <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span id="modalTitle">Add Content</span>
                </h3>
                <button onclick="toggleModal('addChannelModal')" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- Tabs -->
            <!-- FIX 1: Reduced margin to 'mt-1'. This pulls the tabs up tight to the title, 
                 reducing overall space in "Add Mode". -->
            <div id="addChannelTabs" class="mt-1 border-b border-dark-border flex mb-0">
                <button id="tabSingle" onclick="switchAddTab('single')" class="flex-1 text-center py-2 text-sm font-medium border-b-2 transition-colors border-brand-500 text-white">Single Stream</button>
                <button id="tabPlaylist" onclick="switchAddTab('playlist')" class="flex-1 text-center py-2 text-sm font-medium border-b-2 transition-colors border-transparent text-gray-400 hover:text-white">Import from URL</button>
            </div>
        </div>

        <!-- Scrollable Content Section -->
        <!-- FIX 2: Increased padding to 'pt-7'. 
             In Edit Mode (tabs hidden), this adds the requested space below the title.
             In Add Mode (tabs visible), this is counter-acted by the reduced tab margin above. -->
        <div class="overflow-y-auto no-scrollbar relative flex-1 px-6 pb-6 pt-7">
            
            <!-- Single Stream Form -->
            <div id="formSingle">
                <form id="channelForm" onsubmit="handleChannelSubmit(event)" class="flex flex-col gap-5 relative">
                    
                    <input type="hidden" id="channelId">
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Name</label>
                        <input type="text" id="inpName" required class="w-full bg-dark-bg border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500" placeholder="e.g., My Favorite Channel">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Stream URL</label>
                            <a href="https://iptv-org.github.io" target="_blank" rel="noopener noreferrer" class="text-xs text-brand-400 hover:text-brand-300 transition-colors mb-2 flex items-center gap-1">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                Find public streams
                            </a>
                        </div>
                        <div class="relative group">
                            <input type="text" id="inpUrl" required class="w-full bg-dark-bg border border-dark-border rounded-xl pl-11 pr-10 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors font-mono text-sm placeholder-gray-500" placeholder="https://...">
                             <i data-lucide="link-2" class="absolute left-4 top-4 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
                             <div id="urlValidationStatus" class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 flex items-center justify-center"></div>
                        </div>
                        <p id="urlValidationMessage" class="text-xs text-red-400/80 mt-1.5 ml-1 h-3"></p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 pt-2 items-stretch">
                        <div class="sm:col-span-2 flex flex-col gap-5">
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Group</label>
                                <input type="text" id="inpGroup" list="groupSuggestions" class="w-full bg-dark-bg border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500" placeholder="e.g., News">
                                <datalist id="groupSuggestions"></datalist>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Logo URL</label>
                                <div class="relative group">
                                    <input type="url" id="inpLogo" class="w-full bg-dark-bg border border-dark-border rounded-xl pl-11 pr-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500" placeholder="https://...">
                                    <i data-lucide="image" class="absolute left-4 top-4 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
                                </div>
                            </div>
                        </div>
                        <div class="sm:col-span-1 flex flex-col">
                            <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Preview</label>
                            <div id="logoPreview" class="image-preview-container w-full h-full min-h-[120px] rounded-2xl border-2 border-dashed border-dark-border flex items-center justify-center relative overflow-hidden group transition-all hover:border-brand-500/50">
                                <div class="text-gray-600 flex flex-col items-center gap-2 preview-placeholder select-none">
                                    <i data-lucide="image-off" class="w-8 h-8 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-6 flex gap-3 border-t border-dark-border/50">
                        <button type="button" onclick="toggleModal('addChannelModal')" class="flex-1 px-4 py-3 bg-transparent border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">Cancel</button>
                        <button type="submit" id="saveChannelBtn" class="flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98] disabled:opacity-40 disabled:cursor-not-allowed disabled:bg-brand-600/40 disabled:shadow-none">Save Channel</button>
                    </div>
                    <div id="deleteBtnContainer" class="hidden flex justify-center pt-2">
                        <button type="button" onclick="deleteChannel()" class="text-red-500 hover:text-red-400 text-xs py-2 px-3 hover:bg-red-500/10 rounded-lg transition flex items-center gap-1.5 opacity-80 hover:opacity-100 active:scale-95">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Remove Channel
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Playlist Import Form -->
            <div id="formPlaylist" class="hidden">
                 <form onsubmit="handlePlaylistImport(event)" class="flex flex-col gap-5 relative pb-5">
                    <div>
                        <div class="flex justify-between items-center">
							<label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">M3U Playlist URL</label>
							<button type="button" onclick="toggleModal('browsePlaylistsModal')" class="text-xs text-brand-400 hover:text-brand-300 transition-colors mb-2 flex items-center gap-1">
                                <i data-lucide="globe" class="w-3 h-3"></i> Browse Public Playlists
                            </button>
						</div>
                        <input type="text" id="inpM3uUrl" required class="w-full bg-dark-bg border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors font-mono text-sm placeholder-gray-500" placeholder="https://...">
                        <p class="text-xs text-gray-500 mt-2 ml-1">You can add multiple playlist URLs separated by commas.</p>
                    </div>
                    
                    <div class="pt-4 flex flex-col gap-4">
                        <div class="flex items-center justify-between p-4 bg-dark-bg/50 border border-dark-border rounded-xl">
                            <div class="pr-4">
                                <span class="font-semibold text-white">Auto-delete unreachable streams</span>
                                <p class="text-xs text-gray-400 mt-1">During import, discard any streams that cannot be reached. Recommended for cleaner lists.</p>
                            </div>
                            <label class="custom-checkbox shrink-0">
                                <input type="checkbox" id="inpSmartCleanup" checked>
                                <div class="checkbox-visual"></div>
                            </label>
                        </div>
                    </div>

                    <div class="pt-6 flex gap-3 border-t border-dark-border/50">
                         <button type="button" onclick="toggleModal('addChannelModal')" class="flex-1 px-4 py-3 bg-transparent border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">Cancel</button>
                         <button type="submit" class="flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98]">
                             <i data-lucide="download-cloud" class="inline w-4 h-4 mr-2 -ml-1"></i> Start Import
                         </button>
                    </div>
                 </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Browse Public Playlists -->
<div id="browsePlaylistsModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-4xl h-[90vh] rounded-3xl border border-dark-border shadow-2xl transform transition-all scale-100 animate-slide-in relative overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="p-6 shrink-0 relative flex justify-between items-center border-b border-dark-border">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                <i data-lucide="globe" class="w-6 h-6 text-brand-400"></i> Public IPTV Playlists
            </h3>
            <button onclick="toggleModal('browsePlaylistsModal')" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <!-- Search & Tabs -->
        <div class="p-4 shrink-0 border-b border-dark-border bg-dark-surface/50">
            <div class="relative group focus-within:ring-2 focus-within:ring-brand-500/50 rounded-xl transition-all mb-4">
                <i data-lucide="search" class="absolute left-3.5 top-3 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
                <input type="text" id="browseSearchInput" placeholder="Search within tab..." oninput="renderBrowsePlaylists()"
                    class="w-full bg-dark-bg border border-dark-border rounded-xl pl-10 pr-4 py-2.5 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500">
            </div>
            <div class="flex space-x-2 pb-1">
				<button onclick="switchBrowseTab('category')" id="browse-tab-category" class="browse-tab active flex-1 text-center text-sm font-medium px-4 py-2 rounded-lg border border-transparent hover:bg-white/5 hover:text-white transition-colors">Categories</button>
				<button onclick="switchBrowseTab('language')" id="browse-tab-language" class="browse-tab flex-1 text-center text-sm font-medium px-4 py-2 rounded-lg border border-transparent text-gray-400 hover:bg-white/5 hover:text-white transition-colors">Languages</button>
				<button onclick="switchBrowseTab('country')" id="browse-tab-country" class="browse-tab flex-1 text-center text-sm font-medium px-4 py-2 rounded-lg border border-transparent text-gray-400 hover:bg-white/5 hover:text-white transition-colors">Countries</button>
				<button onclick="switchBrowseTab('region')" id="browse-tab-region" class="browse-tab flex-1 text-center text-sm font-medium px-4 py-2 rounded-lg border border-transparent text-gray-400 hover:bg-white/5 hover:text-white transition-colors">Regions</button>
			</div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 pb-4" id="browsePlaylistsContent">
            <!-- Content is rendered by JS -->
        </div>
    </div>
</div>

<!-- MODAL: Settings -->
<div id="settingsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <!-- Removed p-6 sm:p-8, added overflow-hidden -->
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl transform transition-all scale-100 animate-slide-in relative overflow-hidden flex flex-col max-h-[90vh]">
        
        <!-- Decorative Glow -->
        <div class="absolute top-0 left-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>

        <!-- Header (Added padding here) -->
        <div class="flex justify-between items-center p-6 sm:p-8 pb-4 border-b border-dark-border shrink-0 relative z-10">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                <i data-lucide="settings" class="w-6 h-6 text-brand-400"></i> Settings
            </h3>
            <button onclick="toggleModal('settingsModal')" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <!-- Content (Added padding here) -->
        <div class="overflow-y-auto no-scrollbar relative flex-1 p-6 sm:p-8 space-y-5">
            
            <!-- Card 1: Data Management -->
            <div class="bg-dark-bg/50 border border-dark-border rounded-2xl p-5">
                <h4 class="text-xs font-semibold text-gray-400 mb-4 uppercase tracking-wider">Data Management</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button onclick="initiateImport()" class="w-full text-left flex items-center gap-3 p-4 bg-dark-surface/50 hover:bg-dark-light/70 border border-dark-light rounded-xl transition text-sm text-gray-200 active:scale-[0.98]">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-brand-400"></i>
                        <div>
                            <span class="font-bold">Import Playlist</span>
                            <p class="text-xs text-gray-500">Merge from .json</p>
                        </div>
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importPlaylists(event)">
                    
                    <button onclick="exportPlaylists()" class="w-full text-left flex items-center gap-3 p-4 bg-dark-surface/50 hover:bg-dark-light/70 border border-dark-light rounded-xl transition text-sm text-gray-200 active:scale-[0.98]">
                        <i data-lucide="download-cloud" class="w-5 h-5 text-brand-400"></i>
                        <div>
                            <span class="font-bold">Export Playlist</span>
                            <p class="text-xs text-gray-500">Save to .json</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Card 2: Maintenance -->
            <div class="bg-dark-bg/50 border border-dark-border rounded-2xl p-5 text-center">
                <h4 class="text-xs font-semibold text-gray-400 mb-5 uppercase tracking-wider">Maintenance</h4>
                <div class="space-y-6">
                    <div>
                        <h5 class="font-bold text-white">Scan Channel Health</h5>
                        <p class="text-sm text-gray-400 mt-2 mb-4 leading-relaxed max-w-sm mx-auto">Check all channels to see if they're online. This can take a while for large lists.</p>
                        <button id="scanHealthBtn" onclick="scanAllChannelHealth()" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition text-sm font-bold shadow-lg shadow-brand-500/20 active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                           <i data-lucide="activity" class="inline w-4 h-4 mr-2"></i> Start Scan
                        </button>
                        <p class="text-xs text-gray-500 mt-3 max-w-xs mx-auto">Note: This performs a quick reachability check. A 'Good' status confirms the link is active but does not guarantee the stream is playable.</p>
                        <p id="scanHealthStatus" class="text-xs text-gray-500 mt-3 hidden"></p>
                    </div>
                     <div class="pt-6 border-t border-dark-border/50">
                        <h5 class="font-bold text-white">Clean Up Playlist</h5>
                        <p class="text-sm text-gray-400 mt-2 mb-4 leading-relaxed max-w-sm mx-auto">Permanently remove all channels currently marked with 'Poor' health.</p>
                        <button id="deletePoorChannelsBtn" onclick="deletePoorChannels()" class="px-5 py-2.5 bg-yellow-600/20 hover:bg-yellow-600/30 border border-yellow-500/20 rounded-xl text-yellow-300 hover:text-white transition text-sm font-bold active:scale-95">
                           <i data-lucide="trash-2" class="inline w-4 h-4 mr-2"></i> Delete Poor Channels
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card 3: Danger Zone -->
            <div class="bg-red-500/5 border border-red-500/20 rounded-2xl p-5 text-center">
                <h4 class="text-xs font-semibold text-red-400/80 mb-4 uppercase tracking-wider">Danger Zone</h4>
                <div>
                    <h5 class="font-bold text-white">Clear All Data</h5>
                    <p class="text-sm text-gray-400 mt-2 mb-4 leading-relaxed max-w-sm mx-auto">This will permanently delete all your channels and favorites. This is irreversible.</p>
                    <button onclick="resetAllData()" class="px-6 py-2.5 bg-red-600 hover:bg-red-500 rounded-xl text-white transition text-sm font-bold shadow-lg shadow-red-500/20 active:scale-95">
                        Reset Application
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Confirmation Dialog -->
<div id="confirmModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-md rounded-3xl border border-dark-border shadow-2xl p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden text-center">
        <div id="confirmIcon" class="bg-red-500/10 p-4 rounded-full mb-5 ring-1 ring-red-500/20 inline-block">
            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
        </div>
        <h3 id="confirmTitle" class="text-xl font-bold text-white mb-3">Are you sure?</h3>
        <p id="confirmMessage" class="text-gray-400 mb-8 max-w-md leading-relaxed text-sm mx-auto">This action cannot be undone.</p>
        <div class="flex gap-3">
            <button id="confirmCancelBtn" class="flex-1 px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">
                Cancel
            </button>
            <button id="confirmOkBtn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white transition font-bold shadow-lg shadow-red-500/20 transform active:scale-[0.98]">
                Confirm
            </button>
        </div>
    </div>
</div>

<!-- MODAL: Share Confirmation -->
<div id="shareConfirmModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl p-6 sm:p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>
        <div class="flex justify-between items-center mb-6 relative">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                <i data-lucide="inbox" class="w-6 h-6 text-brand-400"></i>
                Add Shared Channel
            </h3>
            <button onclick="closeShareConfirm()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <p class="text-gray-400 text-sm mb-6">Someone shared a channel with you. Review the details below before adding it to your list.</p>
        
        <div class="space-y-4 mb-8">
            <div class="flex items-center gap-4 bg-dark-bg/50 p-4 rounded-2xl border border-dark-border">
                <div id="shareLogo" class="w-14 h-14 bg-dark-border rounded-xl flex items-center justify-center border border-white/10 overflow-hidden shrink-0">
                    <!-- Logo will be injected here -->
                </div>
                <div>
                    <h4 id="shareName" class="text-lg font-bold text-white">Channel Name</h4>
                    <span id="shareGroup" class="text-sm text-brand-300">Channel Group</span>
                </div>
            </div>
            <div>
                 <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Stream URL</label>
                 <div id="shareUrl" class="bg-dark-bg p-3 rounded-lg border border-dark-border break-all text-xs text-gray-400 select-all font-mono">
                     <!-- URL will be injected here -->
                 </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="closeShareConfirm()" class="flex-1 px-4 py-3 bg-transparent border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">Cancel</button>
            <button id="addSharedBtn" class="flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98]">
                <i data-lucide="plus" class="inline w-4 h-4 mr-1.5 -ml-1"></i> Add to My List
            </button>
        </div>
    </div>
</div>

<!-- MODAL: Playlist Import Progress -->
<div id="importProgressModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl p-6 sm:p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
        <div class="relative">
            <h3 class="text-2xl font-bold text-white mb-3" id="importProgressTitle">Importing Playlist...</h3>
            <p class="text-gray-400 text-sm mb-6" id="importProgressStatus">Parsing and validating channels. This may take a few moments...</p>
            <p class="text-gray-400 text-sm mb-6 hidden" id="importQueueStatus"></p>


            <div class="space-y-4">
                <div class="flex justify-between items-baseline mb-1">
                    <span class="text-sm font-medium text-gray-300">Overall Progress</span>
                    <span class="text-sm font-bold text-brand-300" id="importProgressPercent">0%</span>
                </div>
                <div class="w-full bg-dark-bg h-3 rounded-full overflow-hidden border border-dark-border">
                    <div id="importProgressBar" class="h-full rounded-full progress-bar-inner" style="width: 0%;"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-2 text-center">
                    <div>
                        <p class="text-2xl font-bold text-green-400" id="importProgressKept">0</p>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Channels Added</p>
                    </div>
                     <div>
                        <p class="text-2xl font-bold text-red-400" id="importProgressRemoved">0</p>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Channels Discarded</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex gap-3">
                <button id="importProgressHideBtn" onclick="toggleModal('importProgressModal')" class="flex-1 px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">
                    Hide
                </button>
                <button id="importProgressCancelBtn" onclick="cancelImport()" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white transition font-bold shadow-lg shadow-red-500/20 transform active:scale-[0.98]">
                    Cancel
                </button>
                 <button id="importProgressDoneBtn" onclick="toggleModal('importProgressModal')" class="hidden flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98]">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>


<!-- TOAST -->
<div id="toast" class="fixed top-8 left-1/2 sm:left-auto -translate-x-1/2 sm:translate-x-0 sm:right-8 w-11/12 max-w-sm sm:w-auto glass px-6 py-4 rounded-2xl shadow-2xl transform -translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-4 z-[80]">
    <div id="toastIcon" class="bg-brand-500/20 p-2 rounded-full"><i data-lucide="check" class="text-brand-400 w-5 h-5"></i></div>
    <div class="flex flex-col">
        <span id="toastMsg" class="font-medium text-sm tracking-wide text-white">Action successful</span>
    </div>
</div>

<script>
    // --- STATE ---
    let channels = JSON.parse(localStorage.getItem('sleek_channels')) || [];
    let favorites = JSON.parse(localStorage.getItem('sleek_favorites')) || [];
    let settings = JSON.parse(localStorage.getItem('sleek_settings')) || { preferredLang: 'eng' };
    let currentChannelId = null;
    let hls = null;
    let isDesktopSidebarCollapsed = false;
    let isMobileSidebarOpen = false;
    let showOnlyFavorites = false;
    let isCaptionsOn = false;
    let aspectModes = ['contain', 'cover', 'fill'];
    let currentAspectIndex = 0;
    let inactivityTimer;
    let animationFrameId = null;
    let sharedChannelData = null; 
    let importWorker = null;
    let isFullscreenMenuOpen = false;
    let currentBrowseTab = 'category';
    let importQueue = [];
    let totalImportCount = 0;
    let totalKept = 0;
    let totalRemoved = 0;
    let urlValidationTimeout;
    let currentSortMode = 'default'; // 'default', 'health_asc', 'health_desc'

    // Mobile specific interaction state
    let isTouchInteraction = false;
    let mobileMenuOpen = false;

    const video = document.getElementById('videoPlayer');

    // --- DOM REFS ---
    const els = {
        videoContainer: document.getElementById('videoContainer'),
        backgroundCanvas: document.getElementById('backgroundCanvas'),
        controlsOverlay: document.getElementById('controlsOverlay'),
        mobileMenuOptions: document.getElementById('mobileMenuOptions'),
        desktopControls: document.getElementById('desktopControls'),
        channelList: document.getElementById('channelList'),
        searchInput: document.getElementById('searchInput'),
        groupFilterLabel: document.getElementById('selectedGroupLabel'),
        groupOptionsList: document.getElementById('groupOptionsList'),
        sidebar: document.getElementById('sidebar'),
        sidebarBackdrop: document.getElementById('sidebarBackdrop'),
        sidebarToggleStrip: document.getElementById('sidebarToggleStrip'),
        channelCount: document.getElementById('channelCount'),
        loading: document.getElementById('loadingOverlay'),
        loadingTitle: document.getElementById('loadingTitle'),
        loadingStatus: document.getElementById('loadingStatus'),
        error: document.getElementById('errorOverlay'),
        errorMessage: document.getElementById('errorMessage'),
        startScreen: document.getElementById('startScreen'),
        networkDot: document.getElementById('healthDot'),
        networkText: document.getElementById('healthText'),
        favBtn: document.getElementById('currentFavBtn'),
        logoPreview: document.getElementById('logoPreview'),
        inpLogo: document.getElementById('inpLogo'),
        inpUrl: document.getElementById('inpUrl'),
        saveChannelBtn: document.getElementById('saveChannelBtn'),
        urlValidationStatus: document.getElementById('urlValidationStatus'),
        urlValidationMessage: document.getElementById('urlValidationMessage'),
        fullscreenInfo: document.getElementById('fullscreenInfo'),
        fullscreenChannelLogo: document.getElementById('fullscreenChannelLogo'),
        fullscreenChannelName: document.getElementById('fullscreenChannelName'),
        fullscreenMenu: document.getElementById('fullscreenChannelMenu'),
        fullscreenMenuList: document.getElementById('fullscreenChannelList'),
        prevChannelBtn: document.getElementById('prevChannelBtn'),
        nextChannelBtn: document.getElementById('nextChannelBtn'),
        confirm: {
            modal: document.getElementById('confirmModal'),
            title: document.getElementById('confirmTitle'),
            message: document.getElementById('confirmMessage'),
            okBtn: document.getElementById('confirmOkBtn'),
            cancelBtn: document.getElementById('confirmCancelBtn'),
            icon: document.getElementById('confirmIcon')
        },
        stats: {
            overlay: document.getElementById('statsOverlay'),
            res: document.getElementById('statRes'),
            bitrate: document.getElementById('statBitrate'),
            buffer: document.getElementById('statBuffer'),
            dropped: document.getElementById('statDropped'),
            bw: document.getElementById('statBw'),
            url: document.getElementById('statUrl'),
            engine: document.getElementById('statEngine')
        },
        importProgress: {
            modal: document.getElementById('importProgressModal'),
            title: document.getElementById('importProgressTitle'),
            status: document.getElementById('importProgressStatus'),
            queueStatus: document.getElementById('importQueueStatus'),
            percent: document.getElementById('importProgressPercent'),
            bar: document.getElementById('importProgressBar'),
            kept: document.getElementById('importProgressKept'),
            removed: document.getElementById('importProgressRemoved'),
            hideBtn: document.getElementById('importProgressHideBtn'),
            cancelBtn: document.getElementById('importProgressCancelBtn'),
            doneBtn: document.getElementById('importProgressDoneBtn'),
            footer: document.getElementById('importStatusFooter'),
            footerText: document.getElementById('importFooterProgressText'),
            defaultFooter: document.getElementById('defaultFooter')
        }
    };

    let currentFilterGroup = 'all';

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            setTimeout(() => lucide.createIcons(), 50);
        }
        
        renderChannels();
        updateGroupDropdown();
        setupPlayerEvents();
        setupKeyboardShortcuts();
        setupInactivityControls();
        handleIncomingShareLink();
        renderBrowsePlaylists();
        setupUrlValidation();
        
        els.searchInput.addEventListener('input', renderChannels);
        els.inpLogo.addEventListener('input', updateLogoPreview);

        window.addEventListener('resize', () => {
            if(window.innerWidth >= 768) {
                if (isMobileSidebarOpen) toggleSidebar(); 
                if (mobileMenuOpen) closeMobileMenu();
            }
        });
        
        document.addEventListener('fullscreenchange', () => {
			if (!document.fullscreenElement) {
				document.getElementById('fsIcon').setAttribute('data-lucide', 'maximize');
				if (isFullscreenMenuOpen) toggleFullscreenMenu(); // Close menu on exiting fullscreen
				lucide.createIcons();
			}
		});

        // Click outside handler for mobile menu
        document.addEventListener('click', (e) => {
            if (mobileMenuOpen && !e.target.closest('#mobileMenuOptions') && !e.target.closest('#mobileMoreBtn')) {
                closeMobileMenu();
            }
        });

        buildPlayerControls();
        
        // Add event listeners for new buttons
        els.prevChannelBtn.addEventListener('click', loadPrevChannel);
        els.nextChannelBtn.addEventListener('click', loadNextChannel);
    });

    // --- BLURRED BACKGROUND ---
    function updateBackgroundCanvas() {
        if (!video.paused && !video.ended && video.videoWidth > 0) {
            const canvas = els.backgroundCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        animationFrameId = requestAnimationFrame(updateBackgroundCanvas);
    }

    function startBackgroundLoop() {
        if (!animationFrameId) {
            updateBackgroundCanvas();
        }
    }

    function stopBackgroundLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            const canvas = els.backgroundCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    
    // --- UI INACTIVITY / MOBILE GLITCH FIX ---
    function setupInactivityControls() {
        // Detect touch capability to separate logic
        els.videoContainer.addEventListener('touchstart', () => {
            isTouchInteraction = true;
        }, {passive: true});

        function showUI() {
            if (!els.videoContainer.classList.contains('player-active')) return;
            // Select all UI elements that should auto-hide
            document.querySelectorAll('.ui-element').forEach(el => el.classList.remove('ui-hidden'));
        }

        function hideUI() {
            if (video.paused || mobileMenuOpen || isFullscreenMenuOpen) return;
            // Select all UI elements that should auto-hide
            document.querySelectorAll('.ui-element').forEach(el => el.classList.add('ui-hidden'));
            // Also close menu if UI hides
            if(mobileMenuOpen) closeMobileMenu();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            showUI();
            inactivityTimer = setTimeout(hideUI, 3000);
        }

        // DESKTOP: Hover logic
        els.videoContainer.addEventListener('mousemove', (e) => {
            // If we recently detected touch, ignore mousemove (simulated by tap) to prevent jitter
            if (isTouchInteraction) return;
            resetInactivityTimer();
        });

        els.videoContainer.addEventListener('mouseleave', () => {
            if (isTouchInteraction) return;
            hideUI();
        });

        // MOBILE / TOUCH: Explicit Toggle
        // We use 'click' on the container, but we check if it was a touch event flag
        els.videoContainer.addEventListener('click', (e) => {
            // Don't toggle if clicking actual controls or the new nav buttons
            if(e.target.closest('.controls-wrapper') || e.target.closest('.glass') || e.target.closest('#mobileMenuOptions') || e.target.closest('#prevChannelBtn') || e.target.closest('#nextChannelBtn') || e.target.closest('#fullscreenChannelMenu')) return;

            if (isTouchInteraction) {
                if (els.controlsOverlay.classList.contains('ui-hidden')) {
                    resetInactivityTimer();
                } else {
                    hideUI();
                }
                // Reset flag after a short delay so mousemove works again if user switches input (rare)
                setTimeout(() => { isTouchInteraction = false; }, 500);
            }
        });

        video.addEventListener('pause', () => {
            showUI();
            clearTimeout(inactivityTimer);
        });
        
        video.addEventListener('play', resetInactivityTimer);
    }
    
    // --- ADD/EDIT MODAL TABS ---
    function switchAddTab(tab) {
        if (tab === 'single') {
            document.getElementById('tabSingle').classList.add('border-brand-500', 'text-white');
            document.getElementById('tabSingle').classList.remove('border-transparent', 'text-gray-400');
            document.getElementById('tabPlaylist').classList.remove('border-brand-500', 'text-white');
            document.getElementById('tabPlaylist').classList.add('border-transparent', 'text-gray-400');
            document.getElementById('formSingle').classList.remove('hidden');
            document.getElementById('formPlaylist').classList.add('hidden');
            document.getElementById('modalTitle').textContent = 'Add Stream';
        } else {
            document.getElementById('tabPlaylist').classList.add('border-brand-500', 'text-white');
            document.getElementById('tabPlaylist').classList.remove('border-transparent', 'text-gray-400');
            document.getElementById('tabSingle').classList.remove('border-brand-500', 'text-white');
            document.getElementById('tabSingle').classList.add('border-transparent', 'text-gray-400');
            document.getElementById('formPlaylist').classList.remove('hidden');
            document.getElementById('formSingle').classList.add('hidden');
            document.getElementById('modalTitle').textContent = 'Import Playlist';
        }
    }


    // --- MOBILE MENU ---
    function toggleMobileMenu() {
        mobileMenuOpen = !mobileMenuOpen;
        if(mobileMenuOpen) {
            els.stats.overlay.classList.add('hidden'); // Close stats if open
            els.mobileMenuOptions.classList.remove('hidden');
            els.mobileMenuOptions.classList.add('flex');
            // Keep UI open while menu is open
            clearTimeout(inactivityTimer);
        } else {
            closeMobileMenu();
        }
    }
	
    function closeMobileMenu() {
        mobileMenuOpen = false;
        els.mobileMenuOptions.classList.add('hidden');
        els.mobileMenuOptions.classList.remove('flex');
    }

    // --- KEYBOARD SHORTCUTS ---
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
             // Ignore shortcuts if an input is focused or a modal is open
             if (e.target.tagName === 'INPUT' || document.querySelector('.fixed.inset-0:not(.hidden)')) return;

            switch(e.code) {
                case 'Space': e.preventDefault(); togglePlay(); break;
                case 'KeyF': e.preventDefault(); toggleFullscreen(); break;
                case 'KeyM': toggleMute(); break;
                case 'ArrowUp': e.preventDefault(); setVolume(Math.min(1, video.volume + 0.1)); break;
                case 'ArrowDown': e.preventDefault(); setVolume(Math.max(0, video.volume - 0.1)); break;
                case 'ArrowRight': e.preventDefault(); loadNextChannel(); break;
                case 'ArrowLeft': e.preventDefault(); loadPrevChannel(); break;
            }
        });
    }

    // --- ENHANCED IMAGE PREVIEW ---
    function updateLogoPreview() {
        const url = els.inpLogo.value.trim();
        const previewContainer = els.logoPreview;
        
        const placeholderHTML = `
            <div class="text-gray-600 flex flex-col items-center gap-2 animate-fade-in select-none">
                <i data-lucide="image" class="w-8 h-8 opacity-50"></i>
                <span class="text-[10px] uppercase tracking-wide opacity-50">No Image</span>
            </div>`;

        const loadingHTML = `<div class="mini-loader"></div>`;

        if (!url) {
            previewContainer.innerHTML = placeholderHTML;
            lucide.createIcons();
            return;
        }

        previewContainer.innerHTML = loadingHTML;

        const img = new Image();
        img.src = url;

        img.onload = () => {
            previewContainer.innerHTML = `<img src="${url}" class="max-w-[80%] max-h-[80%] drop-shadow-xl animate-fade-in" draggable="false" alt="Preview">`;
        };

        img.onerror = () => {
            previewContainer.innerHTML = `
                <div class="text-red-400/50 flex flex-col items-center gap-2 animate-fade-in select-none">
                    <i data-lucide="image-off" class="w-8 h-8"></i>
                    <span class="text-[10px] uppercase tracking-wide">Load Failed</span>
                </div>`;
            lucide.createIcons();
        };
    }

    // --- SIDEBAR ---
        function toggleSidebar() {
        const sidebar = els.sidebar;
        const backdrop = els.sidebarBackdrop;
        // Use a more specific and robust selector for the desktop collapse button's icon
        const desktopCollapseButtonIcon = sidebar.querySelector('.sidebar-text button.hidden.md\\:block:last-of-type i');

        if (window.innerWidth < 768) {
            // Mobile: Toggle slide-in/out
            isMobileSidebarOpen = !isMobileSidebarOpen;
            if (isMobileSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                setTimeout(() => backdrop.classList.add('hidden'), 300);
            }
        } else {
            // Desktop: Toggle width
            isDesktopSidebarCollapsed = !isDesktopSidebarCollapsed;
            if (isDesktopSidebarCollapsed) {
                sidebar.style.width = '0px';
                sidebar.classList.add('opacity-0', 'pointer-events-none');
                if(desktopCollapseButtonIcon) desktopCollapseButtonIcon.setAttribute('data-lucide', 'chevron-right');
                els.sidebarToggleStrip.classList.remove('hidden');
                els.sidebarToggleStrip.classList.add('flex');
            } else {
                sidebar.style.width = '340px';
                sidebar.classList.remove('opacity-0', 'pointer-events-none');
                if(desktopCollapseButtonIcon) desktopCollapseButtonIcon.setAttribute('data-lucide', 'chevron-left');
                els.sidebarToggleStrip.classList.add('hidden');
                els.sidebarToggleStrip.classList.remove('flex');
            }
        }
        setTimeout(() => lucide.createIcons(), 50);
    }

    // --- DROPDOWN ---
    function toggleDropdown() {
        document.getElementById('groupFilterDropdown').classList.toggle('open');
    }

    function selectGroup(group) {
        currentFilterGroup = group;
        els.groupFilterLabel.textContent = group === 'all' ? 'All Groups' : group;
        document.getElementById('groupFilterDropdown').classList.remove('open');
        renderChannels();
    }

    function updateGroupDropdown() {
        const groups = [...new Set(channels.map(c => c.group || 'Uncategorized'))].sort();
        // Added 'truncate' class below
        let html = `<div onclick="selectGroup('all')" class="truncate px-3 py-2 hover:bg-white/5 cursor-pointer rounded-lg text-sm text-gray-300 transition-colors ${currentFilterGroup === 'all' ? 'bg-brand-500/10 text-brand-300' : ''}">All Groups</div>`;
        
        groups.forEach(g => {
            // Added 'truncate' class and a 'title' attribute so users can see full text on hover
            html += `<div onclick="selectGroup('${g}')" title="${g}" class="truncate px-3 py-2 hover:bg-white/5 cursor-pointer rounded-lg text-sm text-gray-300 transition-colors ${currentFilterGroup === g ? 'bg-brand-500/10 text-brand-300' : ''}">${g}</div>`;
        });
        els.groupOptionsList.innerHTML = html;
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
            document.getElementById('groupFilterDropdown').classList.remove('open');
        }
    });

    // --- CHANNEL LOGIC ---
    function saveToLocal() {
        localStorage.setItem('sleek_channels', JSON.stringify(channels));
        localStorage.setItem('sleek_favorites', JSON.stringify(favorites));
        localStorage.setItem('sleek_settings', JSON.stringify(settings));
        updateGroupDropdown();
    }

    function handleChannelSubmit(e) {
        e.preventDefault();
        
        const url = document.getElementById('inpUrl').value.trim();
        
        // Final check, although button should be disabled
        if (!url || els.saveChannelBtn.disabled) {
            showToast("Please enter a valid stream URL.", "error");
            return;
        }

        const channelId = document.getElementById('channelId').value;
        const formData = {
            name: document.getElementById('inpName').value,
            url: url,
            group: document.getElementById('inpGroup').value || 'Uncategorized',
            logo: document.getElementById('inpLogo').value,
            health: 'unchecked' // Default health for new channels
        };

        if (channelId) { // Handle editing
            const existingIndex = channels.findIndex(c => c.id === channelId);
            if (existingIndex > -1) {
                // Preserve existing health status unless URL has changed
                formData.health = channels[existingIndex].url === url ? channels[existingIndex].health : 'unchecked';
                formData.id = channelId;
                channels[existingIndex] = formData;
                showToast(`Updated ${formData.name}`);
            }
        } else { // Handle adding a new channel
            formData.id = Date.now().toString();
            channels.push(formData);
            showToast(`Added ${formData.name}`);
        }

        saveToLocal();
        renderChannels();
        toggleModal('addChannelModal');
        
        if (channelId && channelId === currentChannelId) {
            loadChannel(channelId);
        }
    }


    function toggleFavorite(id, e) {
        if(e) e.stopPropagation();
        
        const isCurrentlyFav = favorites.includes(id);
        
        if(isCurrentlyFav) {
            favorites = favorites.filter(fid => fid !== id);
        } else {
            favorites.push(id);
        }
        
        saveToLocal();
        updateFavButtonState();

        if (showOnlyFavorites) {
            renderChannels();
        } else {
            const item = document.getElementById(`channel-item-${id}`);
            const btn = (e && e.currentTarget) || (item && item.querySelector('button'));

            if (btn) {
                btn.style.transform = 'scale(0.8)';
                setTimeout(() => btn.style.transform = 'scale(1)', 150);

                if (!isCurrentlyFav) {
                    btn.classList.remove('text-gray-600', 'opacity-0');
                    btn.classList.add('text-brand-400', 'opacity-100');
                    btn.innerHTML = `<i data-lucide="heart" class="w-4 h-4 fill-current animate-heart-beat"></i>`;
                } else {
                    btn.classList.remove('text-brand-400', 'opacity-100');
                    btn.classList.add('text-gray-600', 'opacity-0');
                    btn.innerHTML = `<i data-lucide="heart" class="w-4 h-4"></i>`;
                }
                lucide.createIcons();
            }
        }
    }

    function toggleCurrentFavorite() {
        if(currentChannelId) toggleFavorite(currentChannelId);
    }

    function filterFavorites() {
        showOnlyFavorites = !showOnlyFavorites;
        const btn = document.getElementById('favFilterBtn');
        if(showOnlyFavorites) {
            btn.classList.add('bg-brand-500', 'text-white', 'border-brand-500');
        } else {
            btn.classList.remove('bg-brand-500', 'text-white', 'border-brand-500');
        }
        renderChannels();
    }

    function toggleSort() {
        const sortModes = ['default', 'health_asc', 'health_desc'];
        const currentModeIndex = sortModes.indexOf(currentSortMode);
        currentSortMode = sortModes[(currentModeIndex + 1) % sortModes.length];
        
        const btn = document.getElementById('sortBtn');
        const icons = {
            'default': 'arrow-down-a-z',
            'health_asc': 'arrow-up-circle',
            'health_desc': 'arrow-down-circle'
        };
        const titles = {
            'default': 'Sort Alphabetically',
            'health_asc': 'Sort by Good Connection',
            'health_desc': 'Sort by Poor Connection'
        };

        btn.innerHTML = `<i data-lucide="${icons[currentSortMode]}" class="w-4 h-4"></i>`;
        btn.title = titles[currentSortMode];
        lucide.createIcons();
        renderChannels();
    }

    function renderChannels() {
        const query = els.searchInput.value.toLowerCase();
        
        let filtered = channels.filter(c => {
            const group = c.group || 'Uncategorized';
            const matchesSearch = c.name.toLowerCase().includes(query) || group.toLowerCase().includes(query);
            const matchesGroup = currentFilterGroup === 'all' || group === currentFilterGroup;
            const matchesFav = showOnlyFavorites ? favorites.includes(c.id) : true;
            return matchesSearch && matchesGroup && matchesFav;
        });

        // --- NEW: Sorting Logic ---
        const healthOrder = { 'good': 1, 'unchecked': 2, 'poor': 3 };
        if (currentSortMode === 'health_asc') {
            filtered.sort((a, b) => (healthOrder[a.health] || 3) - (healthOrder[b.health] || 3));
        } else if (currentSortMode === 'health_desc') {
            filtered.sort((a, b) => (healthOrder[b.health] || 3) - (healthOrder[a.health] || 3));
        } else { // default
            filtered.sort((a, b) => a.name.localeCompare(b.name));
        }


        els.channelCount.textContent = `${filtered.length} loaded`;

        els.channelList.innerHTML = filtered.map(c => {
            const isFav = favorites.includes(c.id);
            const isActive = currentChannelId === c.id;
            const group = c.group || 'Uncategorized';
            
            let healthColor = 'bg-gray-500'; // unchecked
            let healthTitle = 'Unchecked';
            if (c.health === 'good') {
                healthColor = 'bg-green-500';
                healthTitle = 'Good';
            }
            if (c.health === 'poor') {
                healthColor = 'bg-red-500';
                healthTitle = 'Poor';
            }

            return `
            <div id="channel-item-${c.id}" onclick="loadChannel('${c.id}')" 
                 class="channel-item cursor-pointer p-3 rounded-xl border border-transparent group relative flex items-center gap-4 mb-1 ${isActive ? 'active' : 'hover:bg-dark-surface/60 hover:border-dark-light/50'}">
                
                <div class="active-indicator absolute left-0 top-3 bottom-3 w-1 bg-brand-500 rounded-r-full opacity-0 transition-all duration-300 scale-y-50 origin-left"></div>

                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-dark-light to-dark-border flex-shrink-0 flex items-center justify-center overflow-hidden border border-white/5 relative shadow-sm group-hover:shadow-md transition-all">
                    ${c.logo ? `<img src="${c.logo}" class="w-full h-full object-contain p-0.5" draggable="false" onerror="this.onerror=null; this.parentElement.innerHTML='<i data-lucide=\\'tv\\'></i>'; lucide.createIcons();">` : '<i data-lucide="tv" class="w-5 h-5 text-gray-500"></i>'}
                </div>
                
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <h4 class="text-sm font-medium transition-colors truncate ${isActive ? 'text-white font-bold' : 'text-gray-300 group-hover:text-white'}">${c.name}</h4>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full ${healthColor} ring-1 ring-black/20" title="Health: ${healthTitle}"></span>
                        <p class="text-[11px] truncate transition-colors ${isActive ? 'text-brand-300' : 'text-gray-500 group-hover:text-gray-400'}">${group}</p>
                    </div>
                </div>
                
                <button onclick="toggleFavorite('${c.id}', event)" class="p-2 hover:bg-white/10 rounded-full transition-all active:scale-90 ${isFav ? 'text-brand-400 opacity-100' : 'text-gray-600 opacity-0 group-hover:opacity-100'}">
                    <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i>
                </button>
            </div>
        `}).join('');

        if (filtered.length === 0) {
            els.channelList.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-4 text-gray-500">
                    <i data-lucide="search-x" class="w-10 h-10 mb-3 opacity-30"></i>
                    <p class="text-sm font-medium opacity-80">No channels found</p>
                    <p class="text-xs opacity-50 mt-1">Try adjusting your filters or search.</p>
                </div>
            `;
        }
        
        lucide.createIcons();
    }
    
    // --- CHANNEL HEALTH ---
    async function updateChannelHealth(channelId, status) {
        const channelIndex = channels.findIndex(c => c.id === channelId);
        if (channelIndex > -1) {
            if (channels[channelIndex].health !== status) {
                channels[channelIndex].health = status;
                saveToLocal();
                // Update just this one item in the DOM for efficiency
                const item = document.getElementById(`channel-item-${channelId}`);
                if (item) {
                    const dot = item.querySelector('.w-2.h-2');
                    if(dot) {
                        dot.className = 'w-2 h-2 rounded-full ring-1 ring-black/20 ';
                        if (status === 'good') dot.classList.add('bg-green-500');
                        else if (status === 'poor') dot.classList.add('bg-red-500');
                        else dot.classList.add('bg-gray-500');
                    }
                }
            }
        }
    }

    async function scanAllChannelHealth() {
        const scanBtn = document.getElementById('scanHealthBtn');
        const scanStatus = document.getElementById('scanHealthStatus');
        
        scanStatus.classList.remove('hidden');

        scanBtn.disabled = true;
        scanBtn.innerHTML = `<div class="mini-loader"></div>`;

        let online = 0;
        let offline = 0;
        const total = channels.length;

        for (let i = 0; i < total; i++) {
            const channel = channels[i];
            scanStatus.textContent = `Scanning ${i + 1} of ${total}: ${channel.name}`;
            try {
                // Use a short timeout to avoid getting stuck on unresponsive URLs
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);
                // A HEAD request is a lightweight way to check if a URL is reachable.
                // It doesn't guarantee the stream works, but it's a good first pass.
                await fetch(channel.url, { method: 'HEAD', signal: controller.signal, mode: 'no-cors' });
                clearTimeout(timeoutId);
                await updateChannelHealth(channel.id, 'good');
                online++;
            } catch (error) {
                await updateChannelHealth(channel.id, 'poor');
                offline++;
            }
        }
        
        scanStatus.textContent = `Scan complete: ${online} online, ${offline} offline.`;
        scanBtn.disabled = false;
        scanBtn.innerHTML = `<i data-lucide="activity" class="inline w-4 h-4 mr-2"></i> Start Scan`;
        lucide.createIcons();
        showToast("Channel health scan finished.");
        renderChannels(); // Re-render to reflect new health statuses
    }


    // --- PLAYER ENGINE ---
    
    // ===== START: BALANCED PERFORMANCE UPGRADE =====
    // This configuration provides a robust buffer without being overly
    // aggressive, offering a stable experience similar to VLC.
    const hlsConfig = {
        // ABR configs for smarter quality switching
        abrBandwidthFactor: 0.8,      // Be less conservative with bandwidth estimates
        abrBandwidthUpFactor: 0.6,    // Switch up to higher quality more readily
        
        // Buffer configs for stability
        maxBufferLength: 30,          // Target buffer of 30 seconds
        maxMaxBufferLength: 60,       // Allow up to 60 seconds on fast connections
        
        // Pre-loading configs for faster starts
        startFragPrefetch: true,
    };
    // ===== END: BALANCED PERFORMANCE UPGRADE =====

    function getCurrentChannelList() {
        const query = els.searchInput.value.toLowerCase();
        let list = channels.filter(c => {
            const group = c.group || 'Uncategorized';
            const matchesSearch = c.name.toLowerCase().includes(query) || group.toLowerCase().includes(query);
            const matchesGroup = currentFilterGroup === 'all' || group === currentFilterGroup;
            const matchesFav = showOnlyFavorites ? favorites.includes(c.id) : true;
            return matchesSearch && matchesGroup && matchesFav;
        });
        
        // --- Apply same sorting as main list ---
        const healthOrder = { 'good': 1, 'unchecked': 2, 'poor': 3 };
        if (currentSortMode === 'health_asc') {
            list.sort((a, b) => (healthOrder[a.health] || 3) - (healthOrder[b.health] || 3));
        } else if (currentSortMode === 'health_desc') {
            list.sort((a, b) => (healthOrder[b.health] || 3) - (healthOrder[a.health] || 3));
        } else { // default
            list.sort((a, b) => a.name.localeCompare(b.name));
        }
        return list;
    }

    function loadNextChannel() {
        if (!currentChannelId) return;
        const currentList = getCurrentChannelList();
        if (currentList.length <= 1) return;
        const currentIndex = currentList.findIndex(c => c.id === currentChannelId);
        if (currentIndex === -1) return;
        const nextIndex = (currentIndex + 1) % currentList.length;
        loadChannel(currentList[nextIndex].id);
    }

    function loadPrevChannel() {
        if (!currentChannelId) return;
        const currentList = getCurrentChannelList();
        if (currentList.length <= 1) return;
        const currentIndex = currentList.findIndex(c => c.id === currentChannelId);
        if (currentIndex === -1) return;
        const prevIndex = (currentIndex - 1 + currentList.length) % currentList.length;
        loadChannel(currentList[prevIndex].id);
    }

    function loadChannel(id) {
        const channel = channels.find(c => c.id === id);
        if (!channel || (id === currentChannelId && hls)) return;

        if (window.innerWidth < 768 && isMobileSidebarOpen) {
            toggleSidebar();
        }
        
        // Clean up previous caption listeners to prevent duplicates
        if (video.textTracks && video.textTracks.onaddtrack) {
            video.textTracks.onaddtrack = null;
        }

        if (currentChannelId) {
            document.getElementById(`channel-item-${currentChannelId}`)?.classList.remove('active');
        }
        document.getElementById(`channel-item-${id}`)?.classList.add('active');
        
        const fsActiveOld = document.querySelector('.fs-channel-item.active');
        if(fsActiveOld) fsActiveOld.classList.remove('active');
        const fsActiveNew = document.getElementById(`fs-channel-item-${id}`);
        if(fsActiveNew) fsActiveNew.classList.add('active');


        currentChannelId = id;
        document.title = `SleekrStream • ${channel.name}`;
        
        document.getElementById('currentChannelName').textContent = channel.name;
        document.getElementById('currentChannelGroup').textContent = channel.group || 'Uncategorized';
        els.fullscreenChannelName.textContent = channel.name;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('shareBtn').disabled = false;
        els.startScreen.style.display = 'none';
        els.error.style.display = 'none';
        els.videoContainer.classList.add('player-active');
        
        const aspectMode = aspectModes[currentAspectIndex];
        if (aspectMode === 'contain') {
            els.videoContainer.classList.add('has-blurred-bg');
        } else {
            els.videoContainer.classList.remove('has-blurred-bg');
            stopBackgroundLoop();
        }

        els.loading.style.display = 'flex';
        els.loadingTitle.textContent = `Loading: ${channel.name}`;
        els.loadingStatus.textContent = "Initializing player...";
        
        const logoEl = document.getElementById('currentChannelLogo');
        const fullscreenLogoEl = els.fullscreenChannelLogo;
        const imgHtml = channel.logo 
            ? `<img src="${channel.logo}" class="w-full h-full object-contain p-0.5" draggable="false" onerror="this.onerror=null; this.parentElement.innerHTML='<i data-lucide=\\'tv\\'></i>'; lucide.createIcons();">`
            : `<i data-lucide="tv" class="w-6 h-6 opacity-80"></i>`;
        
        logoEl.innerHTML = imgHtml;
        fullscreenLogoEl.innerHTML = imgHtml;
        if (!channel.logo) lucide.createIcons();

        updateFavButtonState();

        if (hls) hls.destroy();

        if (Hls.isSupported()) {
            hls = new Hls(hlsConfig);
            
            hls.on(Hls.Events.MANIFEST_LOADING, () => {
                els.loadingStatus.textContent = "Connecting to stream...";
            });

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                els.loadingStatus.textContent = "Stream manifest loaded, preparing video...";
                video.play().catch(() => {});
                
                // Listen for any text tracks (including embedded) being added.
                video.textTracks.onaddtrack = () => {
                    buildPlayerControls(); // Rebuild controls to show the button
                    toggleCaptions(isCaptionsOn, true); // Set initial state
                };

                buildPlayerControls(); // Build once initially
                
                const preferredTrack = hls.audioTracks.findIndex(t => t.lang === settings.preferredLang);
                if (preferredTrack > -1) {
                    hls.audioTrack = preferredTrack;
                }
            });

            hls.on(Hls.Events.LEVEL_LOADED, () => {
                els.loadingStatus.textContent = "Video data received, starting playback...";
            });

            hls.loadSource(channel.url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.ERROR, (event, data) => {
                console.error('HLS.js error:', data.details, 'Fatal:', data.fatal);
                updateChannelHealth(channel.id, 'poor');

                if (data.fatal) {
                    let errorMessage = `Could not play "${channel.name}". `;
                    switch (data.details) {
                        case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:
                        case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:
                            errorMessage += "The stream is offline or the URL is incorrect.";
                            break;
                        case Hls.ErrorDetails.NETWORK_ERROR:
                            errorMessage += "A network error occurred. Please check your connection.";
                            break;
                        case Hls.ErrorDetails.MEDIA_ERROR:
                             errorMessage += "A media error occurred. The stream may be corrupted.";
                             break;
                        default:
                            errorMessage += "An unknown error occurred.";
                    }
                    hls.destroy();
                    showError(errorMessage);
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = channel.url;
            video.addEventListener('error', () => {
                updateChannelHealth(channel.id, 'poor');
                showError("Native HLS playback is not supported for this stream.")
            });
        }
    }

    function updateNetworkHealth(status) {
        const colors = { good: 'bg-green-500', fair: 'bg-yellow-500', poor: 'bg-red-500' };
        const texts = { good: 'Stable', fair: 'Unstable', poor: 'Poor' };
        
        els.networkDot.className = `w-1.5 h-1.5 rounded-full transition-colors ${colors[status] || 'bg-gray-600'}`;
        els.networkText.textContent = texts[status] || 'Offline';
    }

    function updateFavButtonState() {
        if(!currentChannelId) {
            els.favBtn.classList.add('hidden');
            return;
        }
        els.favBtn.classList.remove('hidden');
        const isFav = favorites.includes(currentChannelId);
        els.favBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-brand-400 text-brand-400' : 'text-gray-500'}"></i>`;
        lucide.createIcons();
    }

    // --- CONTROLS ---
    function buildPlayerControls() {
        // 1. Precise Capability Check
        // We filter native tracks to ignore 'metadata' (id3 tags) and only count actual subtitles/captions.
        let hasCaptions = false;
        
        // Check HLS engine tracks (most reliable for non-Safari)
        if (hls && hls.subtitleTracks && hls.subtitleTracks.length > 0) {
            hasCaptions = true;
        } 
        // Check Native tracks (Safari or native HLS)
        else if (video.textTracks && video.textTracks.length > 0) {
            for (let i = 0; i < video.textTracks.length; i++) {
                const kind = video.textTracks[i].kind;
                // Only accept actual subtitle/caption tracks
                if (kind === 'subtitles' || kind === 'captions') {
                    hasCaptions = true;
                    break;
                }
            }
        }

        const hasAudioTracks = hls && hls.audioTracks.length > 1;

        const controls = [
            { id: 'audio', icon: 'audio-lines', label: 'Audio', visible: hasAudioTracks, onClick: 'showAudioTrackMenu()' },
            { id: 'aspect', icon: 'scan', label: 'Aspect Ratio', visible: true, onClick: 'toggleAspect()' },
            { id: 'snapshot', icon: 'camera', label: 'Snapshot', visible: true, onClick: 'takeSnapshot()' },
            // Visible is now strictly bound to the filtered 'hasCaptions'
            { id: 'captions', icon: 'subtitles', label: 'Captions', visible: hasCaptions, onClick: 'toggleCaptions()' },
            { id: 'pip', icon: 'picture-in-picture-2', label: 'PiP', visible: true, onClick: 'togglePiP()' },
            { id: 'stats', icon: 'bar-chart-2', label: 'Stats', visible: true, onClick: 'toggleStats()' },
        ];

        let desktopHTML = '';
        let mobileHTML = '';
        
        controls.forEach(c => {
            if (c.visible) {
                // Logic: Default is Gray -> White on Hover.
                // Active (Captions On) is Purple -> Light Purple on Hover.
                let colorClasses = 'text-gray-300 hover:text-white'; 
                
                if (c.id === 'captions' && isCaptionsOn) {
                    colorClasses = 'text-brand-400 hover:text-brand-300';
                }

                 desktopHTML += `
                    <div class="relative group/tooltip" id="desktop-btn-${c.id}-container">
                        <button onclick="${c.onClick}" id="desktop-btn-${c.id}" class="${colorClasses} hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95">
                            <i data-lucide="${c.icon}" class="w-5 h-5"></i>
                        </button>
                        <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">${c.label}</span>
                    </div>`;
                
                mobileHTML += `
                     <button onclick="${c.onClick}; closeMobileMenu()" id="mobile-btn-${c.id}" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200">
                        <i data-lucide="${c.icon}" class="w-4 h-4 text-brand-400"></i> ${c.label}
                    </button>`;
            }
        });
        
        els.desktopControls.innerHTML = desktopHTML;
        if (mobileHTML) {
            els.mobileMenuOptions.querySelector('div').innerHTML = mobileHTML;
        }

        lucide.createIcons();
    }
    
    function toggleFullscreen() {
        const container = document.getElementById('videoContainer');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => console.error(err));
            document.getElementById('fsIcon').setAttribute('data-lucide', 'minimize');
        } else {
            document.exitFullscreen();
            document.getElementById('fsIcon').setAttribute('data-lucide', 'maximize');
        }
        setTimeout(lucide.createIcons, 100);
    }
    
    async function togglePiP() {
        try {
            if (video !== document.pictureInPictureElement) {
                await video.requestPictureInPicture();
            } else {
                await document.exitPictureInPicture();
            }
        } catch (error) {
            showToast("PiP is not available or supported.", "error");
        }
    }

    function togglePlay() {
        if(!currentChannelId) return;
        if (video.paused) {
            video.play();
            document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
        } else {
            video.pause();
            document.getElementById('playIcon').setAttribute('data-lucide', 'play');
        }
        lucide.createIcons();
    }

    function setVolume(val) {
        video.volume = val;
        video.muted = val == 0;
        const icon = val == 0 ? 'volume-x' : (val < 0.5 ? 'volume-1' : 'volume-2');
        document.getElementById('volIcon').setAttribute('data-lucide', icon);
        document.querySelector('input[type=range]').value = val;
        lucide.createIcons();
    }

    function toggleMute() {
        if (video.volume > 0) {
            lastVolume = video.volume;
            setVolume(0);
        } else {
            setVolume(lastVolume > 0 ? lastVolume : 1);
        }
    }

    function toggleAspect() {
        currentAspectIndex = (currentAspectIndex + 1) % aspectModes.length;
        const mode = aspectModes[currentAspectIndex];
        video.style.objectFit = mode;
        showToast(`Aspect Ratio: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        
        if (mode === 'contain') {
            els.videoContainer.classList.add('has-blurred-bg');
            startBackgroundLoop();
        } else {
            els.videoContainer.classList.remove('has-blurred-bg');
            stopBackgroundLoop();
        }
    }

    function takeSnapshot() {
        if(video.videoWidth === 0 || !currentChannelId) {
             showToast("Cannot take snapshot, no video playing.", "error");
             return;
        }
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const link = document.createElement('a');
        const channel = channels.find(c => c.id === currentChannelId);
        const name = channel ? channel.name.replace(/ /g, '_') : 'stream';
        link.download = `snapshot_${name}_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showToast("Snapshot saved");
    }

    // --- FULLSCREEN MENU ---
    function toggleFullscreenMenu() {
        isFullscreenMenuOpen = !isFullscreenMenuOpen;
        if (isFullscreenMenuOpen) {
            populateFullscreenMenu();
            els.fullscreenMenu.classList.add('open');
            clearTimeout(inactivityTimer);
        } else {
            els.fullscreenMenu.classList.remove('open');
        }
    }

    function populateFullscreenMenu() {
        const currentList = getCurrentChannelList();
        els.fullscreenMenuList.innerHTML = currentList.map(c => {
            const isActive = c.id === currentChannelId;
            const group = c.group || 'Uncategorized';
            return `
                <div id="fs-channel-item-${c.id}" 
                     onclick="loadChannel('${c.id}'); toggleFullscreenMenu();"
                     class="fs-channel-item flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-colors ${isActive ? 'active bg-brand-500/10' : ''}">
                    <div class="w-10 h-10 rounded-md bg-dark-border flex-shrink-0 flex items-center justify-center overflow-hidden border border-white/5">
                        ${c.logo ? `<img src="${c.logo}" class="w-full h-full object-contain p-0.5" draggable="false">` : '<i data-lucide="tv" class="w-5 h-5 text-gray-500"></i>'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-white truncate text-sm">${c.name}</h4>
                        <p class="text-xs text-gray-400 truncate">${group}</p>
                    </div>
                    ${isActive ? '<i data-lucide="play-circle" class="w-5 h-5 text-brand-400 shrink-0"></i>' : ''}
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    // --- CAPTIONS & AUDIO TRACKS ---
    
    function toggleCaptions(forceState, silent = false) {
        if (typeof forceState === 'boolean') {
            isCaptionsOn = forceState;
        } else {
            isCaptionsOn = !isCaptionsOn;
        }
        
        // Manage Native Tracks
        for (let i = 0; i < video.textTracks.length; i++) {
             video.textTracks[i].mode = isCaptionsOn ? 'showing' : 'hidden';
        }

        // Manage HLS Tracks
        if(hls) {
            hls.subtitleDisplay = isCaptionsOn;
            if (isCaptionsOn && hls.subtitleTrack === -1 && hls.subtitleTracks.length > 0) {
                 hls.subtitleTrack = 0;
            }
        }
        
        // --- VISUAL UPDATE ---
        const desktopBtn = document.getElementById('desktop-btn-captions');
        const mobileBtn = document.getElementById('mobile-btn-captions');

        if (desktopBtn) {
            if (isCaptionsOn) {
                // Enabled State: Remove generic styles, add Brand styles
                desktopBtn.classList.remove('text-gray-300', 'hover:text-white');
                desktopBtn.classList.add('text-brand-400', 'hover:text-brand-300');
            } else {
                // Disabled State: Remove Brand styles, add generic styles
                desktopBtn.classList.remove('text-brand-400', 'hover:text-brand-300');
                desktopBtn.classList.add('text-gray-300', 'hover:text-white');
            }
        }

        if (mobileBtn) {
             mobileBtn.classList.toggle('text-brand-400', isCaptionsOn);
        }

        if (!silent) {
            showToast(`Captions ${isCaptionsOn ? 'ON' : 'OFF'}`);
        }
    }
    
    function setAudioTrack(trackIndex) {
        if (hls && hls.audioTracks[trackIndex]) {
            hls.audioTrack = trackIndex;
            const lang = hls.audioTracks[trackIndex].lang;
            const name = hls.audioTracks[trackIndex].name;
            if (lang) {
                settings.preferredLang = lang;
                saveToLocal();
            }
            showToast(`Audio set to ${name || 'Unknown'}`);
            closeMobileMenu();
        }
    }
    
    function showAudioTrackMenu() {
        if (window.innerWidth < 1024) { 
             if (!mobileMenuOpen) {
                let audioOptionsHTML = '';
                hls.audioTracks.forEach((track, index) => {
                    const isActive = hls.audioTrack === index;
                    audioOptionsHTML += `
                        <button onclick="setAudioTrack(${index})" class="w-full text-left flex items-center justify-between gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm ${isActive ? 'text-brand-300' : 'text-gray-200'}">
                            <span><i data-lucide="audio-lines" class="inline w-4 h-4 mr-3 text-brand-400"></i>${track.name}</span>
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                        </button>`;
                });
                els.mobileMenuOptions.querySelector('div').innerHTML = audioOptionsHTML;
                lucide.createIcons();
                toggleMobileMenu();
            } else {
                toggleMobileMenu();
            }
        } else {
             showToast("Audio track selection is available in the 'More' menu on smaller screens.");
        }
    }


    // --- STATS & EVENTS ---
    function toggleStats() {
        if (els.stats.overlay.classList.contains('hidden')) {
            closeMobileMenu(); 
            els.stats.overlay.classList.remove('hidden');
        } else {
            els.stats.overlay.classList.add('hidden');
        }
    }

    function setupPlayerEvents() {
        let bufferTimeout;
        video.addEventListener('waiting', () => {
            bufferTimeout = setTimeout(() => {
                if (els.error.style.display !== 'none') return;

                els.loading.style.display = 'flex';
                els.loadingTitle.textContent = "Buffering...";
                els.loadingStatus.textContent = "The stream is buffering due to a slow or unstable connection.";
                updateNetworkHealth('fair');
            }, 1000); // Only show buffering message if it's longer than 1 second
        });
        video.addEventListener('playing', () => {
            clearTimeout(bufferTimeout);
            els.loading.style.display = 'none';
            updateNetworkHealth('good');
            updateChannelHealth(currentChannelId, 'good'); // Mark channel as good on successful playback
            document.getElementById('liveBadge').classList.remove('hidden');
            document.getElementById('liveBadge').classList.add('flex');
            document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
            if (aspectModes[currentAspectIndex] === 'contain') {
                startBackgroundLoop();
            }
            lucide.createIcons();
            // Refresh controls in case caption tracks were added late
            buildPlayerControls();
        });
        video.addEventListener('loadedmetadata', () => {
            els.loading.style.display = 'none';
        });
    }

    function updateStats() {
        if (els.stats.overlay.classList.contains('hidden')) return;
        
        if (hls && hls.levels && hls.levels[hls.currentLevel]) {
            const level = hls.levels[hls.currentLevel];
            els.stats.res.textContent = `${level.width}x${level.height}`;
            els.stats.bitrate.textContent = `${(level.bitrate / 1000).toFixed(0)} kbps`;
            els.stats.engine.textContent = "HLS.js (MSE)";
        } else {
             els.stats.res.textContent = `${video.videoWidth}x${video.videoHeight}`;
             els.stats.engine.textContent = "Native";
        }

        if(video.buffered.length) {
            const bufLen = video.buffered.end(video.buffered.length -1) - video.currentTime;
            els.stats.buffer.textContent = `${bufLen.toFixed(2)} sec`;
        }
        
        els.stats.dropped.textContent = video.webkitDroppedFrameCount || video.mozDecodedFrames - video.mozPaintedFrames || 0;
        if(hls && hls.bandwidthEstimate) els.stats.bw.textContent = (hls.bandwidthEstimate / 1000000).toFixed(2) + " Mbps";
        
        const current = channels.find(c => c.id === currentChannelId);
        if(current) els.stats.url.textContent = current.url;
    }

    setInterval(updateStats, 1000);

    // --- HELPERS ---
    function toggleModal(id) {
        const m = document.getElementById(id);
        if (m.classList.contains('hidden')) {
            if(id === 'addChannelModal' && !m.dataset.editing) {
                document.getElementById('channelForm').reset();
                document.getElementById('channelId').value = '';
                document.getElementById('deleteBtnContainer').classList.add('hidden');
                document.getElementById('addChannelTabs').style.display = 'flex';
                updateLogoPreview();
                resetUrlValidation();
                switchAddTab('single');
            }
            delete m.dataset.editing;
            m.classList.remove('hidden');
        } else {
            m.classList.add('hidden');
        }
    }

    function showConfirmation(title, message, onConfirm, type = 'danger') {
        els.confirm.title.textContent = title;
        els.confirm.message.innerHTML = message;

        // Reset button colors and icons for different confirmation types
        if(type === 'danger') {
            els.confirm.icon.innerHTML = `<i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>`;
            els.confirm.icon.className = 'bg-red-500/10 p-4 rounded-full mb-5 ring-1 ring-red-500/20 inline-block';
            els.confirm.okBtn.className = 'flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white transition font-bold shadow-lg shadow-red-500/20 transform active:scale-[0.98]';
        } else { // e.g., 'warning'
             els.confirm.icon.innerHTML = `<i data-lucide="trash-2" class="w-8 h-8 text-yellow-400"></i>`;
             els.confirm.icon.className = 'bg-yellow-500/10 p-4 rounded-full mb-5 ring-1 ring-yellow-500/20 inline-block';
             els.confirm.okBtn.className = 'flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl text-white transition font-bold shadow-lg shadow-yellow-500/20 transform active:scale-[0.98]';
        }
        lucide.createIcons();
        
        // Clone and replace buttons to remove old event listeners
        const newOkBtn = els.confirm.okBtn.cloneNode(true);
        els.confirm.okBtn.parentNode.replaceChild(newOkBtn, els.confirm.okBtn);
        els.confirm.okBtn = newOkBtn;

        const newCancelBtn = els.confirm.cancelBtn.cloneNode(true);
        els.confirm.cancelBtn.parentNode.replaceChild(newCancelBtn, els.confirm.cancelBtn);
        els.confirm.cancelBtn = newCancelBtn;

        els.confirm.okBtn.addEventListener('click', () => {
            onConfirm();
            els.confirm.modal.classList.add('hidden');
        });

        els.confirm.cancelBtn.addEventListener('click', () => {
            els.confirm.modal.classList.add('hidden');
        });

        els.confirm.modal.classList.remove('hidden');
    }

    function editCurrentChannel() {
         if(currentChannelId) editChannel(currentChannelId);
    }

    function editChannel(id) {
        const channel = channels.find(c => c.id === id);
        if(!channel) return;
        
        document.getElementById('addChannelTabs').style.display = 'none';
        switchAddTab('single');
        const m = document.getElementById('addChannelModal');
        m.dataset.editing = "true";
        document.getElementById('channelId').value = channel.id;
        document.getElementById('inpName').value = channel.name;
        document.getElementById('inpUrl').value = channel.url;
        document.getElementById('inpGroup').value = channel.group || '';
        document.getElementById('inpLogo').value = channel.logo || '';
        document.getElementById('modalTitle').textContent = 'Edit Config';
        document.getElementById('deleteBtnContainer').classList.remove('hidden');
        toggleModal('addChannelModal');
        updateLogoPreview();
        validateUrl(channel.url, true); // Force validation on open
    }

    function deleteChannel() {
        const channelId = document.getElementById('channelId').value;
        const channel = channels.find(c => c.id === channelId);
        
        showConfirmation(
            'Delete Channel?',
            `Are you sure you want to permanently remove <strong>${channel.name}</strong>?`,
            () => {
                channels = channels.filter(c => c.id !== channelId);
                favorites = favorites.filter(id => id !== channelId);
                
                saveToLocal();
                renderChannels();
                toggleModal('addChannelModal');
                
                if(currentChannelId === channelId) stopPlayer();
                showToast("Channel removed", "error");
            }
        );
    }
    
    function stopPlayer() {
         if(hls) {
             hls.destroy();
             hls = null;
         }
         video.src = "";
         els.startScreen.style.display = 'flex';
         els.videoContainer.classList.remove('player-active');
         els.videoContainer.classList.remove('has-blurred-bg');
         stopBackgroundLoop();
         els.controlsOverlay.classList.add('ui-hidden');
         els.error.style.display = 'none';
         els.loading.style.display = 'none';
         if(currentChannelId) {
             document.getElementById(`channel-item-${currentChannelId}`)?.classList.remove('active');
         }
         currentChannelId = null;
         document.title = 'SleekrStream';
         document.getElementById('currentChannelName').textContent = "Select Channel";
         document.getElementById('currentChannelGroup').textContent = "--";
         document.getElementById('editBtn').disabled = true;
         document.getElementById('shareBtn').disabled = true;
         document.getElementById('liveBadge').classList.add('hidden');
         updateNetworkHealth('idle');
         updateFavButtonState();
         buildPlayerControls(); 
         closeMobileMenu();
    }

    function retryStream() {
        els.error.style.display = 'none';
        if(currentChannelId) loadChannel(currentChannelId);
    }

    function showError(msg) {
        els.loading.style.display = 'none';
        els.error.style.display = 'flex';
        els.errorMessage.textContent = msg;
        updateNetworkHealth('poor');
    }

    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        const iconContainer = document.getElementById('toastIcon');
        const icon = type === 'success' ? 'check' : 'x-circle';
        const color = type === 'success' ? 'brand' : 'red';

        document.getElementById('toastMsg').textContent = msg;
		iconContainer.innerHTML = `<i data-lucide="${icon}" class="text-${color}-400 w-5 h-5"></i>`;
		iconContainer.className = `bg-${color}-500/20 p-2 rounded-full`;
		lucide.createIcons();
		
		t.classList.remove('-translate-y-32', 'opacity-0');
		setTimeout(() => t.classList.add('-translate-y-32', 'opacity-0'), 3000);
	}
    
    function importExampleChannels() {
        const examples = [
            { id: "nickelodeon", name: "Nickelodeon", url: "http://23.237.104.106:8080/USA_NICKELODEON/index.m3u8", group: "Kids", logo: "https://i.imgur.com/E84jnP8.png" },
            { id: "campsnoopy", name: "Camp Snoopy", url: "https://stream.ads.ottera.tv/playlist.m3u8?network_id=269", group: "Kids", logo: "https://i.imgur.com/8PUbPVU.png" },
            { id: "history", name: "History", url: "https://fl1.moveonjoy.com/history_channel/index.m3u8", group: "Documentary", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/History_%282021%29.svg/512px-History_%282021%29.svg.png" },
            { id: "gameshownetwork", name: "Game Show Network", url: "https://a-cdn.klowdtv.com/live2/gsn_720p/playlist.m3u8", group: "Entertainment", logo: "https://www.gameshownetwork.com/storage/app/media/2020/Navigation/gsn_logo.jpg" },
            { id: "disneychannel", name: "Disney Channel", url: "https://disney.melody.com.ng/Disney/master.m3u8", group: "Kids", logo: "https://upload.wikimedia.org/wikipedia/commons/3/3d/2022_Disney_Channel_logo.svg" },
            { id: "cbs", name: "CBS News", url: "https://cbsn-us.cbsnstream.cbsnews.com/out/v1/55a8648e8f134e82a470f83d51c92330/master.m3u8", group: "News", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/CBS_logo_%282020%29.svg/512px-CBS_logo_%282020%29.svg.png" },
            { id: "e!", name: "E! Entertainment", url: "https://vid.melody.com.ng/E/master.m3u8", group: "Entertainment", logo: "https://images.seeklogo.com/logo-png/20/2/e-entertainment-logo-png_seeklogo-209325.png" },
            { id: "babyshark", name: "Baby Shark", url: "https://newidco-babysharktv-1-eu.rakuten.wurl.tv/playlist.m3u8", group: "Kids", logo: "https://i.imgur.com/SbBKr8L.png" },
            { id: "disneyxd", name: "Disney XD", url: "http://fl1.moveonjoy.com/DISNEY_XD/index.m3u8", group: "Kids", logo: "https://upload.wikimedia.org/wikipedia/commons/a/a8/2015_Disney_XD_logo.svg" },
            { id: "comet", name: "Comet", url: "https://fast-channels.sinclairstoryline.com/COMET/index.m3u8", group: "Sci-Fi", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Comet_logo.svg/512px-Comet_logo.svg.png" }
        ];
        
        let count = 0;
        examples.forEach(ex => {
            if(!channels.some(c => c.url === ex.url)) {
                channels.push({...ex, id: Date.now() + Math.random().toString(), health: 'unchecked' });
                count++;
            }
        });
        saveToLocal();
        renderChannels();
        showToast(`Loaded ${count} demo channels`);
    }

    // --- CHANNEL SHARING ---
    async function shareCurrentChannel() {
        if (!currentChannelId) return;
        const channel = channels.find(c => c.id === currentChannelId);
        if (!channel) return;

        const shareableChannel = {
            name: channel.name,
            url: channel.url,
            group: channel.group,
            logo: channel.logo
        };

        try {
            const jsonString = JSON.stringify(shareableChannel);
            const base64Data = btoa(jsonString);
            const shareUrl = `${window.location.origin}${window.location.pathname}#share=${base64Data}`;

            if (navigator.share) {
                await navigator.share({
                    title: `Watch ${channel.name} on SleekrStream`,
                    text: `Check out this stream: ${channel.name}`,
                    url: shareUrl
                });
            } else {
                await navigator.clipboard.writeText(shareUrl);
                showToast("Share link copied to clipboard!");
            }
        } catch (err) {
            console.error("Sharing failed:", err);
            showToast("Could not generate share link.", "error");
        }
    }

    function handleIncomingShareLink() {
        if (window.location.hash.startsWith('#share=')) {
            const base64Data = window.location.hash.substring(7);
            try {
                const jsonString = atob(base64Data);
                const channelData = JSON.parse(jsonString);

                if (channelData && channelData.name && channelData.url) {
                    showShareConfirmation(channelData);
                } else {
                    showToast("Invalid share link data.", "error");
                }
            } catch (e) {
                console.error("Error parsing share link:", e);
                showToast("Could not read the share link.", "error");
            } finally {
                history.replaceState(null, document.title, window.location.pathname + window.location.search);
            }
        }
    }

    function showShareConfirmation(channelData) {
        sharedChannelData = channelData;
        const modal = document.getElementById('shareConfirmModal');
        
        document.getElementById('shareName').textContent = channelData.name || 'Unknown Channel';
        document.getElementById('shareGroup').textContent = channelData.group || 'Uncategorized';
        document.getElementById('shareUrl').textContent = channelData.url || 'No URL provided';
        
        const logoContainer = document.getElementById('shareLogo');
        if (channelData.logo) {
            logoContainer.innerHTML = `<img src="${channelData.logo}" class="w-full h-full object-contain p-1" draggable="false">`;
        } else {
            logoContainer.innerHTML = `<i data-lucide="tv" class="w-8 h-8 text-gray-500"></i>`;
            lucide.createIcons();
        }

        document.getElementById('addSharedBtn').onclick = addSharedChannel;
        modal.classList.remove('hidden');
    }

    function closeShareConfirm() {
        document.getElementById('shareConfirmModal').classList.add('hidden');
        sharedChannelData = null;
    }

    function addSharedChannel() {
        if (!sharedChannelData) return;

        if (channels.some(c => c.url === sharedChannelData.url)) {
            showToast(`${sharedChannelData.name} is already in your list.`, 'error');
            closeShareConfirm();
            return;
        }

        const newChannel = {
            id: Date.now().toString(),
            name: sharedChannelData.name,
            url: sharedChannelData.url,
            group: sharedChannelData.group || 'Uncategorized',
            logo: sharedChannelData.logo || '',
            health: 'unchecked'
        };

        channels.push(newChannel);
        saveToLocal();
        renderChannels();
        showToast(`Added "${newChannel.name}" to your list!`);
        closeShareConfirm();
    }
    
    // --- PLAYLIST IMPORT WORKER ---
    function handlePlaylistImport(event) {
        event.preventDefault();
        const urls = document.getElementById('inpM3uUrl').value.split(',')
            .map(url => url.trim())
            .filter(url => url.length > 0);

        if (urls.length === 0) {
            showToast("Please enter at least one valid M3U Playlist URL.", "error");
            return;
        }
        
        const smartCleanup = document.getElementById('inpSmartCleanup').checked;
        
        toggleModal('addChannelModal');
        
        importQueue = urls.map(url => ({ m3uUrl: url, smartCleanup }));
        totalImportCount = importQueue.length;
        totalKept = 0;
        totalRemoved = 0;

        processImportQueue();
    }

    function processImportQueue() {
        if (importQueue.length === 0) {
            if (totalImportCount > 0) {
                finishImportQueue();
            }
            return;
        }

        const options = importQueue.shift();
        startImport(options);
    }

    function startImport(options) {
        if (importWorker) {
            showToast("An import is already in progress.", "error");
            toggleModal('importProgressModal');
            return;
        }
        
        const workerScript = `
            self.onmessage = async (e) => {
                const { m3uUrl, smartCleanup, existingUrls } = e.data;
                try {
                    const response = await fetch(m3uUrl);
                    if (!response.ok) throw new Error('Failed to fetch playlist');
                    const playlistText = await response.text();
                    
                    const lines = playlistText.split('\\n');
                    const channels = [];

                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].startsWith('#EXTINF:')) {
                            const info = lines[i];
                            let url = lines[++i]?.trim();

                            if (!url || !url.startsWith('http')) continue;

                            // Handle potential carriage returns
                            url = url.replace(/\\r$/, '');

                            const nameMatch = info.match(/,(.*)/);
                            const name = nameMatch ? nameMatch[1].trim().replace(/\\r$/, '') : 'Unknown';
                            
                            const logoMatch = info.match(/tvg-logo="([^"]*)"/);
                            const logo = logoMatch ? logoMatch[1] : '';

                            const groupMatch = info.match(/group-title="([^"]*)"/);
                            const group = groupMatch ? groupMatch[1] : 'Uncategorized';

                            channels.push({ name, url, logo, group });
                        }
                    }

                    const uniqueChannels = channels.filter(c => !existingUrls.has(c.url));
                    const totalToProcess = uniqueChannels.length;
                    const finalChannels = [];
                    let kept = 0;
                    let removed = 0;

                    for (let i = 0; i < totalToProcess; i++) {
                        const channel = uniqueChannels[i];
                        let isReachable = true;

                        if (smartCleanup) {
                            try {
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 4000);
                                await fetch(channel.url, { method: 'HEAD', mode: 'no-cors', signal: controller.signal });
                                clearTimeout(timeoutId);
                                isReachable = true;
                            } catch (err) {
                                isReachable = false;
                            }
                        }
                        
                        if (!smartCleanup || isReachable) {
                             finalChannels.push({
                                id: Date.now().toString() + Math.random(),
                                ...channel,
                                health: 'unchecked'
                            });
                            kept++;
                        } else {
                            removed++;
                        }
                        
                        if (i % 20 === 0 || i === totalToProcess - 1) {
                             self.postMessage({ type: 'progress', kept, removed, total: totalToProcess });
                        }
                    }

                    self.postMessage({ type: 'complete', channels: finalChannels, kept, removed });

                } catch (error) {
                    self.postMessage({ type: 'error', message: error.message });
                }
            };
        `;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        importWorker = new Worker(URL.createObjectURL(blob));

        if (totalImportCount <= 1) {
            resetImportProgressUI();
            toggleModal('importProgressModal');
        } else {
            const currentImportNum = totalImportCount - importQueue.length;
            els.importProgress.queueStatus.textContent = `Importing playlist ${currentImportNum} of ${totalImportCount}...`;
            els.importProgress.queueStatus.classList.remove('hidden');
        }

        importWorker.onmessage = (e) => {
            const { type, ...data } = e.data;
            switch(type) {
                case 'progress':
                    updateImportProgress(data);
                    break;
                case 'complete':
                    finishSingleImport(data);
                    break;
                case 'error':
                    showToast(`Import failed: ${data.message}`, 'error');
                    cancelImport();
                    break;
            }
        };

        const existingUrls = new Set(channels.map(c => c.url));
        importWorker.postMessage({ ...options, existingUrls });
    }

    function resetImportProgressUI() {
        const p = els.importProgress;
        const smartCleanup = document.getElementById('inpSmartCleanup').checked;
        p.title.textContent = "Importing Playlist...";
        p.status.textContent = "Parsing and validating channels. This may take a few moments...";
        p.queueStatus.classList.add('hidden');
        p.percent.textContent = "0%";
        p.bar.style.width = "0%";
        p.kept.textContent = "0";
        p.removed.textContent = "0";
        // Update label based on the checkbox state
        p.removed.nextElementSibling.textContent = smartCleanup ? "Channels Discarded" : "Channels Marked Poor";
        p.hideBtn.classList.remove('hidden');
        p.cancelBtn.classList.remove('hidden');
        p.doneBtn.classList.add('hidden');
        p.footer.classList.remove('hidden');
        p.footer.classList.add('flex');
        p.defaultFooter.classList.add('hidden');
    }

    function updateImportProgress({ kept, removed, total }) {
        const p = els.importProgress;
        const processed = kept + removed;
        const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;
        
        p.percent.textContent = `${percentage}%`;
        p.bar.style.width = `${percentage}%`;
        p.kept.textContent = totalKept + kept;
        p.removed.textContent = totalRemoved + removed;
        p.footerText.textContent = `${percentage}% (${processed}/${total})`;
    }

    function finishSingleImport({ channels: newChannels, kept, removed }) {
        if (importWorker) {
            importWorker.terminate();
            importWorker = null;
        }

        totalKept += kept;
        totalRemoved += removed;

        channels.push(...newChannels);
        saveToLocal();
        renderChannels();
        
        processImportQueue();
    }

    function finishImportQueue() {
        const p = els.importProgress;
        p.title.textContent = "Import Complete!";
        const smartCleanup = document.getElementById('inpSmartCleanup').checked;
        const removedText = smartCleanup ? `Discarded ${totalRemoved} unreachable streams.` : `Added ${totalRemoved} streams marked as 'Poor' health.`;
        p.status.textContent = `Successfully added ${totalKept} new channels. ${removedText}`;

        p.queueStatus.classList.add('hidden');
        p.hideBtn.classList.add('hidden');
        p.cancelBtn.classList.add('hidden');
        p.doneBtn.classList.remove('hidden');
        
        totalImportCount = 0; // Reset for next time

        setTimeout(() => {
            p.footer.classList.add('hidden');
            p.footer.classList.remove('flex');
            p.defaultFooter.classList.remove('hidden');
        }, 500);
    }
    
    function cancelImport() {
        if(importWorker) {
            importWorker.terminate();
            importWorker = null;
        }
        importQueue = [];
        totalImportCount = 0;
        showToast("Import cancelled.", "error");
        toggleModal('importProgressModal');
        els.importProgress.footer.classList.add('hidden');
        els.importProgress.defaultFooter.classList.remove('hidden');
    }

    // --- DATA MANAGEMENT ---
    function exportPlaylists() {
        const data = {
            channels: channels,
            favorites: favorites,
            settings: settings
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sleekrstream_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Playlist exported successfully!');
    }

    function initiateImport() {
        document.getElementById('importFile').click();
    }

    function importPlaylists(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.channels || !Array.isArray(data.channels)) {
                    throw new Error('Invalid file format: "channels" array not found.');
                }
                
                const existingUrls = new Set(channels.map(c => c.url));
                let importedCount = 0;

                data.channels.forEach(newChannel => {
                    if (newChannel.url && !existingUrls.has(newChannel.url)) {
                        channels.push({
                            id: newChannel.id || Date.now().toString() + Math.random(),
                            name: newChannel.name,
                            url: newChannel.url,
                            group: newChannel.group,
                            logo: newChannel.logo,
                            health: newChannel.health || 'unchecked'
                        });
                        existingUrls.add(newChannel.url);
                        importedCount++;
                    }
                });

                if (data.favorites && Array.isArray(data.favorites)) {
                    const favSet = new Set([...favorites, ...data.favorites]);
                    favorites = Array.from(favSet);
                }

                if (data.settings) {
                    settings = {...settings, ...data.settings};
                }

                saveToLocal();
                renderChannels();
                showToast(`Successfully merged ${importedCount} new channels.`);

            } catch (error) {
                showToast(`Import failed: ${error.message}`, 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }
    
    function deletePoorChannels() {
        const poorChannels = channels.filter(c => c.health === 'poor');
        if (poorChannels.length === 0) {
            showToast("No channels are marked as 'Poor'. Run a health scan first.", "error");
            return;
        }

        showConfirmation(
            'Delete Poor Channels?',
            `This will permanently remove <strong>${poorChannels.length}</strong> channel(s) marked with 'Poor' health. This action cannot be undone.`,
            () => {
                const poorChannelIds = new Set(poorChannels.map(c => c.id));
                channels = channels.filter(c => c.health !== 'poor');
                favorites = favorites.filter(id => !poorChannelIds.has(id));

                if (poorChannelIds.has(currentChannelId)) {
                    stopPlayer();
                }

                saveToLocal();
                renderChannels();
                toggleModal('settingsModal');
                showToast(`Removed ${poorChannels.length} poor-health channels.`, 'success');
            },
            'warning' 
        );
    }
    
    function resetAllData() {
        showConfirmation(
            'Reset All Data?',
            'This is irreversible. All your channels and favorites will be permanently deleted. Are you absolutely sure?',
            () => {
                channels = [];
                favorites = [];
                stopPlayer();
                saveToLocal();
                renderChannels();
                toggleModal('settingsModal');
                showToast("All data has been cleared", "error");
            }
        );
    }
    
    // --- SINGLE STREAM URL VALIDATION ---
    function setupUrlValidation() {
        els.inpUrl.addEventListener('input', (e) => {
            clearTimeout(urlValidationTimeout);
            const url = e.target.value;
            if (!url) {
                resetUrlValidation();
                return;
            }
            // Show spinner immediately for better UX
            setValidationState('loading');
            urlValidationTimeout = setTimeout(() => {
                validateUrl(url);
            }, 500); // Debounce
        });
    }

    function resetUrlValidation() {
        setValidationState('none');
        els.urlValidationMessage.textContent = '';
        els.saveChannelBtn.disabled = false;
        els.inpUrl.classList.remove('border-red-500/50', 'border-green-500/50');
    }

    async function validateUrl(url, isInitial = false) {
        const urlRegex = /^(https?:\/\/[^\s$.?#].[^\s]*)$/i;
        if (!urlRegex.test(url)) {
            setValidationState('error', 'Invalid URL format.');
            return;
        }

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 4000);
            await fetch(url, { method: 'HEAD', signal: controller.signal, mode: 'no-cors' });
            clearTimeout(timeoutId);
            setValidationState('success', 'URL appears valid. Playability will be confirmed on save.');
        } catch (error) {
             if (isInitial) {
                 setValidationState('error', 'Could not reach URL. It might be offline.');
             } else {
                 setValidationState('error', 'Could not reach URL. Check the link or try again.');
             }
        }
    }
    
    function setValidationState(state, message = '') {
        const statusEl = els.urlValidationStatus;
        const msgEl = els.urlValidationMessage;
        const inputEl = els.inpUrl;
        const saveBtn = els.saveChannelBtn;

        statusEl.innerHTML = '';
        inputEl.classList.remove('border-red-500/50', 'border-green-500/50');
        msgEl.className = 'text-xs mt-1.5 ml-1 h-3'; // Reset classes

        switch(state) {
            case 'loading':
                statusEl.innerHTML = `<div class="tiny-loader"></div>`;
                saveBtn.disabled = true;
                break;
            case 'success':
                statusEl.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-green-500"></i>`;
                msgEl.textContent = message;
                msgEl.classList.add('text-green-500/80');
                inputEl.classList.add('border-green-500/50');
                saveBtn.disabled = false;
                lucide.createIcons();
                break;
            case 'error':
                 statusEl.innerHTML = `<i data-lucide="x" class="w-5 h-5 text-red-500"></i>`;
                 msgEl.textContent = message;
                 msgEl.classList.add('text-red-400/80');
                 inputEl.classList.add('border-red-500/50');
                 saveBtn.disabled = true;
                 lucide.createIcons();
                break;
            case 'none':
			default:
				const name = document.getElementById('inpName').value.trim();
				const url = document.getElementById('inpUrl').value.trim();
				saveBtn.disabled = !(name && url);
				break;
        }
    }


    // --- BROWSE PLAYLISTS MODAL LOGIC ---
    function switchBrowseTab(tabName) {
        currentBrowseTab = tabName;
        document.querySelectorAll('.browse-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`browse-tab-${tabName}`).classList.add('active');
        document.getElementById('browseSearchInput').value = '';
        renderBrowsePlaylists();
    }

    function renderBrowsePlaylists() {
        const container = document.getElementById('browsePlaylistsContent');
        const query = document.getElementById('browseSearchInput').value.toLowerCase();
        let data = [];
        
        switch(currentBrowseTab) {
            case 'category': data = publicPlaylists.categories; break;
            case 'language': data = publicPlaylists.languages; break;
            case 'country': data = publicPlaylists.countries; break;
            case 'region': data = publicPlaylists.regions; break;
        }

        const filteredData = data.filter(item => item.name.toLowerCase().includes(query));

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">';
        filteredData.forEach(item => {
            html += `
                <div class="bg-dark-bg border border-dark-border rounded-xl p-4 flex flex-col justify-between hover:border-brand-500/50 hover:bg-dark-light transition-all group">
                    <div>
                        <div class="flex justify-between items-start">
                             <h4 class="font-bold text-white mb-1 pr-2">${item.name}</h4>
                             <span class="text-xs font-mono bg-dark-surface px-2 py-1 rounded-md text-brand-300 border border-dark-light">${item.channels} ch</span>
                        </div>
                        <p class="text-xs text-gray-500 font-mono break-all opacity-80 group-hover:opacity-100">${item.url}</p>
                    </div>
                    <button onclick="selectPublicPlaylist('${item.url}')" class="mt-4 w-full text-center text-sm font-semibold bg-dark-border hover:bg-brand-600 text-gray-300 hover:text-white rounded-lg py-2 transition-colors active:scale-95">
                        Add URL
                    </button>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        if(filteredData.length === 0){
             container.innerHTML = `<div class="text-center text-gray-500 pt-10"><i data-lucide="search-x" class="w-10 h-10 mx-auto mb-3 opacity-30"></i><p>No results found.</p></div>`;
             lucide.createIcons();
        }
    }

    function selectPublicPlaylist(url) {
        const input = document.getElementById('inpM3uUrl');
        if (input.value.trim().length > 0) {
            input.value += `, ${url}`;
        } else {
            input.value = url;
        }
        toggleModal('browsePlaylistsModal');
        showToast('Playlist URL added!', 'success');
    }

// --- PUBLIC PLAYLIST DATA ---
const publicPlaylists = {
    categories: [
        { name: 'Auto', channels: '15', url: 'https://iptv-org.github.io/iptv/categories/auto.m3u' },
        { name: 'Animation', channels: '45', url: 'https://iptv-org.github.io/iptv/categories/animation.m3u' },
        { name: 'Business', channels: '49', url: 'https://iptv-org.github.io/iptv/categories/business.m3u' },
        { name: 'Classic', channels: '53', url: 'https://iptv-org.github.io/iptv/categories/classic.m3u' },
        { name: 'Comedy', channels: '51', url: 'https://iptv-org.github.io/iptv/categories/comedy.m3u' },
        { name: 'Cooking', channels: '21', url: 'https://iptv-org.github.io/iptv/categories/cooking.m3u' },
        { name: 'Culture', channels: '52', url: 'https://iptv-org.github.io/iptv/categories/culture.m3u' },
        { name: 'Documentary', channels: '59', url: 'https://iptv-org.github.io/iptv/categories/documentary.m3u' },
        { name: 'Education', channels: '109', url: 'https://iptv-org.github.io/iptv/categories/education.m3u' },
        { name: 'Entertainment', channels: '283', url: 'https://iptv-org.github.io/iptv/categories/entertainment.m3u' },
        { name: 'Family', channels: '38', url: 'https://iptv-org.github.io/iptv/categories/family.m3u' },
        { name: 'General', channels: '847', url: 'https://iptv-org.github.io/iptv/categories/general.m3u' },
        { name: 'Kids', channels: '174', url: 'https://iptv-org.github.io/iptv/categories/kids.m3u' },
        { name: 'Legislative', channels: '127', url: 'https://iptv-org.github.io/iptv/categories/legislative.m3u' },
        { name: 'Lifestyle', channels: '70', url: 'https://iptv-org.github.io/iptv/categories/lifestyle.m3u' },
        { name: 'Movies', channels: '265', url: 'https://iptv-org.github.io/iptv/categories/movies.m3u' },
        { name: 'Music', channels: '396', url: 'https://iptv-org.github.io/iptv/categories/music.m3u' },
        { name: 'News', channels: '502', url: 'https://iptv-org.github.io/iptv/categories/news.m3u' },
        { name: 'Outdoor', channels: '42', url: 'https://iptv-org.github.io/iptv/categories/outdoor.m3u' },
        { name: 'Relax', channels: '15', url: 'https://iptv-org.github.io/iptv/categories/relax.m3u' },
        { name: 'Religious', channels: '310', url: 'https://iptv-org.github.io/iptv/categories/religious.m3u' },
        { name: 'Series', channels: '166', url: 'https://iptv-org.github.io/iptv/categories/series.m3u' },
        { name: 'Science', channels: '23', url: 'https://iptv-org.github.io/iptv/categories/science.m3u' },
        { name: 'Shop', channels: '70', url: 'https://iptv-org.github.io/iptv/categories/shop.m3u' },
        { name: 'Sports', channels: '185', url: 'https://iptv-org.github.io/iptv/categories/sports.m3u' },
        { name: 'Travel', channels: '29', url: 'https://iptv-org.github.io/iptv/categories/travel.m3u' },
        { name: 'Weather', channels: '14', url: 'https://iptv-org.github.io/iptv/categories/weather.m3u' },
        { name: 'Undefined', channels: '4650', url: 'https://iptv-org.github.io/iptv/categories/undefined.m3u' }
    ],
    languages: [
        { name: 'Albanian', channels: '59', url: 'https://iptv-org.github.io/iptv/languages/sqi.m3u' },
        { name: 'Amharic', channels: '8', url: 'https://iptv-org.github.io/iptv/languages/amh.m3u' },
        { name: 'Arabic', channels: '328', url: 'https://iptv-org.github.io/iptv/languages/ara.m3u' },
        { name: 'Armenian', channels: '28', url: 'https://iptv-org.github.io/iptv/languages/hye.m3u' },
        { name: 'Assamese', channels: '2', url: 'https://iptv-org.github.io/iptv/languages/asm.m3u' },
        { name: 'Assyrian Neo-Aramaic', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/aii.m3u' },
        { name: 'Azerbaijani', channels: '23', url: 'https://iptv-org.github.io/iptv/languages/aze.m3u' },
        { name: 'Bashkir', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/bak.m3u' },
        { name: 'Basque', channels: '6', url: 'https://iptv-org.github.io/iptv/languages/eus.m3u' },
        { name: 'Belarusian', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/bel.m3u' },
        { name: 'Bengali', channels: '36', url: 'https://iptv-org.github.io/iptv/languages/ben.m3u' },
        { name: 'Bosnian', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/bos.m3u' },
        { name: 'Bulgarian', channels: '27', url: 'https://iptv-org.github.io/iptv/languages/bul.m3u' },
        { name: 'Burmese', channels: '16', url: 'https://iptv-org.github.io/iptv/languages/mya.m3u' },
        { name: 'Catalan', channels: '30', url: 'https://iptv-org.github.io/iptv/languages/cat.m3u' },
        { name: 'Chinese', channels: '185', url: 'https://iptv-org.github.io/iptv/languages/zho.m3u' },
        { name: 'Croatian', channels: '13', url: 'https://iptv-org.github.io/iptv/languages/hrv.m3u' },
        { name: 'Czech', channels: '31', url: 'https://iptv-org.github.io/iptv/languages/ces.m3u' },
        { name: 'Danish', channels: '13', url: 'https://iptv-org.github.io/iptv/languages/dan.m3u' },
        { name: 'Dhivehi', channels: '2', url: 'https://iptv-org.github.io/iptv/languages/div.m3u' },
        { name: 'Dimili', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/zza.m3u' },
        { name: 'Dutch', channels: '115', url: 'https://iptv-org.github.io/iptv/languages/nld.m3u' },
        { name: 'English', channels: '2016', url: 'https://iptv-org.github.io/iptv/languages/eng.m3u' },
        { name: 'Estonian', channels: '6', url: 'https://iptv-org.github.io/iptv/languages/est.m3u' },
        { name: 'Faroese', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/fao.m3u' },
        { name: 'Fataleka', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/far.m3u' },
        { name: 'Finnish', channels: '23', url: 'https://iptv-org.github.io/iptv/languages/fin.m3u' },
        { name: 'French', channels: '243', url: 'https://iptv-org.github.io/iptv/languages/fra.m3u' },
        { name: 'Galician', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/glg.m3u' },
        { name: 'Galolen', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/gal.m3u' },
        { name: 'Georgian', channels: '8', url: 'https://iptv-org.github.io/iptv/languages/kat.m3u' },
        { name: 'German', channels: '261', url: 'https://iptv-org.github.io/iptv/languages/deu.m3u' },
        { name: 'Greek', channels: '91', url: 'https://iptv-org.github.io/iptv/languages/ell.m3u' },
        { name: 'Greenlandic', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/kal.m3u' },
        { name: 'Gujarati', channels: '2', url: 'https://iptv-org.github.io/iptv/languages/guj.m3u' },
        { name: 'Hebrew', channels: '10', url: 'https://iptv-org.github.io/iptv/languages/heb.m3u' },
        { name: 'Hindi', channels: '54', url: 'https://iptv-org.github.io/iptv/languages/hin.m3u' },
        { name: 'Hungarian', channels: '74', url: 'https://iptv-org.github.io/iptv/languages/hun.m3u' },
        { name: 'Icelandic', channels: '4', url: 'https://iptv-org.github.io/iptv/languages/isl.m3u' },
        { name: 'Indonesian', channels: '137', url: 'https://iptv-org.github.io/iptv/languages/ind.m3u' },
        { name: 'Inuktitut', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/iku.m3u' },
        { name: 'Irish', channels: '4', url: 'https://iptv-org.github.io/iptv/languages/gle.m3u' },
        { name: 'Italian', channels: '325', url: 'https://iptv-org.github.io/iptv/languages/ita.m3u' },
        { name: 'Japanese', channels: '51', url: 'https://iptv-org.github.io/iptv/languages/jpn.m3u' },
        { name: 'Javanese', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/jav.m3u' },
        { name: 'Kannada', channels: '5', url: 'https://iptv-org.github.io/iptv/languages/kan.m3u' },
        { name: 'Kazakh', channels: '15', url: 'https://iptv-org.github.io/iptv/languages/kaz.m3u' },
        { name: 'Khmer', channels: '12', url: 'https://iptv-org.github.io/iptv/languages/khm.m3u' },
        { name: 'Kinyarwanda', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/kin.m3u' },
        { name: 'Korean', channels: '86', url: 'https://iptv-org.github.io/iptv/languages/kor.m3u' },
        { name: 'Kurdish', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/kur.m3u' },
        { name: 'Lao', channels: '9', url: 'https://iptv-org.github.io/iptv/languages/lao.m3u' },
        { name: 'Latvian', channels: '10', url: 'https://iptv-org.github.io/iptv/languages/lav.m3u' },
        { name: 'Letzeburgesch', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/ltz.m3u' },
        { name: 'Lithuanian', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/lit.m3u' },
        { name: 'Macedonian', channels: '34', url: 'https://iptv-org.github.io/iptv/languages/mkd.m3u' },
        { name: 'Malay', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/msa.m3u' },
        { name: 'Malayalam', channels: '40', url: 'https://iptv-org.github.io/iptv/languages/mal.m3u' },
        { name: 'Maltese', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/mlt.m3u' },
        { name: 'Mandarin Chinese', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/cmn.m3u' },
        { name: 'Marathi', channels: '2', url: 'https://iptv-org.github.io/iptv/languages/mar.m3u' },
        { name: 'Min Nan Chinese', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/nan.m3u' },
        { name: 'Mongolian', channels: '17', url: 'https://iptv-org.github.io/iptv/languages/mon.m3u' },
        { name: 'Nepali', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/nep.m3u' },
        { name: 'Norwegian', channels: '7', url: 'https://iptv-org.github.io/iptv/languages/nor.m3u' },
        { name: 'Norwegian Bokmål', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/nob.m3u' },
        { name: 'Oriya', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/ori.m3u' },
        { name: 'Oromo', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/orm.m3u' },
        { name: 'Panjabi', channels: '5', url: 'https://iptv-org.github.io/iptv/languages/pan.m3u' },
        { name: 'Papiamento', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/pap.m3u' },
        { name: 'Pashto', channels: '12', url: 'https://iptv-org.github.io/iptv/languages/pus.m3u' },
        { name: 'Persian', channels: '60', url: 'https://iptv-org.github.io/iptv/languages/fas.m3u' },
        { name: 'Polish', channels: '51', url: 'https://iptv-org.github.io/iptv/languages/pol.m3u' },
        { name: 'Portuguese', channels: '328', url: 'https://iptv-org.github.io/iptv/languages/por.m3u' },
        { name: 'Romanian', channels: '117', url: 'https://iptv-org.github.io/iptv/languages/ron.m3u' },
        { name: 'Romany', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/rom.m3u' },
        { name: 'Russian', channels: '284', url: 'https://iptv-org.github.io/iptv/languages/rus.m3u' },
        { name: 'Serbian', channels: '79', url: 'https://iptv-org.github.io/iptv/languages/srp.m3u' },
        { name: 'Serbo-Croatian', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/hbs.m3u' },
        { name: 'Sindhi', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/snd.m3u' },
        { name: 'Sinhala', channels: '4', url: 'https://iptv-org.github.io/iptv/languages/sin.m3u' },
        { name: 'Slovak', channels: '39', url: 'https://iptv-org.github.io/iptv/languages/slk.m3u' },
        { name: 'Slovenian', channels: '11', url: 'https://iptv-org.github.io/iptv/languages/slv.m3u' },
        { name: 'Somali', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/som.m3u' },
        { name: 'Spanish', channels: '1623', url: 'https://iptv-org.github.io/iptv/languages/spa.m3u' },
        { name: 'Swahili', channels: '2', url: 'https://iptv-org.github.io/iptv/languages/swa.m3u' },
        { name: 'Swedish', channels: '16', url: 'https://iptv-org.github.io/iptv/languages/swe.m3u' },
        { name: 'Tagalog', channels: '9', url: 'https://iptv-org.github.io/iptv/languages/tgl.m3u' },
        { name: 'Tajik', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/tgk.m3u' },
        { name: 'Tamil', channels: '35', url: 'https://iptv-org.github.io/iptv/languages/tam.m3u' },
        { name: 'Telugu', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/tel.m3u' },
        { name: 'Tetum', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/tet.m3u' },
        { name: 'Thai', channels: '68', url: 'https://iptv-org.github.io/iptv/languages/tha.m3u' },
        { name: 'Turkish', channels: '197', url: 'https://iptv-org.github.io/iptv/languages/tur.m3u' },
        { name: 'Turkmen', channels: '7', url: 'https://iptv-org.github.io/iptv/languages/tuk.m3u' },
        { name: 'Ukrainian', channels: '48', url: 'https://iptv-org.github.io/iptv/languages/ukr.m3u' },
        { name: 'Urdu', channels: '24', url: 'https://iptv-org.github.io/iptv/languages/urd.m3u' },
        { name: 'Uzbek', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/uzb.m3u' },
        { name: 'Vietnamese', channels: '56', url: 'https://iptv-org.github.io/iptv/languages/vie.m3u' },
        { name: 'Welsh', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/cym.m3u' },
        { name: 'Western Frisian', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/fry.m3u' },
        { name: 'Wolof', channels: '3', url: 'https://iptv-org.github.io/iptv/languages/wol.m3u' },
        { name: 'Yucatec Maya', channels: '1', url: 'https://iptv-org.github.io/iptv/languages/yua.m3u' },
        { name: 'Yue Chinese', channels: '10', url: 'https://iptv-org.github.io/iptv/languages/yue.m3u' },
        { name: 'Undefined', channels: '1238', url: 'https://iptv-org.github.io/iptv/languages/undefined.m3u' }
    ],
    countries: [
        { name: 'Afghanistan', channels: '19', url: 'https://iptv-org.github.io/iptv/countries/af.m3u' },
        { name: 'Albania', channels: '38', url: 'https://iptv-org.github.io/iptv/countries/al.m3u' },
        { name: 'Algeria', channels: '42', url: 'https://iptv-org.github.io/iptv/countries/dz.m3u' },
        { name: 'American Samoa', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/as.m3u' },
        { name: 'Andorra', channels: '17', url: 'https://iptv-org.github.io/iptv/countries/ad.m3u' },
        { name: 'Angola', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/ao.m3u' },
        { name: 'Anguilla', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/ai.m3u' },
        { name: 'Antigua and Barbuda', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/ag.m3u' },
        { name: 'Argentina', channels: '282', url: 'https://iptv-org.github.io/iptv/countries/ar.m3u' },
        { name: 'Armenia', channels: '40', url: 'https://iptv-org.github.io/iptv/countries/am.m3u' },
        { name: 'Aruba', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/aw.m3u' },
        { name: 'Australia', channels: '39', url: 'https://iptv-org.github.io/iptv/countries/au.m3u' },
        { name: 'Austria', channels: '48', url: 'https://iptv-org.github.io/iptv/countries/at.m3u' },
        { name: 'Azerbaijan', channels: '34', url: 'https://iptv-org.github.io/iptv/countries/az.m3u' },
        { name: 'Bahamas', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/bs.m3u' },
        { name: 'Bahrain', channels: '37', url: 'https://iptv-org.github.io/iptv/countries/bh.m3u' },
        { name: 'Bangladesh', channels: '25', url: 'https://iptv-org.github.io/iptv/countries/bd.m3u' },
        { name: 'Barbados', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/bb.m3u' },
        { name: 'Belarus', channels: '38', url: 'https://iptv-org.github.io/iptv/countries/by.m3u' },
        { name: 'Belgium', channels: '59', url: 'https://iptv-org.github.io/iptv/countries/be.m3u' },
        { name: 'Belize', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/bz.m3u' },
        { name: 'Benin', channels: '13', url: 'https://iptv-org.github.io/iptv/countries/bj.m3u' },
        { name: 'Bermuda', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/bm.m3u' },
        { name: 'Bhutan', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/bt.m3u' },
        { name: 'Bolivia', channels: '85', url: 'https://iptv-org.github.io/iptv/countries/bo.m3u' },
        { name: 'Bosnia and Herzegovina', channels: '29', url: 'https://iptv-org.github.io/iptv/countries/ba.m3u' },
        { name: 'Botswana', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/bw.m3u' },
        { name: 'Bouvet Island', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/bv.m3u' },
        { name: 'Brazil', channels: '303', url: 'https://iptv-org.github.io/iptv/countries/br.m3u' },
        { name: 'British Virgin Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/vg.m3u' },
        { name: 'Brunei', channels: '32', url: 'https://iptv-org.github.io/iptv/countries/bn.m3u' },
        { name: 'Bulgaria', channels: '34', url: 'https://iptv-org.github.io/iptv/countries/bg.m3u' },
        { name: 'Burkina Faso', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/bf.m3u' },
        { name: 'Burundi', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/bi.m3u' },
        { name: 'Cambodia', channels: '44', url: 'https://iptv-org.github.io/iptv/countries/kh.m3u' },
        { name: 'Cameroon', channels: '11', url: 'https://iptv-org.github.io/iptv/countries/cm.m3u' },
        { name: 'Canada', channels: '123', url: 'https://iptv-org.github.io/iptv/countries/ca.m3u' },
        { name: 'Cape Verde', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/cv.m3u' },
        { name: 'Cayman Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/ky.m3u' },
        { name: 'Central African Republic', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/cf.m3u' },
        { name: 'Chad', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/td.m3u' },
        { name: 'Chile', channels: '256', url: 'https://iptv-org.github.io/iptv/countries/cl.m3u' },
        { name: 'China', channels: '634', url: 'https://iptv-org.github.io/iptv/countries/cn.m3u' },
        { name: 'Colombia', channels: '118', url: 'https://iptv-org.github.io/iptv/countries/co.m3u' },
        { name: 'Comoros', channels: '34', url: 'https://iptv-org.github.io/iptv/countries/km.m3u' },
        { name: 'Cook Islands', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/ck.m3u' },
        { name: 'Costa Rica', channels: '96', url: 'https://iptv-org.github.io/iptv/countries/cr.m3u' },
        { name: 'Croatia', channels: '28', url: 'https://iptv-org.github.io/iptv/countries/hr.m3u' },
        { name: 'Cuba', channels: '58', url: 'https://iptv-org.github.io/iptv/countries/cu.m3u' },
        { name: 'Curacao', channels: '10', url: 'https://iptv-org.github.io/iptv/countries/cw.m3u' },
        { name: 'Cyprus', channels: '35', url: 'https://iptv-org.github.io/iptv/countries/cy.m3u' },
        { name: 'Czech Republic', channels: '41', url: 'https://iptv-org.github.io/iptv/countries/cz.m3u' },
        { name: 'Democratic Republic of the Congo', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/cd.m3u' },
        { name: 'Denmark', channels: '28', url: 'https://iptv-org.github.io/iptv/countries/dk.m3u' },
        { name: 'Djibouti', channels: '39', url: 'https://iptv-org.github.io/iptv/countries/dj.m3u' },
        { name: 'Dominica', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/dm.m3u' },
        { name: 'Dominican Republic', channels: '197', url: 'https://iptv-org.github.io/iptv/countries/do.m3u' },
        { name: 'East Timor', channels: '29', url: 'https://iptv-org.github.io/iptv/countries/tl.m3u' },
        { name: 'Ecuador', channels: '85', url: 'https://iptv-org.github.io/iptv/countries/ec.m3u' },
        { name: 'Egypt', channels: '65', url: 'https://iptv-org.github.io/iptv/countries/eg.m3u' },
        { name: 'El Salvador', channels: '76', url: 'https://iptv-org.github.io/iptv/countries/sv.m3u' },
        { name: 'Equatorial Guinea', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/gq.m3u' },
        { name: 'Eritrea', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/er.m3u' },
        { name: 'Estonia', channels: '19', url: 'https://iptv-org.github.io/iptv/countries/ee.m3u' },
        { name: 'Ethiopia', channels: '15', url: 'https://iptv-org.github.io/iptv/countries/et.m3u' },
        { name: 'Falkland Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/fk.m3u' },
        { name: 'Faroe Islands', channels: '1', url: 'https://iptv-org.github.io/iptv/countries/fo.m3u' },
        { name: 'Fiji', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/fj.m3u' },
        { name: 'Finland', channels: '36', url: 'https://iptv-org.github.io/iptv/countries/fi.m3u' },
        { name: 'France', channels: '189', url: 'https://iptv-org.github.io/iptv/countries/fr.m3u' },
        { name: 'French Guiana', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/gf.m3u' },
        { name: 'French Polynesia', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/pf.m3u' },
        { name: 'French Southern Territories', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/tf.m3u' },
        { name: 'Gabon', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/ga.m3u' },
        { name: 'Gambia', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/gm.m3u' },
        { name: 'Georgia', channels: '21', url: 'https://iptv-org.github.io/iptv/countries/ge.m3u' },
        { name: 'Germany', channels: '252', url: 'https://iptv-org.github.io/iptv/countries/de.m3u' },
        { name: 'Ghana', channels: '26', url: 'https://iptv-org.github.io/iptv/countries/gh.m3u' },
        { name: 'Greece', channels: '97', url: 'https://iptv-org.github.io/iptv/countries/gr.m3u' },
        { name: 'Greenland', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/gl.m3u' },
        { name: 'Grenada', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/gd.m3u' },
        { name: 'Guadeloupe', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/gp.m3u' },
        { name: 'Guam', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/gu.m3u' },
        { name: 'Guatemala', channels: '106', url: 'https://iptv-org.github.io/iptv/countries/gt.m3u' },
        { name: 'Guernsey', channels: '1', url: 'https://iptv-org.github.io/iptv/countries/gg.m3u' },
        { name: 'Guinea', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/gn.m3u' },
        { name: 'Guinea-Bissau', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/gw.m3u' },
        { name: 'Guyana', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/gy.m3u' },
        { name: 'Haiti', channels: '21', url: 'https://iptv-org.github.io/iptv/countries/ht.m3u' },
        { name: 'Honduras', channels: '105', url: 'https://iptv-org.github.io/iptv/countries/hn.m3u' },
        { name: 'Hong Kong', channels: '21', url: 'https://iptv-org.github.io/iptv/countries/hk.m3u' },
        { name: 'Hungary', channels: '81', url: 'https://iptv-org.github.io/iptv/countries/hu.m3u' },
        { name: 'Iceland', channels: '16', url: 'https://iptv-org.github.io/iptv/countries/is.m3u' },
        { name: 'India', channels: '161', url: 'https://iptv-org.github.io/iptv/countries/in.m3u' },
        { name: 'Indonesia', channels: '175', url: 'https://iptv-org.github.io/iptv/countries/id.m3u' },
        { name: 'Iran', channels: '56', url: 'https://iptv-org.github.io/iptv/countries/ir.m3u' },
        { name: 'Iraq', channels: '63', url: 'https://iptv-org.github.io/iptv/countries/iq.m3u' },
        { name: 'Ireland', channels: '24', url: 'https://iptv-org.github.io/iptv/countries/ie.m3u' },
        { name: 'Israel', channels: '18', url: 'https://iptv-org.github.io/iptv/countries/il.m3u' },
        { name: 'Italy', channels: '403', url: 'https://iptv-org.github.io/iptv/countries/it.m3u' },
        { name: 'Ivory Coast', channels: '16', url: 'https://iptv-org.github.io/iptv/countries/ci.m3u' },
        { name: 'Jamaica', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/jm.m3u' },
        { name: 'Japan', channels: '53', url: 'https://iptv-org.github.io/iptv/countries/jp.m3u' },
        { name: 'Jordan', channels: '57', url: 'https://iptv-org.github.io/iptv/countries/jo.m3u' },
        { name: 'Kazakhstan', channels: '31', url: 'https://iptv-org.github.io/iptv/countries/kz.m3u' },
        { name: 'Kenya', channels: '14', url: 'https://iptv-org.github.io/iptv/countries/ke.m3u' },
        { name: 'Kiribati', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/ki.m3u' },
        { name: 'Kosovo', channels: '20', url: 'https://iptv-org.github.io/iptv/countries/xk.m3u' },
        { name: 'Kuwait', channels: '41', url: 'https://iptv-org.github.io/iptv/countries/kw.m3u' },
        { name: 'Kyrgyzstan', channels: '3', url: 'https://iptv-org.github.io/iptv/countries/kg.m3u' },
        { name: 'Laos', channels: '46', url: 'https://iptv-org.github.io/iptv/countries/la.m3u' },
        { name: 'Latvia', channels: '21', url: 'https://iptv-org.github.io/iptv/countries/lv.m3u' },
        { name: 'Lebanon', channels: '53', url: 'https://iptv-org.github.io/iptv/countries/lb.m3u' },
        { name: 'Lesotho', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/ls.m3u' },
        { name: 'Liberia', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/lr.m3u' },
        { name: 'Libya', channels: '45', url: 'https://iptv-org.github.io/iptv/countries/ly.m3u' },
        { name: 'Liechtenstein', channels: '17', url: 'https://iptv-org.github.io/iptv/countries/li.m3u' },
        { name: 'Lithuania', channels: '21', url: 'https://iptv-org.github.io/iptv/countries/lt.m3u' },
        { name: 'Luxembourg', channels: '23', url: 'https://iptv-org.github.io/iptv/countries/lu.m3u' },
        { name: 'Macao', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/mo.m3u' },
        { name: 'Madagascar', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/mg.m3u' },
        { name: 'Malawi', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/mw.m3u' },
        { name: 'Malaysia', channels: '41', url: 'https://iptv-org.github.io/iptv/countries/my.m3u' },
        { name: 'Maldives', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/mv.m3u' },
        { name: 'Mali', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/ml.m3u' },
        { name: 'Malta', channels: '14', url: 'https://iptv-org.github.io/iptv/countries/mt.m3u' },
        { name: 'Marshall Islands', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/mh.m3u' },
        { name: 'Martinique', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/mq.m3u' },
        { name: 'Mauritania', channels: '37', url: 'https://iptv-org.github.io/iptv/countries/mr.m3u' },
        { name: 'Mauritius', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/mu.m3u' },
        { name: 'Mayotte', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/yt.m3u' },
        { name: 'Mexico', channels: '209', url: 'https://iptv-org.github.io/iptv/countries/mx.m3u' },
        { name: 'Micronesia', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/fm.m3u' },
        { name: 'Moldova', channels: '30', url: 'https://iptv-org.github.io/iptv/countries/md.m3u' },
        { name: 'Monaco', channels: '13', url: 'https://iptv-org.github.io/iptv/countries/mc.m3u' },
        { name: 'Mongolia', channels: '26', url: 'https://iptv-org.github.io/iptv/countries/mn.m3u' },
        { name: 'Montenegro', channels: '18', url: 'https://iptv-org.github.io/iptv/countries/me.m3u' },
        { name: 'Montserrat', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/ms.m3u' },
        { name: 'Morocco', channels: '52', url: 'https://iptv-org.github.io/iptv/countries/ma.m3u' },
        { name: 'Mozambique', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/mz.m3u' },
        { name: 'Myanmar (Burma)', channels: '51', url: 'https://iptv-org.github.io/iptv/countries/mm.m3u' },
        { name: 'Namibia', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/na.m3u' },
        { name: 'Nauru', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/nr.m3u' },
        { name: 'Nepal', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/np.m3u' },
        { name: 'Netherlands', channels: '143', url: 'https://iptv-org.github.io/iptv/countries/nl.m3u' },
        { name: 'New Caledonia', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/nc.m3u' },
        { name: 'New Zealand', channels: '32', url: 'https://iptv-org.github.io/iptv/countries/nz.m3u' },
        { name: 'Nicaragua', channels: '70', url: 'https://iptv-org.github.io/iptv/countries/ni.m3u' },
        { name: 'Niger', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/ne.m3u' },
        { name: 'Nigeria', channels: '39', url: 'https://iptv-org.github.io/iptv/countries/ng.m3u' },
        { name: 'Niue', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/nu.m3u' },
        { name: 'Norfolk Island', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/nf.m3u' },
        { name: 'North Korea', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/kp.m3u' },
        { name: 'North Macedonia', channels: '49', url: 'https://iptv-org.github.io/iptv/countries/mk.m3u' },
        { name: 'Northern Mariana Islands', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/mp.m3u' },
        { name: 'Norway', channels: '23', url: 'https://iptv-org.github.io/iptv/countries/no.m3u' },
        { name: 'Oman', channels: '34', url: 'https://iptv-org.github.io/iptv/countries/om.m3u' },
        { name: 'Pakistan', channels: '29', url: 'https://iptv-org.github.io/iptv/countries/pk.m3u' },
        { name: 'Palau', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/pw.m3u' },
        { name: 'Palestine', channels: '53', url: 'https://iptv-org.github.io/iptv/countries/ps.m3u' },
        { name: 'Panama', channels: '71', url: 'https://iptv-org.github.io/iptv/countries/pa.m3u' },
        { name: 'Papua New Guinea', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/pg.m3u' },
        { name: 'Paraguay', channels: '82', url: 'https://iptv-org.github.io/iptv/countries/py.m3u' },
        { name: 'Peru', channels: '216', url: 'https://iptv-org.github.io/iptv/countries/pe.m3u' },
        { name: 'Philippines', channels: '45', url: 'https://iptv-org.github.io/iptv/countries/ph.m3u' },
        { name: 'Pitcairn Islands', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/pn.m3u' },
        { name: 'Poland', channels: '64', url: 'https://iptv-org.github.io/iptv/countries/pl.m3u' },
        { name: 'Portugal', channels: '45', url: 'https://iptv-org.github.io/iptv/countries/pt.m3u' },
        { name: 'Puerto Rico', channels: '72', url: 'https://iptv-org.github.io/iptv/countries/pr.m3u' },
        { name: 'Qatar', channels: '37', url: 'https://iptv-org.github.io/iptv/countries/qa.m3u' },
        { name: 'Republic of the Congo', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/cg.m3u' },
        { name: 'Romania', channels: '111', url: 'https://iptv-org.github.io/iptv/countries/ro.m3u' },
        { name: 'Russia', channels: '317', url: 'https://iptv-org.github.io/iptv/countries/ru.m3u' },
        { name: 'Rwanda', channels: '12', url: 'https://iptv-org.github.io/iptv/countries/rw.m3u' },
        { name: 'Réunion', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/re.m3u' },
        { name: 'Saint Barthélemy', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/bl.m3u' },
        { name: 'Saint Helena', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/sh.m3u' },
        { name: 'Saint Kitts and Nevis', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/kn.m3u' },
        { name: 'Saint Lucia', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/lc.m3u' },
        { name: 'Saint Martin', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/mf.m3u' },
        { name: 'Saint Pierre and Miquelon', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/pm.m3u' },
        { name: 'Saint Vincent and the Grenadines', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/vc.m3u' },
        { name: 'Samoa', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/ws.m3u' },
        { name: 'San Marino', channels: '14', url: 'https://iptv-org.github.io/iptv/countries/sm.m3u' },
        { name: 'Saudi Arabia', channels: '75', url: 'https://iptv-org.github.io/iptv/countries/sa.m3u' },
        { name: 'Senegal', channels: '11', url: 'https://iptv-org.github.io/iptv/countries/sn.m3u' },
        { name: 'Serbia', channels: '90', url: 'https://iptv-org.github.io/iptv/countries/rs.m3u' },
        { name: 'Seychelles', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/sc.m3u' },
        { name: 'Sierra Leone', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/sl.m3u' },
        { name: 'Singapore', channels: '38', url: 'https://iptv-org.github.io/iptv/countries/sg.m3u' },
        { name: 'Sint Maarten', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/sx.m3u' },
        { name: 'Slovakia', channels: '59', url: 'https://iptv-org.github.io/iptv/countries/sk.m3u' },
        { name: 'Slovenia', channels: '31', url: 'https://iptv-org.github.io/iptv/countries/si.m3u' },
        { name: 'Solomon Islands', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/sb.m3u' },
        { name: 'Somalia', channels: '50', url: 'https://iptv-org.github.io/iptv/countries/so.m3u' },
        { name: 'South Africa', channels: '22', url: 'https://iptv-org.github.io/iptv/countries/za.m3u' },
        { name: 'South Georgia and the South Sandwich Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/gs.m3u' },
        { name: 'South Korea', channels: '95', url: 'https://iptv-org.github.io/iptv/countries/kr.m3u' },
        { name: 'South Sudan', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/ss.m3u' },
        { name: 'Spain', channels: '279', url: 'https://iptv-org.github.io/iptv/countries/es.m3u' },
        { name: 'Sri Lanka', channels: '11', url: 'https://iptv-org.github.io/iptv/countries/lk.m3u' },
        { name: 'Sudan', channels: '42', url: 'https://iptv-org.github.io/iptv/countries/sd.m3u' },
        { name: 'Suriname', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/sr.m3u' },
        { name: 'Swaziland', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/sz.m3u' },
        { name: 'Sweden', channels: '42', url: 'https://iptv-org.github.io/iptv/countries/se.m3u' },
        { name: 'Switzerland', channels: '61', url: 'https://iptv-org.github.io/iptv/countries/ch.m3u' },
        { name: 'Syria', channels: '44', url: 'https://iptv-org.github.io/iptv/countries/sy.m3u' },
        { name: 'São Tomé and Príncipe', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/st.m3u' },
        { name: 'Taiwan', channels: '103', url: 'https://iptv-org.github.io/iptv/countries/tw.m3u' },
        { name: 'Tajikistan', channels: '2', url: 'https://iptv-org.github.io/iptv/countries/tj.m3u' },
        { name: 'Tanzania', channels: '9', url: 'https://iptv-org.github.io/iptv/countries/tz.m3u' },
        { name: 'Thailand', channels: '97', url: 'https://iptv-org.github.io/iptv/countries/th.m3u' },
        { name: 'Togo', channels: '15', url: 'https://iptv-org.github.io/iptv/countries/tg.m3u' },
        { name: 'Tokelau', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/tk.m3u' },
        { name: 'Tonga', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/to.m3u' },
        { name: 'Trinidad and Tobago', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/tt.m3u' },
        { name: 'Tunisia', channels: '47', url: 'https://iptv-org.github.io/iptv/countries/tn.m3u' },
        { name: 'Turkey', channels: '209', url: 'https://iptv-org.github.io/iptv/countries/tr.m3u' },
        { name: 'Turkmenistan', channels: '7', url: 'https://iptv-org.github.io/iptv/countries/tm.m3u' },
        { name: 'Turks and Caicos Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/tc.m3u' },
        { name: 'Tuvalu', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/tv.m3u' },
        { name: 'U.S. Virgin Islands', channels: '5', url: 'https://iptv-org.github.io/iptv/countries/vi.m3u' },
        { name: 'Uganda', channels: '16', url: 'https://iptv-org.github.io/iptv/countries/ug.m3u' },
        { name: 'Ukraine', channels: '78', url: 'https://iptv-org.github.io/iptv/countries/ua.m3u' },
        { name: 'United Arab Emirates', channels: '70', url: 'https://iptv-org.github.io/iptv/countries/ae.m3u' },
        { name: 'United Kingdom', channels: '202', url: 'https://iptv-org.github.io/iptv/countries/uk.m3u' },
        { name: 'United States', channels: '1739', url: 'https://iptv-org.github.io/iptv/countries/us.m3u' },
        { name: 'Uruguay', channels: '61', url: 'https://iptv-org.github.io/iptv/countries/uy.m3u' },
        { name: 'Uzbekistan', channels: '2', url: 'https://iptv-org.github.io/iptv/countries/uz.m3u' },
        { name: 'Vanuatu', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/vu.m3u' },
        { name: 'Vatican City', channels: '13', url: 'https://iptv-org.github.io/iptv/countries/va.m3u' },
        { name: 'Venezuela', channels: '95', url: 'https://iptv-org.github.io/iptv/countries/ve.m3u' },
        { name: 'Vietnam', channels: '83', url: 'https://iptv-org.github.io/iptv/countries/vn.m3u' },
        { name: 'Wallis and Futuna', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/wf.m3u' },
        { name: 'Western Sahara', channels: '11', url: 'https://iptv-org.github.io/iptv/countries/eh.m3u' },
        { name: 'Yemen', channels: '40', url: 'https://iptv-org.github.io/iptv/countries/ye.m3u' },
        { name: 'Zambia', channels: '8', url: 'https://iptv-org.github.io/iptv/countries/zm.m3u' },
        { name: 'Zimbabwe', channels: '6', url: 'https://iptv-org.github.io/iptv/countries/zw.m3u' }
    ],
    regions: [
        { name: 'Africa', channels: '252', url: 'https://iptv-org.github.io/iptv/regions/afr.m3u' },
        { name: 'Americas', channels: '3416', url: 'https://iptv-org.github.io/iptv/regions/amer.m3u' },
        { name: 'Asia-Pacific', channels: '1522', url: 'https://iptv-org.github.io/iptv/regions/apac.m3u' },
        { name: 'Arab world', channels: '315', url: 'https://iptv-org.github.io/iptv/regions/arab.m3u' },
        { name: 'Association of Southeast Asian Nations', channels: '358', url: 'https://iptv-org.github.io/iptv/regions/asean.m3u' },
        { name: 'Asia', channels: '2332', url: 'https://iptv-org.github.io/iptv/regions/asia.m3u' },
        { name: 'Benelux', channels: '183', url: 'https://iptv-org.github.io/iptv/regions/benelux.m3u' },
        { name: 'Caribbean', channels: '187', url: 'https://iptv-org.github.io/iptv/regions/carib.m3u' },
        { name: 'Central Asia', channels: '29', url: 'https://iptv-org.github.io/iptv/regions/cas.m3u' },
        { name: 'Central and Eastern Europe', channels: '940', url: 'https://iptv-org.github.io/iptv/regions/cee.m3u' },
        { name: 'Central America', channels: '179', url: 'https://iptv-org.github.io/iptv/regions/cenamer.m3u' },
        { name: 'Commonwealth of Independent States', channels: '412', url: 'https://iptv-org.github.io/iptv/regions/cis.m3u' },
        { name: 'Europe, the Middle East and Africa', channels: '3364', url: 'https://iptv-org.github.io/iptv/regions/emea.m3u' },
        { name: 'Europe', channels: '2873', url: 'https://iptv-org.github.io/iptv/regions/eur.m3u' },
        { name: 'Hispanic America', channels: '1281', url: 'https://iptv-org.github.io/iptv/regions/hispam.m3u' },
        { name: 'Latin America and the Caribbean', channels: '1565', url: 'https://iptv-org.github.io/iptv/regions/lac.m3u' },
        { name: 'Latin America', channels: '1550', url: 'https://iptv-org.github.io/iptv/regions/latam.m3u' },
        { name: 'Maghreb', channels: '52', url: 'https://iptv-org.github.io/iptv/regions/maghreb.m3u' },
        { name: 'Middle East and North Africa', channels: '550', url: 'https://iptv-org.github.io/iptv/regions/mena.m3u' },
        { name: 'Middle East', channels: '510', url: 'https://iptv-org.github.io/iptv/regions/mideast.m3u' },
        { name: 'Northern America', channels: '1851', url: 'https://iptv-org.github.io/iptv/regions/nam.m3u' },
        { name: 'Northern Europe', channels: '106', url: 'https://iptv-org.github.io/iptv/regions/neur.m3u' },
        { name: 'North America', channels: '2363', url: 'https://iptv-org.github.io/iptv/regions/noram.m3u' },
        { name: 'Nordics', channels: '82', url: 'https://iptv-org.github.io/iptv/regions/nord.m3u' },
        { name: 'Oceania', channels: '56', url: 'https://iptv-org.github.io/iptv/regions/oce.m3u' },
        { name: 'South Asia', channels: '219', url: 'https://iptv-org.github.io/iptv/regions/sas.m3u' },
        { name: 'Southeast Asia', channels: '381', url: 'https://iptv-org.github.io/iptv/regions/sea.m3u' },
        { name: 'Southern Europe', channels: '985', url: 'https://iptv-org.github.io/iptv/regions/ser.m3u' },
        { name: 'South America', channels: '1053', url: 'https://iptv-org.github.io/iptv/regions/southam.m3u' },
        { name: 'Sub-Saharan Africa', channels: '190', url: 'https://iptv-org.github.io/iptv/regions/ssa.m3u' },
        { name: 'West Africa', channels: '94', url: 'https://iptv-org.github.io/iptv/regions/wafr.m3u' },
        { name: 'Western Europe', channels: '851', url: 'https://iptv-org.github.io/iptv/regions/wer.m3u' }
    ]
};

</script>
</body>
</html>
