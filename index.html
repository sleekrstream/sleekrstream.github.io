<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SleekrStream</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- HLS.js for m3u8 support -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js" defer></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest" defer></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
<!-- Favicon -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4029/4029010.png">

<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    brand: {
                        300: '#a5b4fc', // Indigo 300
                        400: '#818cf8', // Indigo 400
                        500: '#6366f1', // Indigo 500
                        600: '#4f46e5', // Indigo 600
                    },
                    dark: {
                        bg: '#020617',      // Slate 950
                        surface: '#0f172a', // Slate 900
                        border: '#1e293b',  // Slate 800
                        light: '#334155',   // Slate 700
                    }
                },
                animation: {
                    'slide-in': 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    'fade-in': 'fadeIn 0.3s ease-out forwards',
                    'pulse-slow': 'pulseSlow 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    'heart-beat': 'heartBeat 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    'pop-up': 'popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                },
                keyframes: {
                    slideIn: {
                        '0%': { transform: 'translateY(15px)', opacity: '0' },
                        '100%': { transform: 'translateY(0)', opacity: '1' },
                    },
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'scale(0.98)' },
                        '100%': { opacity: '1', transform: 'scale(1)' },
                    },
                    popUp: {
                        '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' },
                        '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                    },
                    pulseSlow: {
                        '50%': { opacity: '.6' },
                    },
                    heartBeat: {
                        '0%': { transform: 'scale(1)' },
                        '50%': { transform: 'scale(1.3)' },
                        '100%': { transform: 'scale(1)' },
                    }
                }
            }
        }
    }
</script>

<style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    ::-webkit-scrollbar-track {
        background: transparent; 
    }
    ::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #475569; 
    }

    /* Hidden Scrollbar Utility */
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

/* Transparency Grid for Image Preview */
    .image-preview-container {
        background-color: #0f172a; /* Slate 900 */
        /* Ultra subtle pattern */
        background-image: 
            linear-gradient(45deg, rgba(255,255,255,0.03) 25%, transparent 25%), 
            linear-gradient(-45deg, rgba(255,255,255,0.03) 25%, transparent 25%), 
            linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.03) 75%), 
            linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.03) 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    /* Loader */
    .loader {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        position: relative;
        animation: spin 1.2s linear infinite;
        border: 4px solid transparent;
        border-top-color: #6366f1; 
        border-left-color: #818cf8; 
    }
    .loader::after {
        content: '';
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        border: 4px solid transparent;
        border-bottom-color: #a5b4fc; 
        animation: spin 0.7s linear infinite reverse;
    }
    .mini-loader {
        width: 24px;
        height: 24px;
        border: 2px solid transparent;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Volume Slider */
    input[type=range] {
        -webkit-appearance: none; 
        background: transparent;
        height: 24px;
        display: flex;
        align-items: center;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 14px;
        width: 14px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        margin-top: -5px; 
        position: relative;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    input[type=range]:active::-webkit-slider-thumb {
        transform: scale(1.2);
    }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: rgba(255,255,255,0.15);
        border-radius: 2px;
    }
    
    /* Channel Item Styling */
    .channel-item {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .channel-item:hover {
        transform: translateX(4px);
    }
    .channel-item.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.05));
        border: 1px solid rgba(99, 102, 241, 0.3);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transform: translateX(4px);
    }
    /* Indicator for active channel */
    .channel-item.active .active-indicator {
        opacity: 1;
        transform: scale(1);
    }

    /* Glassmorphism & GPU Stabilization */
    .glass {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.07);
        /* Hardware acceleration to prevent mobile jitter */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }

    /* Custom Dropdown Styling */
    .custom-select-options {
        display: none;
    }
    .custom-select.open .custom-select-options {
        display: block;
    }

    /* Fullscreen Helper */
    #videoContainer:fullscreen {
        background: black;
    }
    #videoContainer:fullscreen #fullscreenInfo {
        display: flex;
        animation: fadeIn 0.5s ease-out;
    }
    #videoContainer:fullscreen + .info-bar {
        display: none;
    }
    
    /* Smooth width/height transition for sidebar */
    .sidebar-transition {
        transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), 
                    height 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                    opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                    transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    body {
        background-image: radial-gradient(circle at top left, rgba(79, 70, 229, 0.15), transparent 30%),
                          radial-gradient(circle at bottom right, rgba(192, 132, 252, 0.1), transparent 40%);
    }

    /* UI Auto-hide */
    .ui-element {
        transition: opacity 0.3s ease-in-out;
        will-change: opacity; /* Hints browser to optimize for opacity changes */
    }
    .ui-hidden {
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Prevent drag on images */
    img {
        -webkit-user-drag: none;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

    /* Blurred Background Styling */
    #videoContainer.has-blurred-bg #backgroundCanvas {
        opacity: 1;
        filter: blur(40px) brightness(0.4);
        transform: scale(1.1); /* To avoid harsh edges from the video appearing */
    }

    /* Popup Menu for Mobile */
    .mobile-menu-enter {
        animation: popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>
</head>
<body class="bg-dark-bg text-gray-300 h-screen w-screen overflow-hidden flex flex-row antialiased selection:bg-brand-500 selection:text-white">

<!-- SIDEBAR -->
<aside class="bg-dark-surface/95 backdrop-blur-xl border-r border-dark-border flex flex-col h-full fixed md:relative inset-0 w-full max-w-xs md:w-[340px] md:max-w-none sidebar-transition z-50 -translate-x-full md:translate-x-0" id="sidebar">
    
    <!-- Header -->
    <div class="p-5 border-b border-dark-border flex justify-between items-center bg-dark-surface/50 shrink-0">
        <div class="flex items-center gap-3 overflow-hidden whitespace-nowrap">
            <div class="bg-gradient-to-br from-brand-600 to-brand-400 text-white p-2.5 rounded-xl shadow-lg shadow-brand-500/20">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight text-white sidebar-text">SleekrStream</h1>
        </div>
        <div class="flex items-center gap-1 sidebar-text">
            <button onclick="toggleModal('addChannelModal')" class="p-2 hover:bg-white/5 rounded-xl transition-all active:scale-95 text-gray-400 hover:text-white group relative" title="Add Stream">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl md:hidden active:scale-95 transition-all">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl hidden md:block active:scale-95 transition-all">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="p-4 border-b border-dark-border space-y-3 shrink-0 sidebar-content bg-dark-surface/30">
        <div class="relative group focus-within:ring-2 focus-within:ring-brand-500/50 rounded-xl transition-all">
            <i data-lucide="search" class="absolute left-3.5 top-3 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
            <input type="text" id="searchInput" placeholder="Find channels..." 
                class="w-full bg-dark-bg border border-dark-border rounded-xl pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:border-brand-500 transition-all placeholder-gray-500 text-gray-200 shadow-sm">
        </div>
        
        <div class="flex gap-2">
            <div class="relative custom-select flex-1" id="groupFilterDropdown">
                <button onclick="toggleDropdown()" class="w-full bg-dark-bg border border-dark-border rounded-xl px-3 py-2 text-sm flex justify-between items-center hover:border-dark-light hover:bg-white/5 transition-all text-gray-300 active:scale-[0.98]">
                    <span id="selectedGroupLabel" class="truncate">All Groups</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                </button>
                <div class="custom-select-options absolute top-full left-0 right-0 mt-2 bg-dark-surface border border-dark-border rounded-xl shadow-2xl z-50 max-h-56 overflow-y-auto no-scrollbar animate-slide-in p-1.5" id="groupOptionsList"></div>
            </div>

             <button onclick="filterFavorites()" id="favFilterBtn" class="px-3 py-2 text-sm font-medium border border-dark-border rounded-xl hover:bg-white/5 text-gray-400 transition-all flex items-center justify-center gap-2 active:scale-95">
                <i data-lucide="heart" class="w-4 h-4"></i>
             </button>
        </div>
    </div>

    <!-- Channel List -->
    <div class="flex-1 overflow-y-auto p-3 space-y-2 sidebar-content scroll-smooth bg-dark-bg/30" id="channelList">
        <!-- Channels injected here -->
    </div>

    <!-- Sidebar Footer -->
    <div class="p-4 border-t border-dark-border text-xs text-gray-500 shrink-0 sidebar-content bg-dark-surface/50">
        <div class="flex justify-between items-center">
            <button onclick="importExampleChannels()" class="hover:text-brand-400 transition-colors flex items-center gap-1.5 hover:underline decoration-brand-400/50">
                <i data-lucide="download-cloud" class="w-3 h-3"></i> Load Demo
            </button>
            <span id="channelCount" class="font-mono text-gray-600">0 loaded</span>
        </div>
    </div>
</aside>

<!-- Sidebar Expand Strip (Desktop) -->
<div id="sidebarToggleStrip" class="hidden flex-col items-center justify-start py-6 w-14 border-r border-dark-border bg-dark-surface/80 z-20 gap-4 transition-all">
    <button onclick="toggleSidebar()" class="p-3 hover:bg-brand-500/10 hover:text-brand-400 rounded-xl transition-all active:scale-95" title="Expand Sidebar">
        <i data-lucide="panel-left-open" class="w-5 h-5"></i>
    </button>
</div>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col relative bg-black h-screen overflow-hidden w-full">
    
    <!-- MOBILE-ONLY TOP BAR -->
    <div class="md:hidden flex justify-between items-center p-3 border-b border-dark-border bg-dark-surface/80 glass shrink-0 z-20">
        <div class="flex items-center gap-3">
             <div class="bg-gradient-to-br from-brand-600 to-brand-400 text-white p-2 rounded-lg shadow-lg shadow-brand-500/20">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white">SleekrStream</h1>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleModal('addChannelModal')" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl active:scale-95 transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl active:scale-95 transition-all">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Video Container -->
    <div class="relative flex-1 bg-black flex items-center justify-center group overflow-hidden" id="videoContainer">
        
        <!-- Background Canvas -->
        <canvas id="backgroundCanvas" class="absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-500 opacity-0"></canvas>
        
        <!-- Video Element -->
        <video id="videoPlayer" class="relative z-10 w-full h-full object-contain transition-all duration-300" playsinline crossorigin="anonymous"></video>

        <!-- Fullscreen Info -->
        <div id="fullscreenInfo" class="absolute top-6 left-6 z-20 p-3 hidden items-center gap-4 glass rounded-[24px] ui-element">
            <div id="fullscreenChannelLogo" class="w-12 h-12 bg-dark-border rounded-lg flex items-center justify-center border border-white/10 overflow-hidden shrink-0">
                <i data-lucide="tv" class="w-6 h-6 opacity-80"></i>
            </div>
            <div>
                <h2 id="fullscreenChannelName" class="text-lg font-bold text-white">Select Channel</h2>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="absolute inset-0 bg-dark-surface/80 flex flex-col items-center justify-center z-10 hidden backdrop-blur-md animate-fade-in pointer-events-none text-center">
            <div class="loader mb-6"></div>
            <h3 class="text-lg font-medium text-white mb-2 tracking-wide" id="loadingTitle">Connecting to Stream</h3>
            <p id="loadingStatus" class="text-sm text-brand-400 opacity-80 animate-pulse-slow">Please wait a moment...</p>
        </div>

        <!-- Error Overlay -->
        <div id="errorOverlay" class="absolute inset-0 bg-dark-surface/95 flex flex-col items-center justify-center z-10 hidden p-8 text-center animate-fade-in">
            <div class="bg-red-500/10 p-5 rounded-full mb-6 ring-1 ring-red-500/20">
                <i data-lucide="wifi-off" class="w-10 h-10 text-red-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-3">Connection Failed</h3>
            <p id="errorMessage" class="text-gray-400 mb-8 max-w-md leading-relaxed text-sm">Could not connect to the stream. The link may be invalid, the stream might be offline, or unavailable in your region.</p>
            <div class="flex gap-4">
                <button onclick="stopPlayer()" class="px-6 py-2.5 bg-dark-surface border border-dark-border rounded-xl text-white hover:bg-dark-light transition text-sm font-medium active:scale-95">
                    Close
                </button>
                <button onclick="retryStream()" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition text-sm font-bold flex items-center gap-2 shadow-lg shadow-brand-500/20 active:scale-95">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Retry
                </button>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center z-0 p-4">
             <div class="absolute inset-0 bg-gradient-to-br from-dark-bg to-[#050505]"></div>
            <div class="relative mb-10 group cursor-pointer" onclick="toggleModal('addChannelModal')">
                <div class="absolute -inset-2 bg-brand-500 blur-3xl opacity-20 group-hover:opacity-30 transition-opacity duration-700 rounded-full animate-pulse-slow"></div>
                <div class="relative w-28 h-28 bg-dark-surface rounded-[2rem] flex items-center justify-center shadow-2xl border border-white/5 group-hover:scale-105 group-active:scale-95 transition-transform duration-500 ease-out">
                    <i data-lucide="zap" class="w-12 h-12 text-brand-400"></i>
                </div>
            </div>
            <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4 tracking-tight text-center">SleekrStream</h2>
            <p class="text-gray-400 max-w-sm text-center leading-relaxed">A modern IPTV experience.<br>Select a channel from the list or add a new stream to begin.</p>
            
            <div class="mt-8 gap-4 text-xs text-gray-500 font-mono hidden sm:flex">
                <span class="flex items-center gap-1.5"><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">SPACE</kbd> Play/Pause</span>
                <span class="flex items-center gap-1.5"><kbd class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5 font-sans">F</kbd> Fullscreen</span>
            </div>
        </div>

        <!-- NEW LOCATION: Mobile Menu is now here, outside the controls overlay -->
        <div id="mobileMenuOptions" class="absolute bottom-24 right-4 w-52 p-2 flex-col gap-1 hidden origin-bottom-right bg-[#0f172a]/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl mobile-menu-enter z-50 transform-gpu">
            <button onclick="toggleAspect(); closeMobileMenu()" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200">
                <i data-lucide="scan" class="w-4 h-4 text-brand-400"></i> Aspect Ratio
            </button>
            <button onclick="takeSnapshot(); closeMobileMenu()" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200">
                <i data-lucide="camera" class="w-4 h-4 text-brand-400"></i> Snapshot
            </button>
            <button onclick="toggleCaptions(); closeMobileMenu()" id="mobileCcBtn" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200 disabled:opacity-50">
                <i data-lucide="subtitles" class="w-4 h-4 text-brand-400"></i> Captions
            </button>
            <button onclick="togglePiP(); closeMobileMenu()" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200">
                <i data-lucide="picture-in-picture-2" class="w-4 h-4 text-brand-400"></i> PiP Mode
            </button>
            <button onclick="toggleStats(); closeMobileMenu()" class="w-full text-left flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl transition text-sm text-gray-200">
                <i data-lucide="bar-chart-2" class="w-4 h-4 text-brand-400"></i> Stats
            </button>
        </div>

        <!-- CONTROLS OVERLAY -->
        <div id="controlsOverlay" class="controls-wrapper absolute bottom-2 sm:bottom-6 left-2 sm:left-6 right-2 sm:right-6 p-3 sm:p-4 z-20 glass rounded-[24px] ui-element ui-hidden transform-gpu">
            
            <div class="flex justify-between items-center select-none w-full">
                <!-- Left Controls (Common) -->
                <div class="flex items-center gap-3 sm:gap-5 flex-1">
                    <button onclick="togglePlay()" class="text-white hover:text-brand-400 transition transform active:scale-90 outline-none group/play p-1">
                        <i data-lucide="play" id="playIcon" class="w-7 h-7 sm:w-8 sm:h-8 fill-white group-hover/play:fill-brand-400 transition-colors"></i>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="toggleMute()" class="text-gray-300 hover:text-white transition active:scale-90 p-1">
                            <i data-lucide="volume-2" id="volIcon" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        </button>
                        <div class="flex items-center h-8 gap-2 w-16 sm:w-24">
                            <input type="range" min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)" class="w-full">
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pl-2 sm:pl-4 border-l border-white/10">
                        <span id="liveBadge" class="hidden items-center gap-1.5 px-2.5 py-1 rounded-full bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase tracking-widest select-none">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                            LIVE
                        </span>
                    </div>
                </div>

                <!-- Right Controls -->
                <div class="flex items-center gap-1 sm:gap-1">
                    
                    <!-- Desktop-Only Tools Row -->
                    <div class="hidden md:flex items-center gap-1">
                        <!-- Aspect Ratio -->
                        <div class="relative group/tooltip">
                            <button onclick="toggleAspect()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95">
                                <i data-lucide="scan" class="w-5 h-5"></i>
                            </button>
                            <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Aspect Ratio</span>
                        </div>

                        <!-- Screenshot -->
                        <div class="relative group/tooltip">
                            <button onclick="takeSnapshot()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95">
                                <i data-lucide="camera" class="w-5 h-5"></i>
                            </button>
                            <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Snapshot</span>
                        </div>

                        <!-- Captions -->
                        <div class="relative group/tooltip">
                            <button onclick="toggleCaptions()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition relative disabled:opacity-30 disabled:cursor-not-allowed active:scale-95" id="ccBtn" disabled>
                                <i data-lucide="subtitles" class="w-5 h-5"></i>
                                <span id="ccBadge" class="absolute top-2 right-2 w-1.5 h-1.5 bg-brand-500 rounded-full hidden shadow-lg"></span>
                            </button>
                            <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Captions</span>
                        </div>

                        <!-- PiP -->
                        <div class="relative group/tooltip">
                            <button onclick="togglePiP()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95">
                                <i data-lucide="picture-in-picture-2" class="w-5 h-5"></i>
                            </button>
                            <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">PiP</span>
                        </div>

                        <!-- Stats -->
                        <div class="relative group/tooltip">
                            <button onclick="toggleStats()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95">
                                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                            </button>
                            <span class="pointer-events-none absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Stats</span>
                        </div>
                    </div>

                    <!-- Mobile-Only 3-Dot Menu -->
                    <div class="md:hidden relative">
                        <button onclick="toggleMobileMenu()" class="text-gray-300 hover:text-white hover:bg-white/10 p-2.5 rounded-lg transition active:scale-95" id="mobileMoreBtn">
                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Fullscreen (Shared) -->
                    <div class="relative group/tooltip ml-1">
                        <button onclick="toggleFullscreen()" class="text-white hover:bg-white/20 p-2.5 rounded-lg transition active:scale-95">
                            <i data-lucide="maximize" id="fsIcon" class="w-5 h-5"></i>
                        </button>
                        <span class="pointer-events-none hidden sm:block absolute bottom-full mb-2 right-0 bg-dark-surface border border-white/10 px-2 py-1 rounded text-xs text-white opacity-0 group-hover/tooltip:opacity-100 transition-opacity whitespace-nowrap z-50 shadow-lg">Fullscreen</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overlay -->
        <div id="statsOverlay" class="absolute top-4 right-4 left-4 sm:left-auto glass p-5 rounded-2xl text-xs font-mono text-gray-400 hidden z-30 w-auto max-w-[calc(100vw-2rem)] sm:w-80 shadow-2xl animate-fade-in overflow-hidden">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-3">
                <span class="font-bold text-white flex items-center gap-2"><i data-lucide="activity" class="w-3 h-3 text-brand-400"></i> Nerd Stats</span>
                <button onclick="toggleStats()" class="hover:text-white hover:bg-white/10 p-1.5 rounded-lg transition"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between"><span>Dimensions</span> <span id="statRes" class="text-white font-bold">-</span></div>
                <div class="flex justify-between"><span>Current Bitrate</span> <span id="statBitrate" class="text-brand-400">-</span></div>
                <div class="flex justify-between"><span>Buffer Length</span> <span id="statBuffer" class="text-white">-</span></div>
                <div class="flex justify-between"><span>Dropped Frames</span> <span id="statDropped" class="text-red-400">0</span></div>
                <div class="flex justify-between"><span>Est. Bandwidth</span> <span id="statBw" class="text-brand-400">-</span></div>
                <div class="flex justify-between"><span>Engine</span> <span id="statEngine" class="text-gray-500">HLS.js</span></div>
                
                <div class="mt-4 pt-3 border-t border-white/10">
                    <span class="block text-gray-500 text-[10px] mb-2 uppercase tracking-wider">Stream Source</span>
                    <div class="bg-black/40 p-3 rounded-lg border border-white/5 break-all text-[10px] text-gray-300 select-all font-mono leading-relaxed" id="statUrl"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Bar -->
    <!-- Updated: Added w-full max-w-full overflow-hidden to constrain width on mobile -->
    <div class="bg-dark-surface/80 glass p-4 border-t border-dark-border flex justify-between items-center shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] info-bar w-full max-w-full overflow-hidden">
        <div class="flex items-center gap-3 sm:gap-4 min-w-0 flex-1">
            <div id="currentChannelLogo" class="w-12 h-12 bg-gradient-to-br from-dark-light to-dark-border rounded-xl flex items-center justify-center text-gray-500 border border-white/5 overflow-hidden shrink-0 shadow-lg">
                <i data-lucide="tv" class="w-5 h-5 opacity-80"></i>
            </div>
            <div class="min-w-0 flex-1">
                <div class="flex items-center gap-3">
                    <h2 id="currentChannelName" class="text-lg font-bold text-white leading-tight truncate block">Select Channel</h2>
                    <button id="currentFavBtn" onclick="toggleCurrentFavorite()" class="text-gray-600 hover:text-brand-400 transition hidden active:scale-90 shrink-0">
                        <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-400 mt-1 truncate">
                    <span id="currentChannelGroup" class="text-brand-300 font-medium text-xs px-2 py-0.5 bg-brand-500/10 rounded-md border border-brand-500/20 truncate max-w-[120px]">--</span>
                    <span id="networkHealth" class="flex items-center gap-1.5 text-xs ml-1 shrink-0">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-600" id="healthDot"></span>
                        <span id="healthText" class="opacity-70">Idle</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex gap-2 shrink-0 ml-2">
            <button onclick="shareCurrentChannel()" id="shareBtn" class="p-2.5 bg-dark-bg border border-dark-border hover:bg-dark-light hover:border-dark-light rounded-xl text-gray-400 hover:text-white transition disabled:opacity-30 disabled:cursor-not-allowed active:scale-95" disabled title="Share Channel">
                <i data-lucide="share-2" class="w-4 h-4"></i>
            </button>
            <button onclick="editCurrentChannel()" id="editBtn" class="p-2.5 bg-dark-bg border border-dark-border hover:bg-dark-light hover:border-dark-light rounded-xl text-gray-400 hover:text-white transition disabled:opacity-30 disabled:cursor-not-allowed active:scale-95" disabled title="Edit Channel">
                <i data-lucide="settings-2" class="w-4 h-4"></i>
            </button>
        </div>
    </div>
</main>

<!-- BACKDROP for mobile sidebar -->
<div id="sidebarBackdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden transition-opacity duration-300"></div>


<!-- MODAL: Add/Edit Channel -->
<div id="addChannelModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl p-6 sm:p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden flex flex-col max-h-[90vh]">
        <!-- Decorative Glow -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

        <div class="flex justify-between items-center mb-6 shrink-0 relative">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                <span id="modalTitle">Add Stream</span>
            </h3>
            <button onclick="toggleModal('addChannelModal')" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
<div class="overflow-y-auto no-scrollbar relative flex-1 -mx-2 px-2">
    <form id="channelForm" onsubmit="handleChannelSubmit(event)" class="space-y-5 relative pb-2">
        <input type="hidden" id="channelId">
        
        <!-- Full-width inputs for primary info -->
        <div>
            <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Name</label>
            <input type="text" id="inpName" required class="w-full bg-dark-bg border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-all placeholder-gray-500" placeholder="e.g., My Favorite Channel">
        </div>

        <div>
            <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Stream URL (.m3u8)</label>
            <div class="relative group">
                <input type="url" id="inpUrl" required class="w-full bg-dark-bg border border-dark-border rounded-xl pl-11 pr-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-all font-mono text-sm placeholder-gray-500" placeholder="https://...">
                <i data-lucide="link-2" class="absolute left-4 top-3.5 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
            </div>
            <p id="urlValidationStatus" class="text-xs mt-2 ml-1 h-4 transition-opacity"></p>
        </div>

        <!-- Grid for Secondary Info & Perfectly Aligned Preview -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 pt-2 items-stretch">
            
            <!-- Left Column: Inputs -->
            <div class="sm:col-span-2 flex flex-col gap-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Group</label>
                    <input type="text" id="inpGroup" list="groupSuggestions" class="w-full bg-dark-bg border border-dark-border rounded-xl px-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500" placeholder="e.g., News">
                    <datalist id="groupSuggestions"></datalist>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Logo URL</label>
                    <div class="relative group">
                        <input type="url" id="inpLogo" class="w-full bg-dark-bg border border-dark-border rounded-xl pl-11 pr-4 py-3 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 focus:outline-none transition-colors placeholder-gray-500" placeholder="https://...">
                        <i data-lucide="image" class="absolute left-4 top-3.5 w-4 h-4 text-gray-500 group-focus-within:text-brand-400 transition-colors"></i>
                    </div>
                </div>
            </div>

            <!-- Right Column: Logo Preview -->
            <div class="sm:col-span-1 flex flex-col">
                <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Preview</label>
                <div id="logoPreview" class="image-preview-container w-full h-full min-h-[120px] rounded-2xl border-2 border-dashed border-dark-border flex items-center justify-center relative overflow-hidden group transition-all hover:border-brand-500/50">
                    <div class="text-gray-600 flex flex-col items-center gap-2 preview-placeholder select-none">
                        <i data-lucide="image-off" class="w-8 h-8 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="pt-6 flex gap-3 border-t border-dark-border/50">
            <button type="button" onclick="toggleModal('addChannelModal')" class="flex-1 px-4 py-3 bg-transparent border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98]">Save Channel</button>
        </div>
        
        <div id="deleteBtnContainer" class="hidden flex justify-center pt-2">
             <button type="button" onclick="deleteChannel()" class="text-red-500 hover:text-red-400 text-xs py-2 px-3 hover:bg-red-500/10 rounded-lg transition flex items-center gap-1.5 opacity-80 hover:opacity-100 active:scale-95">
                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Remove Channel
            </button>
        </div>
    </form>
</div>
    </div>
</div>

<!-- MODAL: Confirmation Dialog -->
<div id="confirmModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-md rounded-3xl border border-dark-border shadow-2xl p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden text-center">
        <div class="bg-red-500/10 p-4 rounded-full mb-5 ring-1 ring-red-500/20 inline-block">
            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
        </div>
        <h3 id="confirmTitle" class="text-xl font-bold text-white mb-3">Are you sure?</h3>
        <p id="confirmMessage" class="text-gray-400 mb-8 max-w-md leading-relaxed text-sm mx-auto">This action cannot be undone.</p>
        <div class="flex gap-3">
            <button id="confirmCancelBtn" class="flex-1 px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">
                Cancel
            </button>
            <button id="confirmOkBtn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white transition font-bold shadow-lg shadow-red-500/20 transform active:scale-[0.98]">
                Confirm
            </button>
        </div>
    </div>
</div>

<!-- MODAL: Share Confirmation -->
<div id="shareConfirmModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-md p-4 transition-opacity duration-300">
    <div class="bg-dark-surface w-full max-w-lg rounded-3xl border border-dark-border shadow-2xl p-6 sm:p-8 transform transition-all scale-100 animate-slide-in relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-brand-500/10 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>
        <div class="flex justify-between items-center mb-6 relative">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                <i data-lucide="inbox" class="w-6 h-6 text-brand-400"></i>
                Add Shared Channel
            </h3>
            <button onclick="closeShareConfirm()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-2 rounded-xl transition active:scale-95"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <p class="text-gray-400 text-sm mb-6">Someone shared a channel with you. Review the details below before adding it to your list.</p>
        
        <div class="space-y-4 mb-8">
            <div class="flex items-center gap-4 bg-dark-bg/50 p-4 rounded-2xl border border-dark-border">
                <div id="shareLogo" class="w-14 h-14 bg-dark-border rounded-xl flex items-center justify-center border border-white/10 overflow-hidden shrink-0">
                    <!-- Logo will be injected here -->
                </div>
                <div>
                    <h4 id="shareName" class="text-lg font-bold text-white">Channel Name</h4>
                    <span id="shareGroup" class="text-sm text-brand-300">Channel Group</span>
                </div>
            </div>
            <div>
                 <label class="block text-xs font-semibold text-gray-400 mb-2 ml-1 uppercase tracking-wider">Stream URL</label>
                 <div id="shareUrl" class="bg-dark-bg p-3 rounded-lg border border-dark-border break-all text-xs text-gray-400 select-all font-mono">
                     <!-- URL will be injected here -->
                 </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="closeShareConfirm()" class="flex-1 px-4 py-3 bg-transparent border border-dark-border rounded-xl text-gray-300 hover:text-white hover:border-dark-light transition font-medium active:scale-[0.98]">Cancel</button>
            <button id="addSharedBtn" class="flex-1 px-4 py-3 bg-brand-600 hover:bg-brand-500 rounded-xl text-white transition font-bold shadow-lg shadow-brand-500/20 transform active:scale-[0.98]">
                <i data-lucide="plus" class="inline w-4 h-4 mr-1.5 -ml-1"></i> Add to My List
            </button>
        </div>
    </div>
</div>


<!-- TOAST -->
<div id="toast" class="fixed bottom-8 right-8 glass px-6 py-4 rounded-2xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-4 z-50">
    <div id="toastIcon" class="bg-brand-500/20 p-2 rounded-full"><i data-lucide="check" class="text-brand-400 w-5 h-5"></i></div>
    <div class="flex flex-col">
        <span id="toastMsg" class="font-medium text-sm tracking-wide text-white">Action successful</span>
    </div>
</div>

<script>
    // --- STATE ---
    let channels = JSON.parse(localStorage.getItem('sleek_channels')) || [];
    let favorites = JSON.parse(localStorage.getItem('sleek_favorites')) || [];
    let currentChannelId = null;
    let hls = null;
    let isDesktopSidebarCollapsed = false;
    let isMobileSidebarOpen = false;
    let showOnlyFavorites = false;
    let isCaptionsOn = false;
    let aspectModes = ['contain', 'cover', 'fill'];
    let currentAspectIndex = 0;
    let inactivityTimer;
    let animationFrameId = null;
    let sharedChannelData = null; 

    // Mobile specific interaction state
    let isTouchInteraction = false;
    let mobileMenuOpen = false;

    const video = document.getElementById('videoPlayer');

    // --- DOM REFS ---
    const els = {
        videoContainer: document.getElementById('videoContainer'),
        backgroundCanvas: document.getElementById('backgroundCanvas'),
        controlsOverlay: document.getElementById('controlsOverlay'),
        mobileMenuOptions: document.getElementById('mobileMenuOptions'),
        channelList: document.getElementById('channelList'),
        searchInput: document.getElementById('searchInput'),
        groupFilterLabel: document.getElementById('selectedGroupLabel'),
        groupOptionsList: document.getElementById('groupOptionsList'),
        sidebar: document.getElementById('sidebar'),
        sidebarBackdrop: document.getElementById('sidebarBackdrop'),
        sidebarToggleStrip: document.getElementById('sidebarToggleStrip'),
        channelCount: document.getElementById('channelCount'),
        loading: document.getElementById('loadingOverlay'),
        loadingTitle: document.getElementById('loadingTitle'),
        loadingStatus: document.getElementById('loadingStatus'),
        error: document.getElementById('errorOverlay'),
        errorMessage: document.getElementById('errorMessage'),
        startScreen: document.getElementById('startScreen'),
        networkDot: document.getElementById('healthDot'),
        networkText: document.getElementById('healthText'),
        favBtn: document.getElementById('currentFavBtn'),
        logoPreview: document.getElementById('logoPreview'),
        inpLogo: document.getElementById('inpLogo'),
        inpUrl: document.getElementById('inpUrl'),
        urlValidationStatus: document.getElementById('urlValidationStatus'),
        fullscreenInfo: document.getElementById('fullscreenInfo'),
        fullscreenChannelLogo: document.getElementById('fullscreenChannelLogo'),
        fullscreenChannelName: document.getElementById('fullscreenChannelName'),
        confirm: {
            modal: document.getElementById('confirmModal'),
            title: document.getElementById('confirmTitle'),
            message: document.getElementById('confirmMessage'),
            okBtn: document.getElementById('confirmOkBtn'),
            cancelBtn: document.getElementById('confirmCancelBtn'),
        },
        stats: {
            overlay: document.getElementById('statsOverlay'),
            res: document.getElementById('statRes'),
            bitrate: document.getElementById('statBitrate'),
            buffer: document.getElementById('statBuffer'),
            dropped: document.getElementById('statDropped'),
            bw: document.getElementById('statBw'),
            url: document.getElementById('statUrl'),
            engine: document.getElementById('statEngine')
        }
    };

    let currentFilterGroup = 'all';

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            setTimeout(() => lucide.createIcons(), 50);
        }
        
        renderChannels();
        updateGroupDropdown();
        setupPlayerEvents();
        setupKeyboardShortcuts();
        setupInactivityControls();
        handleIncomingShareLink();
        
        const debouncedVerifyUrl = debounce(verifyUrl, 500);
        els.inpUrl.addEventListener('input', debouncedVerifyUrl);
        els.searchInput.addEventListener('input', renderChannels);
        els.inpLogo.addEventListener('input', updateLogoPreview);

        window.addEventListener('resize', () => {
            if(window.innerWidth >= 768) {
                if (isMobileSidebarOpen) toggleSidebar(); 
                if (mobileMenuOpen) closeMobileMenu();
            }
        });
        
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.getElementById('fsIcon').setAttribute('data-lucide', 'maximize');
                lucide.createIcons();
            }
        });

        // Click outside handler for mobile menu
        document.addEventListener('click', (e) => {
            if (mobileMenuOpen && !e.target.closest('#mobileMenuOptions') && !e.target.closest('#mobileMoreBtn')) {
                closeMobileMenu();
            }
        });
    });

    // --- BLURRED BACKGROUND ---
    function updateBackgroundCanvas() {
        if (!video.paused && !video.ended && video.videoWidth > 0) {
            const canvas = els.backgroundCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        animationFrameId = requestAnimationFrame(updateBackgroundCanvas);
    }

    function startBackgroundLoop() {
        if (!animationFrameId) {
            updateBackgroundCanvas();
        }
    }

    function stopBackgroundLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            const canvas = els.backgroundCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    
    // --- UI INACTIVITY / MOBILE GLITCH FIX ---
    function setupInactivityControls() {
        // Detect touch capability to separate logic
        els.videoContainer.addEventListener('touchstart', () => {
            isTouchInteraction = true;
        }, {passive: true});

        function showUI() {
            if (!els.videoContainer.classList.contains('player-active')) return;
            els.controlsOverlay.classList.remove('ui-hidden');
            if (document.fullscreenElement) {
                els.fullscreenInfo.classList.remove('ui-hidden');
            }
        }

        function hideUI() {
            if (video.paused || mobileMenuOpen) return;
            els.controlsOverlay.classList.add('ui-hidden');
            els.fullscreenInfo.classList.add('ui-hidden');
            // Also close menu if UI hides
            if(mobileMenuOpen) closeMobileMenu();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            showUI();
            inactivityTimer = setTimeout(hideUI, 3000);
        }

        // DESKTOP: Hover logic
        els.videoContainer.addEventListener('mousemove', (e) => {
            // If we recently detected touch, ignore mousemove (simulated by tap) to prevent jitter
            if (isTouchInteraction) return;
            resetInactivityTimer();
        });

        els.videoContainer.addEventListener('mouseleave', () => {
            if (isTouchInteraction) return;
            hideUI();
        });

        // MOBILE / TOUCH: Explicit Toggle
        // We use 'click' on the container, but we check if it was a touch event flag
        els.videoContainer.addEventListener('click', (e) => {
            // Don't toggle if clicking actual controls
            if(e.target.closest('.controls-wrapper') || e.target.closest('.glass') || e.target.closest('#mobileMenuOptions')) return;

            if (isTouchInteraction) {
                if (els.controlsOverlay.classList.contains('ui-hidden')) {
                    resetInactivityTimer();
                } else {
                    hideUI();
                }
                // Reset flag after a short delay so mousemove works again if user switches input (rare)
                setTimeout(() => { isTouchInteraction = false; }, 500);
            }
        });

        video.addEventListener('pause', () => {
            showUI();
            clearTimeout(inactivityTimer);
        });
        
        video.addEventListener('play', resetInactivityTimer);
    }

    // --- MOBILE MENU ---
    function toggleMobileMenu() {
        mobileMenuOpen = !mobileMenuOpen;
        if(mobileMenuOpen) {
            els.mobileMenuOptions.classList.remove('hidden');
            els.mobileMenuOptions.classList.add('flex');
            // Keep UI open while menu is open
            clearTimeout(inactivityTimer);
        } else {
            closeMobileMenu();
        }
    }

    function closeMobileMenu() {
        mobileMenuOpen = false;
        els.mobileMenuOptions.classList.add('hidden');
        els.mobileMenuOptions.classList.remove('flex');
    }

    // --- KEYBOARD SHORTCUTS ---
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.closest('#addChannelModal') || e.target.closest('#confirmModal')) return;

            switch(e.code) {
                case 'Space': e.preventDefault(); togglePlay(); break;
                case 'KeyF': e.preventDefault(); toggleFullscreen(); break;
                case 'KeyM': toggleMute(); break;
                case 'ArrowUp': e.preventDefault(); setVolume(Math.min(1, video.volume + 0.1)); break;
                case 'ArrowDown': e.preventDefault(); setVolume(Math.max(0, video.volume - 0.1)); break;
            }
        });
    }

    // --- URL VALIDATION ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    async function verifyUrl() {
        const url = els.inpUrl.value.trim();
        const statusEl = els.urlValidationStatus;
        
        if (!url) {
            statusEl.textContent = '';
            return;
        }
        
        if (!url.endsWith('.m3u8')) {
            statusEl.textContent = 'URL should end with .m3u8 for compatibility.';
            statusEl.className = 'text-xs text-yellow-500 mt-2 ml-1 h-4 transition-opacity';
            return;
        }

        statusEl.textContent = 'Verifying URL...';
        statusEl.className = 'text-xs text-gray-500 mt-2 ml-1 h-4 transition-opacity animate-pulse';

        try {
            const response = await fetch(url, { method: 'HEAD', mode: 'cors' });
            if (response.ok) {
                 statusEl.textContent = 'URL is valid and reachable.';
                 statusEl.className = 'text-xs text-green-500 mt-2 ml-1 h-4 transition-opacity';
            } else {
                 statusEl.textContent = `URL is reachable but returned status ${response.status}.`;
                 statusEl.className = 'text-xs text-yellow-500 mt-2 ml-1 h-4 transition-opacity';
            }
        } catch (error) {
            if (error instanceof TypeError) {
                statusEl.textContent = 'URL seems valid (CORS check).';
                statusEl.className = 'text-xs text-green-500 mt-2 ml-1 h-4 transition-opacity';
            } else {
                statusEl.textContent = 'This URL is invalid or cannot be reached.';
                statusEl.className = 'text-xs text-red-500 mt-2 ml-1 h-4 transition-opacity';
            }
        } finally {
            statusEl.classList.remove('animate-pulse');
        }
    }
    
    // --- ENHANCED IMAGE PREVIEW ---
    function updateLogoPreview() {
        const url = els.inpLogo.value.trim();
        const previewContainer = els.logoPreview;
        
        const placeholderHTML = `
            <div class="text-gray-600 flex flex-col items-center gap-2 animate-fade-in select-none">
                <i data-lucide="image" class="w-8 h-8 opacity-50"></i>
                <span class="text-[10px] uppercase tracking-wide opacity-50">No Image</span>
            </div>`;

        const loadingHTML = `<div class="mini-loader"></div>`;

        if (!url) {
            previewContainer.innerHTML = placeholderHTML;
            lucide.createIcons();
            return;
        }

        previewContainer.innerHTML = loadingHTML;

        const img = new Image();
        img.src = url;

        img.onload = () => {
            previewContainer.innerHTML = `<img src="${url}" class="max-w-[80%] max-h-[80%] drop-shadow-xl animate-fade-in" draggable="false" alt="Preview">`;
        };

        img.onerror = () => {
            previewContainer.innerHTML = `
                <div class="text-red-400/50 flex flex-col items-center gap-2 animate-fade-in select-none">
                    <i data-lucide="image-off" class="w-8 h-8"></i>
                    <span class="text-[10px] uppercase tracking-wide">Load Failed</span>
                </div>`;
            lucide.createIcons();
        };
    }

    // --- SIDEBAR ---
    function toggleSidebar() {
        const sidebar = els.sidebar;
        const backdrop = els.sidebarBackdrop;
        const desktopIcon = sidebar.querySelector('.hidden.md\\:block i');

        if (window.innerWidth < 768) {
            // Mobile: Toggle slide-in/out
            isMobileSidebarOpen = !isMobileSidebarOpen;
            if (isMobileSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
                backdrop.classList.add('opacity-100');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.remove('opacity-100');
                setTimeout(() => backdrop.classList.add('hidden'), 300); // hide after transition
            }
        } else {
            // Desktop: Toggle width
            isDesktopSidebarCollapsed = !isDesktopSidebarCollapsed;
            if (isDesktopSidebarCollapsed) {
                sidebar.style.width = '0px';
                sidebar.classList.add('opacity-0', 'pointer-events-none');
                desktopIcon.setAttribute('data-lucide', 'chevron-right');
                els.sidebarToggleStrip.classList.remove('hidden');
                els.sidebarToggleStrip.classList.add('flex');
            } else {
                sidebar.style.width = '340px';
                sidebar.classList.remove('opacity-0', 'pointer-events-none');
                desktopIcon.setAttribute('data-lucide', 'chevron-left');
                els.sidebarToggleStrip.classList.add('hidden');
                els.sidebarToggleStrip.classList.remove('flex');
            }
        }
        setTimeout(() => lucide.createIcons(), 50);
    }

    // --- DROPDOWN ---
    function toggleDropdown() {
        document.getElementById('groupFilterDropdown').classList.toggle('open');
    }

    function selectGroup(group) {
        currentFilterGroup = group;
        els.groupFilterLabel.textContent = group === 'all' ? 'All Groups' : group;
        document.getElementById('groupFilterDropdown').classList.remove('open');
        renderChannels();
    }

    function updateGroupDropdown() {
        const groups = [...new Set(channels.map(c => c.group || 'Uncategorized'))].sort();
        let html = `<div onclick="selectGroup('all')" class="px-3 py-2 hover:bg-white/5 cursor-pointer rounded-lg text-sm text-gray-300 transition-colors ${currentFilterGroup === 'all' ? 'bg-brand-500/10 text-brand-300' : ''}">All Groups</div>`;
        
        groups.forEach(g => {
            html += `<div onclick="selectGroup('${g}')" class="px-3 py-2 hover:bg-white/5 cursor-pointer rounded-lg text-sm text-gray-300 transition-colors ${currentFilterGroup === g ? 'bg-brand-500/10 text-brand-300' : ''}">${g}</div>`;
        });
        els.groupOptionsList.innerHTML = html;
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
            document.getElementById('groupFilterDropdown').classList.remove('open');
        }
    });

    // --- CHANNEL LOGIC ---
    function saveToLocal() {
        localStorage.setItem('sleek_channels', JSON.stringify(channels));
        localStorage.setItem('sleek_favorites', JSON.stringify(favorites));
        updateGroupDropdown();
    }

    function handleChannelSubmit(e) {
        e.preventDefault();
        const formData = {
            id: document.getElementById('channelId').value || Date.now().toString(),
            name: document.getElementById('inpName').value,
            url: document.getElementById('inpUrl').value,
            group: document.getElementById('inpGroup').value || 'Uncategorized',
            logo: document.getElementById('inpLogo').value
        };

        const existingIndex = channels.findIndex(c => c.id === formData.id);
        if (existingIndex > -1) {
            channels[existingIndex] = formData;
            showToast(`Updated ${formData.name}`);
        } else {
            channels.push(formData);
            showToast(`Added ${formData.name}`);
        }

        saveToLocal();
        renderChannels();
        toggleModal('addChannelModal');
        
        if (currentChannelId === formData.id) loadChannel(formData.id);
    }

    function toggleFavorite(id, e) {
        if(e) e.stopPropagation();
        
        const isCurrentlyFav = favorites.includes(id);
        
        if(isCurrentlyFav) {
            favorites = favorites.filter(fid => fid !== id);
        } else {
            favorites.push(id);
        }
        
        saveToLocal();
        updateFavButtonState();

        if (showOnlyFavorites) {
            renderChannels();
        } else {
            const btn = e.currentTarget;
            if (btn) {
                btn.style.transform = 'scale(0.8)';
                setTimeout(() => btn.style.transform = 'scale(1)', 150);

                if (!isCurrentlyFav) {
                    btn.classList.remove('text-gray-600', 'opacity-0');
                    btn.classList.add('text-brand-400', 'opacity-100');
                    btn.innerHTML = `<i data-lucide="heart" class="w-4 h-4 fill-current animate-heart-beat"></i>`;
                } else {
                    btn.classList.remove('text-brand-400', 'opacity-100');
                    btn.classList.add('text-gray-600', 'opacity-0');
                    btn.innerHTML = `<i data-lucide="heart" class="w-4 h-4"></i>`;
                }
                lucide.createIcons();
            }
        }
    }

    function toggleCurrentFavorite() {
        if(currentChannelId) toggleFavorite(currentChannelId);
    }

    function filterFavorites() {
        showOnlyFavorites = !showOnlyFavorites;
        const btn = document.getElementById('favFilterBtn');
        if(showOnlyFavorites) {
            btn.classList.add('bg-brand-500', 'text-white', 'border-brand-500');
        } else {
            btn.classList.remove('bg-brand-500', 'text-white', 'border-brand-500');
        }
        renderChannels();
    }

    function renderChannels() {
        const query = els.searchInput.value.toLowerCase();
        
        const filtered = channels.filter(c => {
            const group = c.group || 'Uncategorized';
            const matchesSearch = c.name.toLowerCase().includes(query) || group.toLowerCase().includes(query);
            const matchesGroup = currentFilterGroup === 'all' || group === currentFilterGroup;
            const matchesFav = showOnlyFavorites ? favorites.includes(c.id) : true;
            return matchesSearch && matchesGroup && matchesFav;
        });

        els.channelCount.textContent = `${filtered.length} loaded`;

        els.channelList.innerHTML = filtered.map(c => {
            const isFav = favorites.includes(c.id);
            const isActive = currentChannelId === c.id;
            const group = c.group || 'Uncategorized';
            
            return `
            <div id="channel-item-${c.id}" onclick="loadChannel('${c.id}')" 
                 class="channel-item cursor-pointer p-3 rounded-xl border border-transparent group relative flex items-center gap-4 mb-1 ${isActive ? 'active' : 'hover:bg-dark-surface/60 hover:border-dark-light/50'}">
                
                <div class="active-indicator absolute left-0 top-3 bottom-3 w-1 bg-brand-500 rounded-r-full opacity-0 transition-all duration-300 scale-y-50 origin-left"></div>

                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-dark-light to-dark-border flex-shrink-0 flex items-center justify-center overflow-hidden border border-white/5 relative shadow-sm group-hover:shadow-md transition-all">
                    ${c.logo ? `<img src="${c.logo}" class="w-full h-full object-contain p-0.5" draggable="false" onerror="this.onerror=null; this.parentElement.innerHTML='<i data-lucide=\\'tv\\'></i>'; lucide.createIcons();">` : '<i data-lucide="tv" class="w-5 h-5 text-gray-500"></i>'}
                </div>
                
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <h4 class="text-sm font-medium transition-colors truncate ${isActive ? 'text-white font-bold' : 'text-gray-300 group-hover:text-white'}">${c.name}</h4>
                    <p class="text-[11px] truncate transition-colors ${isActive ? 'text-brand-300' : 'text-gray-500 group-hover:text-gray-400'}">${group}</p>
                </div>
                
                <button onclick="toggleFavorite('${c.id}', event)" class="p-2 hover:bg-white/10 rounded-full transition-all active:scale-90 ${isFav ? 'text-brand-400 opacity-100' : 'text-gray-600 opacity-0 group-hover:opacity-100'}">
                    <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i>
                </button>
            </div>
        `}).join('');

        if (filtered.length === 0) {
            els.channelList.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-4 text-gray-500">
                    <i data-lucide="search-x" class="w-10 h-10 mb-3 opacity-30"></i>
                    <p class="text-sm font-medium opacity-80">No channels found</p>
                    <p class="text-xs opacity-50 mt-1">Try adjusting your filters or search.</p>
                </div>
            `;
        }
        
        lucide.createIcons();
    }

    // --- PLAYER ENGINE ---
    const hlsConfig = {
        abrEwmaDefaultEstimate: 1000000,
        maxBufferLength: 15,
        maxMaxBufferLength: 30, 
        startFragPrefetch: true,
    };

    function loadChannel(id) {
        const channel = channels.find(c => c.id === id);
        if (!channel || (id === currentChannelId && hls)) return;

        if (window.innerWidth < 768 && isMobileSidebarOpen) {
            toggleSidebar();
        }

        // Surgically update active state instead of full re-render
        if (currentChannelId) {
            document.getElementById(`channel-item-${currentChannelId}`)?.classList.remove('active');
        }
        document.getElementById(`channel-item-${id}`)?.classList.add('active');

        currentChannelId = id;
        document.title = `SleekrStream  ${channel.name}`;
        
        document.getElementById('currentChannelName').textContent = channel.name;
        document.getElementById('currentChannelGroup').textContent = channel.group || 'Uncategorized';
        els.fullscreenChannelName.textContent = channel.name;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('shareBtn').disabled = false;
        els.startScreen.style.display = 'none';
        els.error.style.display = 'none';
        els.videoContainer.classList.add('player-active');
        
        const aspectMode = aspectModes[currentAspectIndex];
        if (aspectMode === 'contain') {
            els.videoContainer.classList.add('has-blurred-bg');
        } else {
            els.videoContainer.classList.remove('has-blurred-bg');
            stopBackgroundLoop();
        }

        els.loading.style.display = 'flex';
        els.loadingTitle.textContent = `Loading: ${channel.name}`;
        els.loadingStatus.textContent = "Initializing player...";
        
        const logoEl = document.getElementById('currentChannelLogo');
        const fullscreenLogoEl = els.fullscreenChannelLogo;
        const imgHtml = channel.logo 
            ? `<img src="${channel.logo}" class="w-full h-full object-contain p-0.5" draggable="false" onerror="this.onerror=null; this.parentElement.innerHTML='<i data-lucide=\\'tv\\'></i>'; lucide.createIcons();">`
            : `<i data-lucide="tv" class="w-6 h-6 opacity-80"></i>`;
        
        logoEl.innerHTML = imgHtml;
        fullscreenLogoEl.innerHTML = imgHtml;
        if (!channel.logo) lucide.createIcons();

        updateFavButtonState();

        if (hls) hls.destroy();

        if (Hls.isSupported()) {
            hls = new Hls(hlsConfig);
            
            hls.on(Hls.Events.MANIFEST_LOADING, () => {
                els.loadingStatus.textContent = "Connecting to stream...";
            });
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                els.loadingStatus.textContent = "Stream manifest loaded, preparing video...";
                video.play().catch(() => {});
                checkCaptions();
            });
            hls.on(Hls.Events.LEVEL_LOADED, () => {
                els.loadingStatus.textContent = "Video data received, starting playback...";
            });

            hls.loadSource(channel.url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    const failedChannelId = currentChannelId;
                    const failedChannelName = channel.name;
                    
                    switch (data.details) {
                        case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:
                        case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:
                            hls.destroy();
                            stopPlayer();
                            showConfirmation(
                                'Invalid Stream URL',
                                `The stream for "<strong>${failedChannelName}</strong>" failed to load. The URL appears to be invalid. Would you like to remove this channel?`,
                                () => {
                                    channels = channels.filter(c => c.id !== failedChannelId);
                                    favorites = favorites.filter(fid => fid !== failedChannelId);
                                    saveToLocal();
                                    renderChannels();
                                    showToast(`Removed broken channel: ${failedChannelName}`, 'error');
                                }
                            );
                            break;

                        case Hls.ErrorDetails.NETWORK_ERROR:
                            els.loading.style.display = 'flex';
                            els.loadingTitle.textContent = 'Reconnecting...';
                            els.loadingStatus.textContent = 'Network connection lost. Attempting to reconnect.';
                            updateNetworkHealth('poor');
                            hls.startLoad();
                            break;

                        case Hls.ErrorDetails.MEDIA_ERROR:
                            els.loading.style.display = 'flex';
                            els.loadingTitle.textContent = 'Recovering Stream...';
                            els.loadingStatus.textContent = 'A media error occurred. Attempting to recover.';
                            updateNetworkHealth('fair');
                            hls.recoverMediaError();
                            break;

                        default:
                            hls.destroy();
                            showError(`An unexpected error occurred. The stream for "${failedChannelName}" may be offline or incompatible.`);
                            break;
                    }
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = channel.url;
            video.addEventListener('error', () => showError("Native HLS playback is not supported for this stream."));
        }
    }

    function updateNetworkHealth(status) {
        const colors = { good: 'bg-green-500', fair: 'bg-yellow-500', poor: 'bg-red-500' };
        const texts = { good: 'Stable', fair: 'Unstable', poor: 'Poor' };
        
        els.networkDot.className = `w-1.5 h-1.5 rounded-full transition-colors ${colors[status] || 'bg-gray-600'}`;
        els.networkText.textContent = texts[status] || 'Offline';
    }

    function updateFavButtonState() {
        if(!currentChannelId) {
            els.favBtn.classList.add('hidden');
            return;
        }
        els.favBtn.classList.remove('hidden');
        const isFav = favorites.includes(currentChannelId);
        els.favBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-brand-400 text-brand-400' : 'text-gray-500'}"></i>`;
        lucide.createIcons();
    }

    // --- CONTROLS ---
    function toggleFullscreen() {
        const container = document.getElementById('videoContainer');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => console.error(err));
            document.getElementById('fsIcon').setAttribute('data-lucide', 'minimize');
        } else {
            document.exitFullscreen();
            document.getElementById('fsIcon').setAttribute('data-lucide', 'maximize');
        }
        setTimeout(lucide.createIcons, 100);
    }
    
    async function togglePiP() {
        try {
            if (video !== document.pictureInPictureElement) {
                await video.requestPictureInPicture();
            } else {
                await document.exitPictureInPicture();
            }
        } catch (error) {
            showToast("PiP is not available or supported.", "error");
        }
    }

    function togglePlay() {
        if(!currentChannelId) return;
        if (video.paused) {
            video.play();
            document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
        } else {
            video.pause();
            document.getElementById('playIcon').setAttribute('data-lucide', 'play');
        }
        lucide.createIcons();
    }

    function setVolume(val) {
        video.volume = val;
        video.muted = val == 0;
        const icon = val == 0 ? 'volume-x' : (val < 0.5 ? 'volume-1' : 'volume-2');
        document.getElementById('volIcon').setAttribute('data-lucide', icon);
        document.querySelector('input[type=range]').value = val;
        lucide.createIcons();
    }

    function toggleMute() {
        video.muted = !video.muted;
        let icon;
        if (video.muted) {
            icon = 'volume-x';
        } else {
            icon = video.volume < 0.5 ? 'volume-1' : 'volume-2';
        }
        document.getElementById('volIcon').setAttribute('data-lucide', icon);
        lucide.createIcons();
    }

    function toggleAspect() {
        currentAspectIndex = (currentAspectIndex + 1) % aspectModes.length;
        const mode = aspectModes[currentAspectIndex];
        video.style.objectFit = mode;
        showToast(`Aspect Ratio: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        
        if (mode === 'contain') {
            els.videoContainer.classList.add('has-blurred-bg');
            startBackgroundLoop();
        } else {
            els.videoContainer.classList.remove('has-blurred-bg');
            stopBackgroundLoop();
        }
    }

    function takeSnapshot() {
        if(video.videoWidth === 0 || !currentChannelId) {
             showToast("Cannot take snapshot, no video playing.", "error");
             return;
        }
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const link = document.createElement('a');
        const channel = channels.find(c => c.id === currentChannelId);
        const name = channel ? channel.name.replace(/ /g, '_') : 'stream';
        link.download = `snapshot_${name}_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showToast("Snapshot saved");
    }

    // --- CAPTIONS ---
    function checkCaptions() {
        const hasSubs = video.textTracks.length > 0 || (hls && hls.subtitleTracks.length > 0);
        document.getElementById('ccBtn').disabled = !hasSubs;
        document.getElementById('mobileCcBtn').disabled = !hasSubs;
    }

    function toggleCaptions() {
        isCaptionsOn = !isCaptionsOn;
        const badge = document.getElementById('ccBadge');
        const btn = document.getElementById('ccBtn');

        badge.classList.toggle('hidden', !isCaptionsOn);
        btn.classList.toggle('text-brand-400', isCaptionsOn);
        
        // Mobile menu sync
        document.getElementById('mobileCcBtn').classList.toggle('text-brand-400', isCaptionsOn);
        
        showToast(`Captions ${isCaptionsOn ? 'ON' : 'OFF'}`);

        for (let i = 0; i < video.textTracks.length; i++) {
             video.textTracks[i].mode = isCaptionsOn ? 'showing' : 'hidden';
        }
        if(hls) {
             hls.subtitleDisplay = isCaptionsOn;
             if (isCaptionsOn && hls.subtitleTrack === -1) hls.subtitleTrack = 0;
        }
    }

    // --- STATS & EVENTS ---
    function toggleStats() {
        els.stats.overlay.classList.toggle('hidden');
    }

    function setupPlayerEvents() {
        let bufferTimeout;
        video.addEventListener('waiting', () => {
            bufferTimeout = setTimeout(() => {
                els.loading.style.display = 'flex';
                els.loadingTitle.textContent = "Buffering...";
                els.loadingStatus.textContent = "The stream is buffering due to a slow or unstable connection.";
                updateNetworkHealth('fair');
            }, 1000);
        });
        video.addEventListener('playing', () => {
            clearTimeout(bufferTimeout);
            els.loading.style.display = 'none';
            updateNetworkHealth('good');
            document.getElementById('liveBadge').classList.remove('hidden');
            document.getElementById('liveBadge').classList.add('flex');
            document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
            if (aspectModes[currentAspectIndex] === 'contain') {
                startBackgroundLoop();
            }
            lucide.createIcons();
        });
        video.addEventListener('loadedmetadata', () => {
            els.loading.style.display = 'none';
        });
    }

    function updateStats() {
        if (els.stats.overlay.classList.contains('hidden')) return;
        
        if (hls && hls.levels && hls.levels[hls.currentLevel]) {
            const level = hls.levels[hls.currentLevel];
            els.stats.res.textContent = `${level.width}x${level.height}`;
            els.stats.bitrate.textContent = `${(level.bitrate / 1000).toFixed(0)} kbps`;
            els.stats.engine.textContent = "HLS.js (MSE)";
        } else {
             els.stats.res.textContent = `${video.videoWidth}x${video.videoHeight}`;
             els.stats.engine.textContent = "Native";
        }

        if(video.buffered.length) {
            const bufLen = video.buffered.end(video.buffered.length -1) - video.currentTime;
            els.stats.buffer.textContent = `${bufLen.toFixed(2)} sec`;
        }
        
        els.stats.dropped.textContent = video.webkitDroppedFrameCount || video.mozDecodedFrames - video.mozPaintedFrames || 0;
        if(hls && hls.bandwidthEstimate) els.stats.bw.textContent = (hls.bandwidthEstimate / 1000000).toFixed(2) + " Mbps";
        
        const current = channels.find(c => c.id === currentChannelId);
        if(current) els.stats.url.textContent = current.url;
    }

    setInterval(updateStats, 1000);

    // --- HELPERS ---
    function toggleModal(id) {
        const m = document.getElementById(id);
        if (m.classList.contains('hidden')) {
            if(id === 'addChannelModal' && !m.dataset.editing) {
                document.getElementById('channelForm').reset();
                document.getElementById('channelId').value = '';
                document.getElementById('modalTitle').textContent = 'Add Stream';
                document.getElementById('deleteBtnContainer').classList.add('hidden');
                els.urlValidationStatus.textContent = '';
                updateLogoPreview();
            }
            delete m.dataset.editing;
            m.classList.remove('hidden');
        } else {
            m.classList.add('hidden');
        }
    }

    function showConfirmation(title, message, onConfirm) {
        els.confirm.title.textContent = title;
        els.confirm.message.innerHTML = message;
        
        const newOkBtn = els.confirm.okBtn.cloneNode(true);
        els.confirm.okBtn.parentNode.replaceChild(newOkBtn, els.confirm.okBtn);
        els.confirm.okBtn = newOkBtn;

        const newCancelBtn = els.confirm.cancelBtn.cloneNode(true);
        els.confirm.cancelBtn.parentNode.replaceChild(newCancelBtn, els.confirm.cancelBtn);
        els.confirm.cancelBtn = newCancelBtn;

        els.confirm.okBtn.addEventListener('click', () => {
            onConfirm();
            els.confirm.modal.classList.add('hidden');
        });

        els.confirm.cancelBtn.addEventListener('click', () => {
            els.confirm.modal.classList.add('hidden');
        });

        els.confirm.modal.classList.remove('hidden');
    }

    function editCurrentChannel() {
         if(currentChannelId) editChannel(currentChannelId);
    }

    function editChannel(id) {
        const channel = channels.find(c => c.id === id);
        if(!channel) return;
        
        const m = document.getElementById('addChannelModal');
        m.dataset.editing = "true";
        document.getElementById('channelId').value = channel.id;
        document.getElementById('inpName').value = channel.name;
        document.getElementById('inpUrl').value = channel.url;
        document.getElementById('inpGroup').value = channel.group || '';
        document.getElementById('inpLogo').value = channel.logo || '';
        document.getElementById('modalTitle').textContent = 'Edit Config';
        document.getElementById('deleteBtnContainer').classList.remove('hidden');
        els.urlValidationStatus.textContent = '';
        toggleModal('addChannelModal');
        updateLogoPreview();
    }

    function deleteChannel() {
        const channelId = document.getElementById('channelId').value;
        const channel = channels.find(c => c.id === channelId);
        
        showConfirmation(
            'Delete Channel?',
            `Are you sure you want to permanently remove <strong>${channel.name}</strong>?`,
            () => {
                channels = channels.filter(c => c.id !== channelId);
                favorites = favorites.filter(id => id !== channelId);
                
                saveToLocal();
                renderChannels();
                toggleModal('addChannelModal');
                
                if(currentChannelId === channelId) stopPlayer();
                showToast("Channel removed", "error");
            }
        );
    }
    
    function stopPlayer() {
         if(hls) {
             hls.destroy();
             hls = null;
         }
         video.src = "";
         els.startScreen.style.display = 'flex';
         els.videoContainer.classList.remove('player-active');
         els.videoContainer.classList.remove('has-blurred-bg');
         stopBackgroundLoop();
         els.controlsOverlay.classList.add('ui-hidden');
         els.error.style.display = 'none';
         els.loading.style.display = 'none';
         if(currentChannelId) {
             document.getElementById(`channel-item-${currentChannelId}`)?.classList.remove('active');
         }
         currentChannelId = null;
         document.title = 'SleekrStream';
         document.getElementById('currentChannelName').textContent = "Select Channel";
         document.getElementById('currentChannelGroup').textContent = "--";
         document.getElementById('editBtn').disabled = true;
         document.getElementById('shareBtn').disabled = true;
         document.getElementById('liveBadge').classList.add('hidden');
         updateNetworkHealth('idle');
         updateFavButtonState();
         closeMobileMenu();
    }

    function retryStream() {
        els.error.style.display = 'none';
        if(currentChannelId) loadChannel(currentChannelId);
    }

    function showError(msg) {
        els.loading.style.display = 'none';
        els.error.style.display = 'flex';
        els.errorMessage.textContent = msg;
        updateNetworkHealth('poor');
    }

    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        const iconContainer = document.getElementById('toastIcon');
        const icon = type === 'success' ? 'check' : 'x';
        const color = type === 'success' ? 'brand' : 'red';

        document.getElementById('toastMsg').textContent = msg;
        iconContainer.innerHTML = `<i data-lucide="${icon}" class="text-${color}-400 w-5 h-5"></i>`;
        iconContainer.className = `bg-${color}-500/20 p-2 rounded-full`;
        lucide.createIcons();
        
        t.classList.remove('translate-y-32', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
    }
    
    function importExampleChannels() {
        const examples = [
            { id: "nickelodeon", name: "Nickelodeon", url: "https://fl1.moveonjoy.com/NICKELODEON/index.m3u8", group: "Kids", logo: "https://i.imgur.com/E84jnP8.png" },
            { id: "campsnoopy", name: "Camp Snoopy", url: "https://stream.ads.ottera.tv/playlist.m3u8?network_id=269", group: "Kids", logo: "https://i.imgur.com/8PUbPVU.png" },
            { id: "history", name: "History", url: "https://fl1.moveonjoy.com/history_channel/index.m3u8", group: "Documentary", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/History_%282021%29.svg/512px-History_%282021%29.svg.png" },
            { id: "gameshownetwork", name: "Game Show Network", url: "https://a-cdn.klowdtv.com/live2/gsn_720p/playlist.m3u8", group: "Kids", logo: "https://www.gameshownetwork.com/storage/app/media/2020/Navigation/gsn_logo.jpg" },
            { id: "disneychannel", name: "Disney Channel", url: "https://fl31.moveonjoy.com/DISNEY/index.m3u8", group: "Kids", logo: "https://upload.wikimedia.org/wikipedia/commons/3/3d/2022_Disney_Channel_logo.svg" },
            { id: "cbs", name: "CBS", url: "https://fl1.moveonjoy.com/CBS_News/index.m3u8", group: "General", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/CBS_logo_%282020%29.svg/512px-CBS_logo_%282020%29.svg.png" },
            { id: "e!", name: "E! Entertainment", url: "https://fl1.moveonjoy.com/E_ENTERTAINMENT_TELEVISION/index.m3u8", group: "Entertainment", logo: "https://i.imgur.com/TWFDkap.png" },
            { id: "babyshark", name: "Baby Shark", url: "https://newidco-babysharktv-1-eu.rakuten.wurl.tv/playlist.m3u8", group: "Kids", logo: "https://i.imgur.com/SbBKr8L.png" },
            { id: "disneyxd", name: "Disney XD", url: "http://fl1.moveonjoy.com/DISNEY_XD/index.m3u8", group: "Kids", logo: "https://upload.wikimedia.org/wikipedia/commons/a/a8/2015_Disney_XD_logo.svg" },
            { id: "comet", name: "Comet", url: "https://fast-channels.sinclairstoryline.com/COMET/index.m3u8", group: "Sci-Fi", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Comet_logo.svg/512px-Comet_logo.svg.png" }
        ];
        
        let count = 0;
        examples.forEach(ex => {
            if(!channels.some(c => c.url === ex.url)) {
                channels.push({...ex, id: Date.now() + Math.random().toString()});
                count++;
            }
        });
        saveToLocal();
        renderChannels();
        showToast(`Loaded ${count} demo channels`);
    }

    // --- CHANNEL SHARING ---
    async function shareCurrentChannel() {
        if (!currentChannelId) return;
        const channel = channels.find(c => c.id === currentChannelId);
        if (!channel) return;

        const shareableChannel = {
            name: channel.name,
            url: channel.url,
            group: channel.group,
            logo: channel.logo
        };

        try {
            const jsonString = JSON.stringify(shareableChannel);
            const base64Data = btoa(jsonString);
            const shareUrl = `${window.location.origin}${window.location.pathname}#share=${base64Data}`;

            if (navigator.share) {
                await navigator.share({
                    title: `Watch ${channel.name} on SleekrStream`,
                    text: `Check out this stream: ${channel.name}`,
                    url: shareUrl
                });
            } else {
                await navigator.clipboard.writeText(shareUrl);
                showToast("Share link copied to clipboard!");
            }
        } catch (err) {
            console.error("Sharing failed:", err);
            showToast("Could not generate share link.", "error");
        }
    }

    function handleIncomingShareLink() {
        if (window.location.hash.startsWith('#share=')) {
            const base64Data = window.location.hash.substring(7);
            try {
                const jsonString = atob(base64Data);
                const channelData = JSON.parse(jsonString);

                if (channelData && channelData.name && channelData.url) {
                    showShareConfirmation(channelData);
                } else {
                    showToast("Invalid share link data.", "error");
                }
            } catch (e) {
                console.error("Error parsing share link:", e);
                showToast("Could not read the share link.", "error");
            } finally {
                history.replaceState(null, document.title, window.location.pathname + window.location.search);
            }
        }
    }

    function showShareConfirmation(channelData) {
        sharedChannelData = channelData;
        const modal = document.getElementById('shareConfirmModal');
        
        document.getElementById('shareName').textContent = channelData.name || 'Unknown Channel';
        document.getElementById('shareGroup').textContent = channelData.group || 'Uncategorized';
        document.getElementById('shareUrl').textContent = channelData.url || 'No URL provided';
        
        const logoContainer = document.getElementById('shareLogo');
        if (channelData.logo) {
            logoContainer.innerHTML = `<img src="${channelData.logo}" class="w-full h-full object-contain p-1" draggable="false">`;
        } else {
            logoContainer.innerHTML = `<i data-lucide="tv" class="w-8 h-8 text-gray-500"></i>`;
            lucide.createIcons();
        }

        document.getElementById('addSharedBtn').onclick = addSharedChannel;
        modal.classList.remove('hidden');
    }

    function closeShareConfirm() {
        document.getElementById('shareConfirmModal').classList.add('hidden');
        sharedChannelData = null;
    }

    function addSharedChannel() {
        if (!sharedChannelData) return;

        if (channels.some(c => c.url === sharedChannelData.url)) {
            showToast(`${sharedChannelData.name} is already in your list.`, 'error');
            closeShareConfirm();
            return;
        }

        const newChannel = {
            id: Date.now().toString(),
            name: sharedChannelData.name,
            url: sharedChannelData.url,
            group: sharedChannelData.group || 'Uncategorized',
            logo: sharedChannelData.logo || ''
        };

        channels.push(newChannel);
        saveToLocal();
        renderChannels();
        showToast(`Added "${newChannel.name}" to your list!`);
        closeShareConfirm();
    }
</script>
</body>
</html>
